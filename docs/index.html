<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/Blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/Blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/Blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/Blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/Blog/css/main.css">


<link rel="stylesheet" href="/Blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ezharjan.github.io","root":"/Blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
<meta property="og:type" content="website">
<meta property="og:title">
<meta property="og:url" content="https://ezharjan.github.io/Blog/index.html">
<meta property="og:site_name">
<meta property="og:description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Alexander Ezharjan">
<meta property="article:tag" content="Software, Lab, Engineer, Game Engine, Alexander, Ezharjan">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ezharjan.github.io/Blog/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title></title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/Blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title"></h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Blog By Alexander</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/Blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/Blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ezharjan.github.io/Blog/2022/03/18/CG-In-Practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/Blog/images/avatar.gif">
      <meta itemprop="name" content="Alexander Ezharjan">
      <meta itemprop="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Blog/2022/03/18/CG-In-Practice/" class="post-title-link" itemprop="url">CG In Practice</a>
        </h2>

        <div class="post-meta">

          
          <i class="fa fa-thumb-tack"></i>
          <font color=7D26CD>置顶</font>
          <span class="post-meta-divider">|</span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-18 23:49:16" itemprop="dateCreated datePublished" datetime="2022-03-18T23:49:16+08:00">2022-03-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-06 21:13:07" itemprop="dateModified" datetime="2024-04-06T21:13:07+08:00">2024-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Blog/categories/Computer-Graphics/" itemprop="url" rel="index"><span itemprop="name">Computer Graphics</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- <h1 align="center">Computer Graphics In Practice<h1>  -->
<h6 align="center">Alexander Ezharjan<h6>


<br>
<br>



<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This reference book is mainly to discuss the detailed knowledge of basic computer graphics based on the soft renderer project called <em>Render Engine</em>, which is a tiny graphical rendering engine developed via pure C++ without any third-party-libraries included.</p>
<br>

<p>The content of this book is separated into many parts so that we are able to to have a deeper view into each section.</p>
<p>The first section is this Introduction it self.</p>
<p>The second section is to discuss the mathematical basis for computer graphics. The advanced part as well as those part that have tight relation with the physics is not included, as we are just learning the basic knowledge of computer graphics, not the advanced ones.</p>
<p>The third section is to discuss the inside of render pipeline, which is a significant aspect in the study of computer graphics.</p>
<p>The forth section is to discuss the basic unit used in render engine — Vertex. A vertex stores lots of information including position, tex-coord, normal etc,.</p>
<br>

<br>


<p>In order to relate the CG knowledge into the application, we have to apply the theory into reality by programing, With this notes, however, the co-related project demands the basics for C++ programming. But if you take a look at the project code, you will notice that the application of the programming language is really in basic way, as too many properties of C++ is not utilized at all. Only some of the basic data structures and methods of the STL is used to make the code more accessible as well as to facilitate the project. Note that any other programing languages are OK to apply the theory I clarified in this book.</p>
<hr>
<br>
<br>
<br>
<br>
<br>



<h2 id="Math-Basis"><a href="#Math-Basis" class="headerlink" title="Math Basis"></a>Math Basis</h2><p>Math is needed as the basic tool for every field of science. As the base of the computer science, I myself also regard it as the base of computer graphics, for many algorithms can not escape from the use of math. I separated it as a single chapter so as to mention its importance as well as to show you the utility of math in computer graphics.</p>
<p>In math, we have vectors, matrices, coordinates and more. These are all used in computer graphics. If you have ever used OpenGL or any other libraries, you’ll notice that the math is actually provided as basic APIs and using them is quite simple. But if you are writing the CPU based renderer like I have done in this project, you ought to know the inner activities that these APIs are conducting. Here I am going to show you some of the APIs that I wrote:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="type">float</span> <span class="title">RadToDegree</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; rad)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (rad * <span class="number">180.f</span> / MATH_PI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">DegreeToRad</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; degree)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (degree * MATH_PI / <span class="number">180.f</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">LinearInerpolate</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; x1, <span class="type">const</span> <span class="type">float</span>&amp; x2, <span class="type">const</span> <span class="type">float</span>&amp; t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> x1 + (x2 - x1) * t; <span class="comment">// formula of linear interpolation</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">Lerp</span><span class="params">(<span class="type">const</span> <span class="type">float</span> a, <span class="type">const</span> <span class="type">float</span> b, <span class="type">const</span> <span class="type">float</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (t &lt;= <span class="number">0.f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> a;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (t &gt;= <span class="number">1.f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> b;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> b * t + (<span class="number">1.f</span> - t) * a;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Vector4 <span class="title">Lerp</span><span class="params">(<span class="type">const</span> Vector4&amp; a, <span class="type">const</span> Vector4&amp; b, <span class="type">float</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">Vector4 <span class="title">result</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		Lerp(a.getX(), b.getX(), t),</span></span></span><br><span class="line"><span class="params"><span class="function">		Lerp(a.getY(), b.getY(), t),</span></span></span><br><span class="line"><span class="params"><span class="function">		Lerp(a.getZ(), b.getZ(), t),</span></span></span><br><span class="line"><span class="params"><span class="function">		Lerp(a.getW(), b.getW(), t)</span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Colour <span class="title">Lerp</span><span class="params">(<span class="type">const</span> Colour&amp; a, <span class="type">const</span> Colour&amp; b, <span class="type">float</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Colour result;</span><br><span class="line">	result.r = <span class="built_in">Lerp</span>(a.r, b.r, t);</span><br><span class="line">	result.g = <span class="built_in">Lerp</span>(a.g, b.g, t);</span><br><span class="line">	result.b = <span class="built_in">Lerp</span>(a.b, b.b, t);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">Clamp</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; param, <span class="type">const</span> <span class="type">float</span>&amp; min, <span class="type">const</span> <span class="type">float</span>&amp; max)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (param &lt;= min)</span><br><span class="line">		<span class="keyword">return</span> min;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (param &gt;= max)</span><br><span class="line">		<span class="keyword">return</span> max;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> param;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// optimized way below</span></span><br><span class="line">	<span class="comment">//return ((param &lt; min) ? min : ((param &gt; max) ? max : param));</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CLAMP</span><span class="params">(<span class="type">float</span>&amp; param, <span class="type">const</span> <span class="type">float</span>&amp; min, <span class="type">const</span> <span class="type">float</span>&amp; max)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (param &lt;= min)</span><br><span class="line">		param = min;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (param &gt;= max)</span><br><span class="line">		param = max;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ColorInterpolation</span><span class="params">(Vertex &amp; s1, Vertex &amp; s3, Vertex &amp; s4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	s4.color.r = (s4.pos.<span class="built_in">getY</span>() - s1.pos.<span class="built_in">getY</span>()) *(s3.color.r - s1.color.r) / (s3.pos.<span class="built_in">getY</span>() - s1.pos.<span class="built_in">getY</span>()) + s1.color.r;</span><br><span class="line">	s4.color.g = (s4.pos.<span class="built_in">getY</span>() - s1.pos.<span class="built_in">getY</span>()) *(s3.color.g - s1.color.g) / (s3.pos.<span class="built_in">getY</span>() - s1.pos.<span class="built_in">getY</span>()) + s1.color.g;</span><br><span class="line">	s4.color.b = (s4.pos.<span class="built_in">getY</span>() - s1.pos.<span class="built_in">getY</span>()) *(s3.color.b - s1.color.b) / (s3.pos.<span class="built_in">getY</span>() - s1.pos.<span class="built_in">getY</span>()) + s1.color.b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isPrimeNumber</span><span class="params">(<span class="type">const</span> <span class="type">int</span>&amp; num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">2</span>; i &lt; num; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (num % i == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">StringToNum</span><span class="params">(<span class="type">const</span> std::string &amp; str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">std::istringstream <span class="title">iss</span><span class="params">(str)</span></span>;</span><br><span class="line">	<span class="type">int</span> num;</span><br><span class="line">	iss &gt;&gt; num;</span><br><span class="line">	<span class="keyword">return</span> (<span class="type">float</span>)num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CharToNum</span><span class="params">(<span class="type">const</span> <span class="type">char</span>&amp; c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">atoi</span>(&amp;c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">Sigmoid</span><span class="params">(<span class="type">const</span> <span class="type">float</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="number">1</span> / <span class="number">1</span> + <span class="built_in">exp</span>(-x));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">char</span> <span class="title">FloatToByte</span><span class="params">(<span class="type">const</span> <span class="type">float</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">unsigned</span> <span class="built_in">char</span>((<span class="type">int</span>)(x * <span class="number">255.f</span>) % <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">MapTo0_255f</span><span class="params">(<span class="type">const</span> <span class="type">float</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> result = <span class="built_in">Clamp</span>(x, <span class="number">0.f</span>, <span class="number">0.999999f</span>) * <span class="number">255.f</span>; <span class="comment">// never dropping value ranging 0~1</span></span><br><span class="line">	<span class="keyword">if</span> (result - EPSILON &gt;= <span class="number">1.f</span>)</span><br><span class="line">		result = <span class="built_in">floorf</span>(<span class="built_in">Clamp</span>(x, <span class="number">0.f</span>, <span class="number">0.999999f</span>) * <span class="number">256.f</span>);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">GetGrayScaleViaGamaCorrection</span><span class="params">(<span class="type">const</span> Colour&amp; valueToBeCorrected)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> numerator = <span class="built_in">powf</span>(<span class="built_in">MapTo0_255f</span>(valueToBeCorrected.r), <span class="number">2.2f</span>) + <span class="built_in">powf</span>((<span class="number">1.5f</span>*<span class="built_in">MapTo0_255f</span>(valueToBeCorrected.g)), <span class="number">2.2f</span>) + <span class="built_in">powf</span>((<span class="number">0.6f</span>*<span class="built_in">MapTo0_255f</span>(valueToBeCorrected.b)), <span class="number">2.2f</span>);</span><br><span class="line">	<span class="type">float</span> denominator = <span class="number">1.f</span> + <span class="built_in">powf</span>(<span class="number">1.5f</span>, <span class="number">2.2f</span>) + <span class="built_in">powf</span>(<span class="number">0.6f</span>, <span class="number">2.2f</span>);</span><br><span class="line">	<span class="type">float</span> result = <span class="built_in">powf</span>((numerator / denominator), <span class="number">1.f</span> / <span class="number">2.2f</span>);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Colour <span class="title">GetGrayScaleViaGamaCorrection</span><span class="params">(<span class="type">const</span> <span class="type">float</span> sameRGBValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> numerator = <span class="built_in">powf</span>(<span class="built_in">MapTo0_255f</span>(sameRGBValue), <span class="number">2.2f</span>) + <span class="built_in">powf</span>((<span class="number">1.5f</span>*<span class="built_in">MapTo0_255f</span>(sameRGBValue)), <span class="number">2.2f</span>) + <span class="built_in">powf</span>((<span class="number">0.6f</span>*<span class="built_in">MapTo0_255f</span>(sameRGBValue)), <span class="number">2.2f</span>);</span><br><span class="line">	<span class="type">float</span> denominator = <span class="number">1.f</span> + <span class="built_in">powf</span>(<span class="number">1.5f</span>, <span class="number">2.2f</span>) + <span class="built_in">powf</span>(<span class="number">0.6f</span>, <span class="number">2.2f</span>);</span><br><span class="line">	<span class="type">float</span> result = <span class="built_in">powf</span>((numerator / denominator), <span class="number">1.f</span> / <span class="number">2.2f</span>);</span><br><span class="line">	<span class="keyword">return</span>  <span class="built_in">Colour</span>(result, result, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">GetBrightnessViaGamaCorrection</span><span class="params">(<span class="type">const</span> Colour &amp; valueToBeCorrected)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> numerator = <span class="built_in">powf</span>(valueToBeCorrected.r, <span class="number">2.2f</span>) + <span class="built_in">powf</span>((<span class="number">1.5f</span>*valueToBeCorrected.g), <span class="number">2.2f</span>) + <span class="built_in">powf</span>((<span class="number">0.6f</span>*valueToBeCorrected.b), <span class="number">2.2f</span>);</span><br><span class="line">	<span class="type">float</span> denominator = <span class="number">1.f</span> + <span class="built_in">powf</span>(<span class="number">1.5f</span>, <span class="number">2.2f</span>) + <span class="built_in">powf</span>(<span class="number">0.6f</span>, <span class="number">2.2f</span>);</span><br><span class="line">	<span class="type">float</span> result = <span class="built_in">powf</span>((numerator / denominator), <span class="number">1.f</span> / <span class="number">2.2f</span>);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Colour <span class="title">GetBrightnessViaGamaCorrection</span><span class="params">(<span class="type">const</span> <span class="type">float</span> sameRGBValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> numerator = <span class="built_in">powf</span>(sameRGBValue, <span class="number">2.2f</span>) + <span class="built_in">powf</span>((<span class="number">1.5f</span>*sameRGBValue), <span class="number">2.2f</span>) + <span class="built_in">powf</span>((<span class="number">0.6f</span>*sameRGBValue), <span class="number">2.2f</span>);</span><br><span class="line">	<span class="type">float</span> denominator = <span class="number">1.f</span> + <span class="built_in">powf</span>(<span class="number">1.5f</span>, <span class="number">2.2f</span>) + <span class="built_in">powf</span>(<span class="number">0.6f</span>, <span class="number">2.2f</span>);</span><br><span class="line">	<span class="type">float</span> result = <span class="built_in">powf</span>((numerator / denominator), <span class="number">1.f</span> / <span class="number">2.2f</span>);</span><br><span class="line">	<span class="keyword">return</span>  <span class="built_in">Colour</span>(result, result, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">Vector4 <span class="title">Vector4DotMatrix4f</span><span class="params">(<span class="type">const</span> Vector4 &amp; vec4, <span class="type">const</span> Matrix4f &amp; m4f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Vector4 result;</span><br><span class="line">	result.<span class="built_in">setX</span>(vec4.<span class="built_in">getX</span>() * m4f.matrix[<span class="number">0</span>][<span class="number">0</span>] + vec4.<span class="built_in">getY</span>() * m4f.matrix[<span class="number">1</span>][<span class="number">0</span>] + vec4.<span class="built_in">getZ</span>() * m4f.matrix[<span class="number">2</span>][<span class="number">0</span>] + vec4.<span class="built_in">getW</span>() * m4f.matrix[<span class="number">3</span>][<span class="number">0</span>]);</span><br><span class="line">	result.<span class="built_in">setY</span>(vec4.<span class="built_in">getX</span>() * m4f.matrix[<span class="number">0</span>][<span class="number">1</span>] + vec4.<span class="built_in">getY</span>() * m4f.matrix[<span class="number">1</span>][<span class="number">1</span>] + vec4.<span class="built_in">getZ</span>() * m4f.matrix[<span class="number">2</span>][<span class="number">1</span>] + vec4.<span class="built_in">getW</span>() * m4f.matrix[<span class="number">3</span>][<span class="number">1</span>]);</span><br><span class="line">	result.<span class="built_in">setZ</span>(vec4.<span class="built_in">getX</span>() * m4f.matrix[<span class="number">0</span>][<span class="number">2</span>] + vec4.<span class="built_in">getY</span>() * m4f.matrix[<span class="number">1</span>][<span class="number">2</span>] + vec4.<span class="built_in">getZ</span>() * m4f.matrix[<span class="number">2</span>][<span class="number">2</span>] + vec4.<span class="built_in">getW</span>() * m4f.matrix[<span class="number">3</span>][<span class="number">2</span>]);</span><br><span class="line">	result.<span class="built_in">setW</span>(vec4.<span class="built_in">getX</span>() * m4f.matrix[<span class="number">0</span>][<span class="number">3</span>] + vec4.<span class="built_in">getY</span>() * m4f.matrix[<span class="number">1</span>][<span class="number">3</span>] + vec4.<span class="built_in">getZ</span>() * m4f.matrix[<span class="number">2</span>][<span class="number">3</span>] + vec4.<span class="built_in">getW</span>() * m4f.matrix[<span class="number">3</span>][<span class="number">3</span>]);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<br>

<p>Actually, some of the APIs can be directly gain from STL or ‘math.h’ while you’re using C++, such as the function ‘RadToDegree’ above can also be found in Lua’s inner math library, but writing them done is a way to apply what you have learnt into practice. Hope you can directly use the ones that the inner libraries provide rather than writing them by yourself so as to avoid mistakes and prevent the performance of your application from being lowered.</p>
<p>Here are some of the APIs when defining <code>Vectors</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/* Vector2                                                              */</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="type">void</span> Vector2::<span class="keyword">operator</span>=(<span class="type">const</span> Vector2 &amp; right)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;<span class="built_in">setX</span>(right.<span class="built_in">getX</span>());</span><br><span class="line">	<span class="keyword">this</span>-&gt;<span class="built_in">setY</span>(right.<span class="built_in">getY</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector2 Vector2::<span class="keyword">operator</span>+(<span class="type">const</span> Vector2&amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector2 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX() + right.getX(), <span class="keyword">this</span>-&gt;getY() + right.getY())</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector2 Vector2::<span class="keyword">operator</span>-(<span class="type">const</span> Vector2&amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector2 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX() - right.getX(), <span class="keyword">this</span>-&gt;getY() - right.getY())</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">Vector2 Vector2::<span class="keyword">operator</span>*(<span class="type">const</span> T&amp; k) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector2 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX() * k, <span class="keyword">this</span>-&gt;getY() * k)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector2 Vector2::<span class="keyword">operator</span> /(<span class="type">const</span> <span class="type">float</span>&amp; k) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (k == <span class="number">0.f</span> || <span class="built_in">abs</span>(k - <span class="number">0.f</span>) &lt; EPSILON) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">Vector2</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">float</span> reciprocalK = <span class="number">1</span> / k;</span><br><span class="line">	<span class="function">Vector2 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX()*reciprocalK, <span class="keyword">this</span>-&gt;getY()*reciprocalK)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> Vector2::<span class="keyword">operator</span>*(<span class="type">const</span> Vector2&amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() * right.<span class="built_in">getX</span>() + <span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() * right.<span class="built_in">getY</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Vector2::swap</span><span class="params">(Vector2 &amp; vecA, Vector2 &amp; vecB)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (vecA == vecB)<span class="keyword">return</span>;</span><br><span class="line">	<span class="function">Vector2 <span class="title">tmp</span><span class="params">(vecA.getX(), vecA.getY())</span></span>;</span><br><span class="line">	vecA = vecB;</span><br><span class="line">	vecB = tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">Vector2::getLength</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">sqrtf</span>(<span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>(), <span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/* Vector3                                                              */</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="type">bool</span> Vector3::<span class="keyword">operator</span>==(<span class="type">const</span> <span class="type">float</span> right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">bool</span> xIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() - right) &lt;= EPSILON;</span><br><span class="line">	<span class="type">bool</span> yIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() - right) &lt;= EPSILON;</span><br><span class="line">	<span class="type">bool</span> zIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>() - right) &lt;= EPSILON;</span><br><span class="line">	<span class="keyword">return</span> (xIsEqual &amp;&amp; yIsEqual &amp;&amp; zIsEqual);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Vector3::<span class="keyword">operator</span>==(<span class="type">const</span> Vector3 &amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">bool</span> xIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() - right.<span class="built_in">getX</span>()) &lt;= EPSILON;</span><br><span class="line">	<span class="type">bool</span> yIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() - right.<span class="built_in">getY</span>()) &lt;= EPSILON;</span><br><span class="line">	<span class="type">bool</span> zIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>() - right.<span class="built_in">getZ</span>()) &lt;= EPSILON;</span><br><span class="line">	<span class="keyword">return</span> (xIsEqual &amp;&amp; yIsEqual &amp;&amp; zIsEqual);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector3 Vector3::<span class="keyword">operator</span>+(<span class="type">const</span> Vector3 &amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector3 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX() + right.getX(), <span class="keyword">this</span>-&gt;getY() + right.getY(), <span class="keyword">this</span>-&gt;getZ() + right.getZ())</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector3 Vector3::<span class="keyword">operator</span>-(<span class="type">const</span> Vector3 &amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector3 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX() - right.getX(), <span class="keyword">this</span>-&gt;getY() - right.getY(), <span class="keyword">this</span>-&gt;getZ() - right.getZ())</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector3 Vector3::<span class="keyword">operator</span>*(<span class="type">const</span> <span class="type">float</span> k) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector3 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX() * k, <span class="keyword">this</span>-&gt;getY() * k, <span class="keyword">this</span>-&gt;getZ() * k)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> Vector3::<span class="keyword">operator</span>*(<span class="type">const</span> Vector3 &amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>()*right.<span class="built_in">getX</span>() + <span class="keyword">this</span>-&gt;<span class="built_in">getY</span>()*right.<span class="built_in">getY</span>() + <span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>()*right.<span class="built_in">getZ</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">Vector3 Vector3::<span class="keyword">operator</span>*(<span class="type">const</span> T&amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector3 <span class="title">result</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">this</span>-&gt;getX()*right.matrix[<span class="number">0</span>][<span class="number">0</span>] + <span class="keyword">this</span>-&gt;getY()*right.matrix[<span class="number">0</span>][<span class="number">1</span>] + <span class="keyword">this</span>-&gt;getZ() * right.matrix[<span class="number">0</span>][<span class="number">2</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">this</span>-&gt;getY()*right.matrix[<span class="number">1</span>][<span class="number">0</span>] + <span class="keyword">this</span>-&gt;getY()*right.matrix[<span class="number">1</span>][<span class="number">1</span>] + <span class="keyword">this</span>-&gt;getZ() * right.matrix[<span class="number">1</span>][<span class="number">2</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">this</span>-&gt;getZ()*right.matrix[<span class="number">2</span>][<span class="number">0</span>] + <span class="keyword">this</span>-&gt;getY()*right.matrix[<span class="number">2</span>][<span class="number">1</span>] + <span class="keyword">this</span>-&gt;getZ() * right.matrix[<span class="number">2</span>][<span class="number">2</span>])</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector3 Vector3::<span class="keyword">operator</span>^(<span class="type">const</span> Vector3 &amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	Vector3 result;</span><br><span class="line">	result.<span class="built_in">setX</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() * right.<span class="built_in">getZ</span>() - <span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>() * right.<span class="built_in">getY</span>());</span><br><span class="line">	result.<span class="built_in">setY</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>() * right.<span class="built_in">getX</span>() - <span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() * right.<span class="built_in">getZ</span>());</span><br><span class="line">	result.<span class="built_in">setZ</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() * right.<span class="built_in">getY</span>() - <span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() * right.<span class="built_in">getX</span>());</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Vector3::Normalize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> length = <span class="built_in">sqrtf</span>(<span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>(), <span class="number">2</span>));</span><br><span class="line">	<span class="keyword">this</span>-&gt;<span class="built_in">setX</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() / length);</span><br><span class="line">	<span class="keyword">this</span>-&gt;<span class="built_in">setY</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() / length);</span><br><span class="line">	<span class="keyword">this</span>-&gt;<span class="built_in">setZ</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>() / length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Vector3 <span class="title">Vector3::Normalize</span><span class="params">(<span class="type">const</span> Vector3&amp; vecToBeNormalized)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Vector3 result;</span><br><span class="line">	<span class="type">float</span> length = <span class="built_in">sqrtf</span>(<span class="built_in">powf</span>(vecToBeNormalized.<span class="built_in">getX</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(vecToBeNormalized.<span class="built_in">getY</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(vecToBeNormalized.<span class="built_in">getZ</span>(), <span class="number">2</span>));</span><br><span class="line">	result.<span class="built_in">setX</span>(vecToBeNormalized.<span class="built_in">getX</span>() / length);</span><br><span class="line">	result.<span class="built_in">setY</span>(vecToBeNormalized.<span class="built_in">getY</span>() / length);</span><br><span class="line">	result.<span class="built_in">setZ</span>(vecToBeNormalized.<span class="built_in">getZ</span>() / length);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">Vector3::getLength</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">sqrtf</span>(<span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>(), <span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/* Vector4                                                              */</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="type">bool</span> Vector4::<span class="keyword">operator</span>==(<span class="type">float</span> right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">bool</span> xIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() - right) &lt;= EPSILON;</span><br><span class="line">	<span class="type">bool</span> yIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() - right) &lt;= EPSILON;</span><br><span class="line">	<span class="type">bool</span> zIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>() - right) &lt;= EPSILON;</span><br><span class="line">	<span class="type">bool</span> wIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getW</span>() - right) &lt;= EPSILON;</span><br><span class="line">	<span class="keyword">return</span> (xIsEqual &amp;&amp; yIsEqual &amp;&amp; zIsEqual &amp;&amp; wIsEqual);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Vector4::<span class="keyword">operator</span>==(<span class="type">const</span> Vector4 &amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">bool</span> xIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() - right.<span class="built_in">getX</span>()) &lt;= EPSILON;</span><br><span class="line">	<span class="type">bool</span> yIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() - right.<span class="built_in">getY</span>()) &lt;= EPSILON;</span><br><span class="line">	<span class="type">bool</span> zIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>() - right.<span class="built_in">getZ</span>()) &lt;= EPSILON;</span><br><span class="line">	<span class="type">bool</span> wIsEqual = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getW</span>() - right.<span class="built_in">getW</span>()) &lt;= EPSILON;</span><br><span class="line">	<span class="keyword">return</span> (xIsEqual &amp;&amp; yIsEqual &amp;&amp; zIsEqual &amp;&amp; wIsEqual);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Vector4::<span class="keyword">operator</span>!=(<span class="type">const</span> Vector4 &amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">bool</span> xIsInequal = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() - right.<span class="built_in">getX</span>()) &gt; EPSILON;</span><br><span class="line">	<span class="type">bool</span> yIsInequal = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() - right.<span class="built_in">getY</span>()) &gt; EPSILON;</span><br><span class="line">	<span class="type">bool</span> zIsInequal = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>() - right.<span class="built_in">getZ</span>()) &gt; EPSILON;</span><br><span class="line">	<span class="type">bool</span> wIsInequal = <span class="built_in">fabsf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getW</span>() - right.<span class="built_in">getW</span>()) &gt; EPSILON;</span><br><span class="line">	<span class="keyword">return</span> (xIsInequal || yIsInequal || zIsInequal || wIsInequal);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector4 Vector4::<span class="keyword">operator</span> +(<span class="type">const</span> Vector4 &amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector4 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX() + right.getX(), <span class="keyword">this</span>-&gt;getY() + right.getY(), <span class="keyword">this</span>-&gt;getZ() + right.getZ(), <span class="keyword">this</span>-&gt;getW() + right.getW())</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector4 Vector4::<span class="keyword">operator</span>-(<span class="type">const</span> Vector4 &amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector4 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX() - right.getX(), <span class="keyword">this</span>-&gt;getY() - right.getY(), <span class="keyword">this</span>-&gt;getZ() - right.getZ(), <span class="keyword">this</span>-&gt;getW() - right.getW())</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector4 Vector4::<span class="keyword">operator</span>*(<span class="type">const</span> <span class="type">float</span> k) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector4 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX()*k, <span class="keyword">this</span>-&gt;getY()*k, <span class="keyword">this</span>-&gt;getZ() *k, <span class="keyword">this</span>-&gt;getW() *k)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector4 Vector4::<span class="keyword">operator</span>/(<span class="type">const</span> <span class="type">float</span> k) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">float</span> reciprocalK = <span class="number">1</span> / k;</span><br><span class="line">	<span class="function">Vector4 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getX()*reciprocalK, <span class="keyword">this</span>-&gt;getY()*reciprocalK, <span class="keyword">this</span>-&gt;getZ() *reciprocalK, <span class="keyword">this</span>-&gt;getW() *reciprocalK)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> Vector4::<span class="keyword">operator</span> *(<span class="type">const</span> Vector4 &amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">getX</span>()*right.<span class="built_in">getX</span>() + <span class="keyword">this</span>-&gt;<span class="built_in">getY</span>()*right.<span class="built_in">getY</span>() + <span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>()*right.<span class="built_in">getZ</span>() + <span class="keyword">this</span>-&gt;<span class="built_in">getW</span>()*right.<span class="built_in">getW</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vector4 Vector4::<span class="keyword">operator</span> ^(<span class="type">const</span> Vector4&amp; right) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">Vector4 <span class="title">result</span><span class="params">(<span class="keyword">this</span>-&gt;getY()*right.getZ() - <span class="keyword">this</span>-&gt;getZ()*right.getY(),</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">this</span>-&gt;getZ()*right.getX() - <span class="keyword">this</span>-&gt;getX()*right.getZ(),</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">this</span>-&gt;getX()* right.getY() - <span class="keyword">this</span>-&gt;getY()*right.getX())</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Vector4 <span class="title">Vector4::getInterpolateVector</span><span class="params">(<span class="type">const</span> Vector4 &amp; vecA, <span class="type">const</span> Vector4 &amp; vecB, <span class="type">float</span> factor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">Vector4 <span class="title">result</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		LinearInerpolate(vecA.getX(), vecB.getX(), factor),</span></span></span><br><span class="line"><span class="params"><span class="function">		LinearInerpolate(vecA.getY(), vecB.getY(), factor),</span></span></span><br><span class="line"><span class="params"><span class="function">		LinearInerpolate(vecA.getZ(), vecB.getZ(), factor),</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="number">1.f</span></span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Vector4 <span class="title">Vector4::getQuaternion</span><span class="params">(<span class="type">const</span> Vector3 &amp; lastPoint, <span class="type">const</span> Vector3 &amp; currentPoint)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Vector4 result;</span><br><span class="line"></span><br><span class="line">	Vector3 perp = lastPoint ^ currentPoint;</span><br><span class="line">	<span class="keyword">if</span> (perp.<span class="built_in">getLength</span>() &gt; EPSILON)</span><br><span class="line">	&#123;</span><br><span class="line">		result.<span class="built_in">setX</span>(perp.<span class="built_in">getX</span>());</span><br><span class="line">		result.<span class="built_in">setY</span>(perp.<span class="built_in">getY</span>());</span><br><span class="line">		result.<span class="built_in">setZ</span>(perp.<span class="built_in">getZ</span>());</span><br><span class="line">		<span class="comment">// w=cos(rotationAngle/2) ---&gt; formula</span></span><br><span class="line">		result.<span class="built_in">setW</span>(lastPoint * currentPoint);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		result.<span class="built_in">setX</span>(<span class="number">.0</span>f);</span><br><span class="line">		result.<span class="built_in">setY</span>(<span class="number">.0</span>f);</span><br><span class="line">		result.<span class="built_in">setZ</span>(<span class="number">.0</span>f);</span><br><span class="line">		result.<span class="built_in">setW</span>(<span class="number">.0</span>f);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Vector4::Normalize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> length = <span class="built_in">sqrtf</span>(<span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>(), <span class="number">2</span>));</span><br><span class="line">	<span class="keyword">this</span>-&gt;<span class="built_in">setX</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() / length);</span><br><span class="line">	<span class="keyword">this</span>-&gt;<span class="built_in">setY</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() / length);</span><br><span class="line">	<span class="keyword">this</span>-&gt;<span class="built_in">setZ</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>() / length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Vector4 <span class="title">Vector4::GetNormalizedVector</span><span class="params">()</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Vector4 result;</span><br><span class="line">	<span class="type">float</span> length = <span class="built_in">sqrtf</span>(<span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>(), <span class="number">2</span>) + <span class="built_in">powf</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>(), <span class="number">2</span>));</span><br><span class="line">	result.<span class="built_in">setX</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getX</span>() / length);</span><br><span class="line">	result.<span class="built_in">setY</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getY</span>() / length);</span><br><span class="line">	result.<span class="built_in">setZ</span>(<span class="keyword">this</span>-&gt;<span class="built_in">getZ</span>() / length);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Vector4::swap</span><span class="params">(Vector4 &amp; v1, Vector4 &amp; v2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (v1 != v2)</span><br><span class="line">	&#123;</span><br><span class="line">		std::<span class="built_in">swap</span>(v1.m_x, v2.m_x);</span><br><span class="line">		std::<span class="built_in">swap</span>(v1.m_y, v2.m_y);</span><br><span class="line">		std::<span class="built_in">swap</span>(v1.m_z, v2.m_z);</span><br><span class="line">		std::<span class="built_in">swap</span>(v1.m_w, v2.m_w);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<br>
<br>
<br>
<br>
<br>



<h2 id="Rendering-pipeline"><a href="#Rendering-pipeline" class="headerlink" title="Rendering pipeline"></a>Rendering pipeline</h2><p>Learning the rendering pipeline is crucial for the study of computer graphics.</p>
<br>

<p>Here are three major stages in the rendering pipeline:</p>
<ol>
<li><code>Application Stage</code></li>
<li><code>Geometry Conduction Stage</code></li>
<li><code>Rasterization Stage</code></li>
</ol>
<br>
<br>

<h3 id="1-Application-Stage"><a href="#1-Application-Stage" class="headerlink" title="1. Application Stage"></a>1. Application Stage</h3><p>In this stage, all of the elements you got is in its original state. For example, if you’re going to read the positions of an OBJ formatted model in to the computer buffer so as to construct each of the position into a vertex and then calculate them later, you should have a formatted OBJ model first and then read those positions into a vector orderly. Whatever your model’s format is, FBX, MTL or any other formats, reading into the position information to a vector is the first step. </p>
<p>Besides the positions information, there are still lots of information such as the <strong>texture coordinates</strong>, the <strong>normal vector</strong>, the <strong>blend weights</strong> and <strong>blend shapes</strong>, the <strong>bone weights</strong> to read from a file(OBJ, FBX, MTL, etc,.) that holds the models information. These information builds up the attributes of a vertex. Just take the texture coordinate (in the project it is name “Texcoord”) for example. The texture coordinate, as a basic attribute of a vertex, it includes the information about a vertex’s U axis and V axis, which informs us the way to put texture on the model. </p>
<p>Finally, as these information(the <strong>texture coordinates</strong>, the <strong>normal vector</strong>, the <strong>blend weights</strong> and <strong>blend shapes</strong>, the <strong>bone weights</strong>) are stored in a vertex orderly and correctly, a simple but formal vertex is born. Its structure should be like the structure shown below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SimpleVertex</span></span><br><span class="line">&#123;</span><br><span class="line">	Vector4 pos;</span><br><span class="line">	Colour color;</span><br><span class="line">	Texcoord tex;</span><br><span class="line">	Vector4 normal;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>You might see that the Vertex struct is simple compared with the ones you might ever seen in other materials, as I have excluded many of the attributes for this vertex struct like the blend weight, the blend shapes and the bone weights that I have described in the paragraph above. Also, the attributes like “rhw”, which represents the reciprocal of homogenous W, is not shown directly in this chapter just for the convenience of clarifying the process of the Application Stage, but they will later be added in.</p>
<br>

<p>Let’s take a closer look at the inside of this simple vertex.</p>
<p>You may realize that the position attribute in our vertex is a four-dimensional vector rather than a 3D one. So what does the fourth dimension represents for? Why we use a four-dimensional vector to store a position in a three-dimensional scene? Actually the W, which is the forth dimension, represents for the homogeneous coordinate. Now tha question lingers that why we use homogeneous coordinate while 3D coordinate is enough?<br>The answer of the questions above lays on the three factors below:</p>
<p>(1) It plays an important role when conducting homogeneous transformation. The Homogeneous Transformation Matrix For 3D Bodies is shown below. You will notice that it will be easier for multiple matrices’ multiplication if you use have N+1 dimensions than directly calculating N dimensional matrices. Especially the rotation will be more convenient for the quaternion itself demands 4 dimensional vector.</p>
<p><img src="/Blog/Blog/2022/03/18/CG-In-Practice/Homogeneous%20Transformation%20Matrix%20For%203D%20Bodies.png" alt="CG"></p>
<!-- <p align='center'>
<img src="./Homogeneous%20Transformation%20Matrix%20For%203D%20Bodies.png">
</p> -->


<p>(2) In real world, two parallel lines will never meet with one another mathematically, but in perspective(human-eye) projection it will. In Euclidean space(geometry), two parallel line on the same plane cannot interest, or cannot cannot meet each other forever. Euclidean space describe our 2D or 3D space so well, but they are not sufficient to handle the projective space. What if this point goes far away to infinity? The point at infinity would be (∞, ∞) and it becomes meaningless in Euclidean space. The parallel lines should meet at infinity in projective space, but cannot do in Euclidean space. Mathematicians have discovered a way to solve this issue: Homogeneous Coordinate. Adding the W as the forth dimension can transform a vertex from Euclidean space to projective space while dividing to W can transform it back.<br>For example:</p>
<ul>
<li>A &#x3D; (x1, y1, z1)</li>
<li>B &#x3D; (x2, y2, z2)</li>
<li>A &#x2F;&#x2F; B</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">αx1 + βy1 + θz1 + d = 0</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">αx2 + βy2 + θz2 + d = 0</span><br></pre></td></tr></table></figure>

<p>In perspective projection, even though these two lines are parallel, they still intersect in some point. But how to get that intersected point? Just add the homogeneous coordinate like I did below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(αx1/w)*w + (βy1/w)*w + (θz1/w)*w + dw = 0</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(αx2/w)*w + (βy2/w)*w + (θz2/w)*w + dw = 0</span><br></pre></td></tr></table></figure>

<p>Then we will find out a point that intersects the two parallel lines in projective space.</p>
<p>(3) It’s easy to find out a vector from a point. The point, or the position is described as (x, y, z, 1) while a vector is described as (x, y, z, 0).</p>
<p>(4) It will be easier to describe the intersection points of lines with lines and planes with planes.</p>
<br>

<p>Here is the structure of a four-dimensional vector. You’ll notice that the struct Vector4 actually has 4 dimensions: X, Y, Z and W, and all of them are defined in ‘float’ type rather than double or integer. Because either using an ‘integer’ type or a ‘double’ type is inappropriate in this circumstance. Using an ‘integer’ may lose the detail of a position while using a ‘double’ type may be space-consuming.  </p>
<p>Now here is a significant question that why we choose to use 4 dimensional vector to describe a position in 3 dimensional space while the 3 dimensional vector is enough? What is the forth dimension ‘w’ actually? Answer to these questions have actually been answered above.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Vector4</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">float</span> X;</span><br><span class="line">	<span class="type">float</span> Y;</span><br><span class="line">	<span class="type">float</span> Z;</span><br><span class="line">	<span class="type">float</span> W;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>In order to make the four-dimensional vector available and convenient to use in a real project, we have to make some APIs for it. The class below shows a more mature structure of a four-dimensional vector, including <code>initialization constructor</code>, <code>copy constructor</code>, <code>overridden operators</code>,  and ‘get()s’ and ‘set()s’ for needed private members.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vector4</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="built_in">Vector4</span>() :</span><br><span class="line">			<span class="built_in">m_x</span>(<span class="number">0</span>), <span class="built_in">m_y</span>(<span class="number">0</span>), <span class="built_in">m_z</span>(<span class="number">0</span>), <span class="built_in">m_w</span>(<span class="number">0</span>) &#123;&#125;;</span><br><span class="line">		<span class="built_in">Vector4</span>(<span class="type">const</span> Vector4&amp; vecToBeCopied) &#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;<span class="built_in">setX</span>(vecToBeCopied.<span class="built_in">getX</span>());</span><br><span class="line">			<span class="keyword">this</span>-&gt;<span class="built_in">setY</span>(vecToBeCopied.<span class="built_in">getY</span>());</span><br><span class="line">			<span class="keyword">this</span>-&gt;<span class="built_in">setZ</span>(vecToBeCopied.<span class="built_in">getZ</span>());</span><br><span class="line">			<span class="keyword">this</span>-&gt;<span class="built_in">setW</span>(vecToBeCopied.<span class="built_in">getW</span>());</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="built_in">Vector4</span>(<span class="type">const</span> Vector3&amp; vecToBeCopied, <span class="type">bool</span> isPoint = <span class="literal">false</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;<span class="built_in">setX</span>(vecToBeCopied.<span class="built_in">getX</span>());</span><br><span class="line">			<span class="keyword">this</span>-&gt;<span class="built_in">setY</span>(vecToBeCopied.<span class="built_in">getY</span>());</span><br><span class="line">			<span class="keyword">this</span>-&gt;<span class="built_in">setZ</span>(vecToBeCopied.<span class="built_in">getZ</span>());</span><br><span class="line">			<span class="keyword">if</span> (isPoint)<span class="keyword">this</span>-&gt;<span class="built_in">setW</span>(<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">this</span>-&gt;<span class="built_in">setW</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="built_in">Vector4</span>(<span class="type">const</span> <span class="type">float</span>&amp; a0, <span class="type">const</span> <span class="type">float</span>&amp; a1, <span class="type">const</span> <span class="type">float</span>&amp; a2, <span class="type">const</span> <span class="type">float</span>&amp; a3 = <span class="number">0</span>) :</span><br><span class="line">			<span class="built_in">m_x</span>(a0), <span class="built_in">m_y</span>(a1), <span class="built_in">m_z</span>(a2), <span class="built_in">m_w</span>(a3) &#123;&#125;;</span><br><span class="line">		~<span class="built_in">Vector4</span>() &#123;&#125;;</span><br><span class="line">		<span class="type">bool</span> <span class="keyword">operator</span> ==(<span class="type">float</span> right)<span class="type">const</span>;</span><br><span class="line">		<span class="type">bool</span> <span class="keyword">operator</span> ==(<span class="type">const</span> Vector4&amp; right)<span class="type">const</span>;</span><br><span class="line">		<span class="type">bool</span> <span class="keyword">operator</span> !=(<span class="type">const</span> Vector4&amp; right)<span class="type">const</span>;</span><br><span class="line">		Vector4 <span class="keyword">operator</span> +(<span class="type">const</span> Vector4&amp; right)<span class="type">const</span>;</span><br><span class="line">		Vector4 <span class="keyword">operator</span> -(<span class="type">const</span> Vector4&amp; right)<span class="type">const</span>;</span><br><span class="line">		Vector4 <span class="keyword">operator</span> *(<span class="type">const</span> <span class="type">float</span> k)<span class="type">const</span>;</span><br><span class="line">		Vector4 <span class="keyword">operator</span> /(<span class="type">const</span> <span class="type">float</span> k)<span class="type">const</span>;</span><br><span class="line">        <span class="type">float</span> <span class="keyword">operator</span> *(<span class="type">const</span> Vector4&amp; right)<span class="type">const</span>;</span><br><span class="line">		Vector4 <span class="keyword">operator</span> ^(<span class="type">const</span> Vector4&amp; right)<span class="type">const</span>; <span class="comment">// vector cross product</span></span><br><span class="line">		<span class="function">Vector4 <span class="title">getInterpolateVector</span><span class="params">(<span class="type">const</span> Vector4&amp; vecA, <span class="type">const</span> Vector4&amp; vecB, <span class="type">float</span> factor)</span></span>;</span><br><span class="line">		<span class="function">Vector4 <span class="title">getQuaternion</span><span class="params">(<span class="type">const</span> Vector3 &amp; lastPoint, <span class="type">const</span> Vector3 &amp; currentPoint)</span></span>;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">Normalize</span><span class="params">()</span></span>;</span><br><span class="line">		<span class="function">Vector4 <span class="title">GetNormalizedVector</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">		<span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">swap</span><span class="params">(Vector4&amp; v1, Vector4&amp; v2)</span></span>;</span><br><span class="line">        </span><br><span class="line">		<span class="function"><span class="type">float</span> <span class="title">getX</span><span class="params">()</span><span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_x; &#125;</span><br><span class="line">		<span class="function"><span class="type">float</span> <span class="title">getY</span><span class="params">()</span><span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_y; &#125;</span><br><span class="line">		<span class="function"><span class="type">float</span> <span class="title">getZ</span><span class="params">()</span><span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_z; &#125;</span><br><span class="line">		<span class="function"><span class="type">float</span> <span class="title">getW</span><span class="params">()</span><span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_w; &#125;</span><br><span class="line">		<span class="function"><span class="type">float</span> <span class="title">getR</span><span class="params">()</span><span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_x; &#125;</span><br><span class="line">		<span class="function"><span class="type">float</span> <span class="title">getG</span><span class="params">()</span><span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_y; &#125;</span><br><span class="line">		<span class="function"><span class="type">float</span> <span class="title">getB</span><span class="params">()</span><span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_z; &#125;</span><br><span class="line">		<span class="function"><span class="type">float</span> <span class="title">getA</span><span class="params">()</span><span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_w; &#125;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">setX</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; x)</span> </span>&#123; m_x = x; &#125;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">setY</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; y)</span> </span>&#123; m_y = y; &#125;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">setZ</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; z)</span> </span>&#123; m_z = z; &#125;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">setW</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; w)</span> </span>&#123; m_w = w; &#125;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">setR</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; r)</span> </span>&#123; m_x = r; &#125;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">setG</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; g)</span> </span>&#123; m_y = g; &#125;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">setB</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; b)</span> </span>&#123; m_z = b; &#125;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">setA</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; a)</span> </span>&#123; m_w = a; &#125;</span><br><span class="line">        </span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		<span class="type">float</span> m_x;</span><br><span class="line">		<span class="type">float</span> m_y;</span><br><span class="line">		<span class="type">float</span> m_z;</span><br><span class="line">		<span class="type">float</span> m_w;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Among <code>initialization constructor</code>, <code>copy constructor</code>, <code>overridden operators</code>, the overridden of the vector is closely related to the mathematics. No need to mention that the operators ‘plus’ and ‘minus’ are easy to understand, but the overridden operators of ‘*&#39; and ‘^&#39; are a little bit hard to understand. I use the overridden operator for ‘*&#39; to represent the inner product of two vectors, while using ‘^&#39; to represent the cross product(namely: outer product) of the two vectors.</p>
<p>We need to know the differences between the inner product and the cross product. </p>
<p>The inner product of the 2 vectors is just to make the two vector multiply in mathematical way, the detail of the inner product of 2 vectors is shown below.</p>
<p>An inner product is a generalization of the dot product. In a vector space, it is a way to multiply vectors together, with the result of this multiplication being a scalar. A simple inner product of the two vectors is shown below</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A*B = ||A||*||B||*cos(θ)</span><br></pre></td></tr></table></figure>


<p>The cross product of the 2 vectors is totally different for just multiplying the vectors and it has distinct meaning from the inner product. The detail of the cross product of 2 vectors is shown below.  </p>
<p>The Cross Product a × b of two vectors is another vector that is at right angles to both:</p>
<p><img src="/Blog/Blog/2022/03/18/CG-In-Practice/AcrossB.png" alt="CG"></p>
<!-- <p align='center'>
<img src="./AcrossB.png">
</p> -->

<p>The cross product could point in the completely opposite direction and still be at right angles to the two other vectors, so we have the: <code>Right Hand Rule</code>.</p>
<p><img src="/Blog/Blog/2022/03/18/CG-In-Practice/rightHandRule.png" alt="CG"></p>
<!-- <p align='center'>
<img src="./rightHandRule.png">
</p> -->



<p>The magnitude (length) of the cross product equals the area of a parallelogram with vectors a and b for sides:</p>
<p><img src="/Blog/Blog/2022/03/18/CG-In-Practice/lengthACrossB.png" alt="CG"></p>
<!-- <p align='center'>
<img src="./lengthACrossB.png">
</p> -->

<p>See how it changes for different angles:</p>
<p><img src="/Blog/Blog/2022/03/18/CG-In-Practice/crossProduct.gif" alt="CG"></p>
<!-- <p align='center'>
<img src="./crossProduct.gif">
</p> -->

<p>The cross product (blue) is:</p>
<ul>
<li>zero in length when vectors a and b point in the same, or opposite, direction</li>
<li>reaches maximum length when vectors a and b are at right angles</li>
</ul>
<p>And it can point one way or the other!</p>
<p>So how do we calculate it?</p>
<p>We can calculate the Cross Product this way:</p>
<p><img src="/Blog/Blog/2022/03/18/CG-In-Practice/crossProduct.png" alt="CG"></p>
<!-- <p align='center'>
<img src="./crossProduct.png">
</p> -->


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a × b = |a|*|b|*sin(θ)*n</span><br></pre></td></tr></table></figure>


<ul>
<li>|a| is the magnitude (length) of vector a</li>
<li>|b| is the magnitude (length) of vector b</li>
<li>θ is the angle between a and b</li>
<li>n is the unit vector at right angles to both a and b</li>
</ul>
<p>OR we can calculate it this way:<br>When a and b start at the origin point (0,0,0), the Cross Product will end at:</p>
<ul>
<li>cx &#x3D; aybz − azby</li>
<li>cy &#x3D; azbx − axbz</li>
<li>cz &#x3D; axby − aybx</li>
</ul>
<p><img src="/Blog/Blog/2022/03/18/CG-In-Practice/calculateCrossProduct.png" alt="CG"></p>
<!-- <p align='center'>
<img src="./calculateCrossProduct.png">
</p> -->


<br>
<br>

<p>Next, there is a color attribute in our vertex called ‘SimpleVertex’. The color attribute is defined as a <code>Colour</code> type, which is also a self-defined type like ‘Vector4’. The color attribute stores a position’s color information, so that we can achieve lighting based on it. The inside of the ‘Colour’ type can also be regarded as a C++ struct, its structure is shown as below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Colour</span> </span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">float</span> Red;</span><br><span class="line">	<span class="type">float</span> Green;</span><br><span class="line">	<span class="type">float</span> Blue;</span><br><span class="line">	<span class="type">float</span> Alpha; <span class="comment">// (In my final project, alpha is not used.)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Its outlined structure is so simple that only contains three float members to represent three primary colors of the light, including a number to represent the alpha.</p>
<p>Also, in order to use it in the real project more conveniently, basic APIs should be added into the ‘Colour’ structure above, as well as some more color-related APIs. The final structure of the color will be like the one below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Colour</span> </span><br><span class="line">&#123;</span><br><span class="line">		<span class="built_in">Colour</span>() = <span class="keyword">default</span>;</span><br><span class="line">		<span class="built_in">Colour</span>(<span class="type">const</span> <span class="type">float</span> red, <span class="type">const</span> <span class="type">float</span> green, <span class="type">const</span> <span class="type">float</span> blue) :</span><br><span class="line">			<span class="built_in">r</span>(red), <span class="built_in">g</span>(green), <span class="built_in">b</span>(blue)&#123;&#125;</span><br><span class="line">		<span class="built_in">Colour</span>(<span class="type">const</span> Colour&amp; right)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;r = right.r;</span><br><span class="line">			<span class="keyword">this</span>-&gt;g = right.g;</span><br><span class="line">			<span class="keyword">this</span>-&gt;b = right.b;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">bool</span> <span class="keyword">operator</span> ==(<span class="type">const</span> Colour&amp; right)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>-&gt;r - right.r &lt;= EPSILON</span><br><span class="line">				&amp;&amp; <span class="keyword">this</span>-&gt;g - right.g &lt;= EPSILON</span><br><span class="line">				&amp;&amp; <span class="keyword">this</span>-&gt;b - right.b &lt;= EPSILON)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Colour&amp; <span class="keyword">operator</span> =(<span class="type">const</span> Colour&amp; right)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span> == &amp;right) </span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>-&gt;r = right.r;</span><br><span class="line">			<span class="keyword">this</span>-&gt;g = right.g;</span><br><span class="line">			<span class="keyword">this</span>-&gt;b = right.b;</span><br><span class="line">			<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function">Colour <span class="title">ClampColor</span><span class="params">(Colour&amp; color)</span></span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="built_in">Clamp</span>(color.r, <span class="number">0.f</span>, <span class="number">1.f</span>);</span><br><span class="line">			<span class="built_in">Clamp</span>(color.g, <span class="number">0.f</span>, <span class="number">1.f</span>);</span><br><span class="line">			<span class="built_in">Clamp</span>(color.b, <span class="number">0.f</span>, <span class="number">1.f</span>);</span><br><span class="line">			<span class="keyword">return</span> color;</span><br><span class="line">		&#125;</span><br><span class="line">		Colour <span class="keyword">operator</span> /(<span class="type">const</span> <span class="type">float</span> right) &#123;</span><br><span class="line">			Colour result;</span><br><span class="line">			result.r = <span class="keyword">this</span>-&gt;r / right;</span><br><span class="line">			result.g = <span class="keyword">this</span>-&gt;g / right;</span><br><span class="line">			result.b = <span class="keyword">this</span>-&gt;b / right;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">		Colour <span class="keyword">operator</span> *(<span class="type">const</span> Colour&amp; right) <span class="type">const</span></span><br><span class="line">		&#123;</span><br><span class="line">			Colour result;</span><br><span class="line">			result.r = <span class="keyword">this</span>-&gt;r * right.r;</span><br><span class="line">			result.g = <span class="keyword">this</span>-&gt;g * right.g;</span><br><span class="line">			result.b = <span class="keyword">this</span>-&gt;b * right.b;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">		Colour <span class="keyword">operator</span> *(<span class="type">const</span> <span class="type">float</span>&amp; right) <span class="type">const</span></span><br><span class="line">		&#123;</span><br><span class="line">			Colour result;</span><br><span class="line">			result.r = <span class="keyword">this</span>-&gt;r * right;</span><br><span class="line">			result.g = <span class="keyword">this</span>-&gt;g * right;</span><br><span class="line">			result.b = <span class="keyword">this</span>-&gt;b * right;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">		Colour <span class="keyword">operator</span> +(<span class="type">const</span> Colour&amp; right)</span><br><span class="line">		&#123;</span><br><span class="line">			Colour result;</span><br><span class="line">			result.r = <span class="keyword">this</span>-&gt;r + right.r;</span><br><span class="line">			result.g = <span class="keyword">this</span>-&gt;g + right.g;</span><br><span class="line">			result.b = <span class="keyword">this</span>-&gt;b + right.b;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">		Colour <span class="keyword">operator</span> -(<span class="type">const</span> Colour&amp; right)</span><br><span class="line">		&#123;</span><br><span class="line">			Colour result;</span><br><span class="line">			result.r = <span class="keyword">this</span>-&gt;r - right.r;</span><br><span class="line">			result.g = <span class="keyword">this</span>-&gt;g - right.g;</span><br><span class="line">			result.b = <span class="keyword">this</span>-&gt;b - right.b;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">		Colour&amp; <span class="keyword">operator</span> *=(<span class="type">const</span> Colour&amp; right) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">return</span> (*<span class="keyword">this</span>) = (*<span class="keyword">this</span> * right);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">float</span> r, g, b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>One important thing to mention in the code above is <code>the comparison of the two float-typed numbers</code>. <strong>In computer, a float-type number may well not be the exact number we saw on log, it may hide subtle bias behind its decimal point, especially those float-type numbers after having mathematical operations</strong>. Remember that 1.0 - 1.0 in computer may not be 0 at all. To avoid this, <strong>we have to use subtraction and epsilon when comparing 2 float-type(or double-type) numbers</strong>. For example, <code>if you want to know whether two float-type numbers are equal, subtraction of these two numbers is the first step, then just compare the subtracted result with the epsilon---a pretty tiny number that we have previously defined before. If the result is smaller than the epsilon, it means that the two float-type numbers are equal, vice versa.</code></p>
<br>

<p>Besides the basic APIs and operators we have mentioned above when talking about the ‘Vector4’, here we can see a different API called ‘ClampColor(Colour&amp; color)’. As the word’s own meaning goes, the <code>Clamp</code> is a way to clamp some number in or der to make it into the range previously set, let’s just call that range ‘valid range’. So it is a simple conduction just to avoid the number being outside the bounds of range. For example, if you only want to ensure the digits you get are within the range of x and y, mathematically written as [x, y], you can just take y — which is the roof of the range — if some number is bigger than y, vice versa. The code below shows how does the clamping works:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">float</span> <span class="title">Clamp</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; param, <span class="type">const</span> <span class="type">float</span>&amp; min, <span class="type">const</span> <span class="type">float</span>&amp; max)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (param &lt;= min)</span><br><span class="line">		<span class="keyword">return</span> min;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (param &gt;= max)</span><br><span class="line">		<span class="keyword">return</span> max;</span><br><span class="line">	<span class="keyword">return</span> param;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>An optimization is just shown below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">float</span> <span class="title">Clamp</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; param, <span class="type">const</span> <span class="type">float</span>&amp; min, <span class="type">const</span> <span class="type">float</span>&amp; max)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ((param &lt; min) ? min : ((param &gt; max) ? max : param));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>But why we clamp colors? </p>
<p>As a common sense that we can use 0<del>1 or 0</del>255 to represent a color’s attribute(R, G, B, A). In this case, we use 0~1. So this demands each of the color lies within the range of [0, 1]. In calculating float-type-based colors, because of the complex algorithm we use, it is almost possible that we gain a number outside the range we want. So clamping is always necessary.</p>
<br>


<p>The third member in our vertex is ‘Texcoord’, which represents texture coordinate, and its structure is very simple that only has two float-typed member, one is ‘U’ and the other is ‘V’. Just see the struct below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Texcoord</span> </span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">float</span> U;</span><br><span class="line">	<span class="type">float</span> V;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Texture coordinates, also called UVs, are pairs of numbers stored in the vertices of a mesh.</p>
<p>These numbers are often used to stretch a 2D texture onto a 3D mesh, but they can be used for other things like coloring the mesh, controlling the flow across the surface , etc.</p>
<p>Game engines commonly use two texture coordinates, U and V, for mapping the width and height of a texture. A third axis W can also be used for depth if you are using a 3D volume texture, but usually this coordinate is removed for efficiency.</p>
<p>Texture coordinates are measured in a scale of 0.0 to 1.0, with 0.0 and 1.0 at opposite sides of the texture. When a model has a UV distance greater than 1 (for example, UV goes from -1 to 2) then the texture will tile across the model.</p>
<p>These numbers are usually hidden from the artist, replaced by helpful visual representations of how the textures are projected. Planes, cylinders and spheres help the artist align the textures in a visual way, but it helps to know that games only see the UV numbers that these shapes create.</p>
<p>Texture coordinates define how an image (or portion of an image) gets mapped to a geometry. A texture coordinate is associated with each vertex on the geometry, and it indicates what point within the texture image should be mapped to that vertex.<br>Each texture coordinate is, at a minimum, a (u,v) pair, which is the horizontal and vertical location in texture space, respectively. The values are typically in the range of [0,1]. The (0,0) origin is at the lower left of the texture.<br>For (u,v) values outside the range of [0,1], the Texture Wrap Style property describes how this is handled.<br>Texture coordinates may also have optional values “w” and “q”. This is often represented as (u,v,w,q). These coordinates are both optional, so you may have, for example, (u,v,w) or (u,v,q).<br>The ‘w’ is used for more complex texture mapping in 3D space and is seen relatively infrequently in most workflows. This mapping in 3D may be in relation to 3D textures or 2D texture variations in 3D such as shadows. It can also be used with 2D textures that are intended to represent complex irregular surfaces in 3D.<br>The ‘w’ is used when rendering, in conjunction with the texture’s transformation values such as rotation, shearing, scaling, and offset. w is an extra value against which to multiply the texture transformation values, and may be used when you want to take perspective into account (such as in shadow mapping). It works the same as when you transform a location in object-space to 3D (solid) screen-space via a world-view-projection matrix. By multiplying the uvw with projection transformation values, you end up with two coordinates (often called s and t) which are then mapped onto a 2D texture.<br>The ‘q’ is used to scale texture coordinates when employing techniques such as projective interpolation. For most use cases, if a system can only handle (u,v) texture coordinates and is instead offered (u,v,q) values, a location of (u&#x2F;q,v&#x2F;q) may be used.</p>
<br>
<br>

<p>As we have took so much time on introducing the basic elements called ‘vertex’, we are sure that we have appropriate data structures to store the basic information of a 3D model. Let’s go on to the next step: <code>Reading the model into the memory</code>, which means that we are going to use our vertex-typed container to store each of the vertex from a 3D model. In C++, its convenient that we can use ‘vector’ in STL as a list to store all of the information we read from the model. Using ‘vector&lt;SimpleVertex&gt;‘ to represent a list of ‘SimpleVertex’ that we have just constructed above. Then comes the reading of a 3D model file. In this case we use OBJ format as it’s file structure is easier understand and visible in file format rather than a binary format like other model files. Lets take a simple look at the content of an file with OBJ format:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># File Created: 25.02.2021 17:35:16</span><br><span class="line"># object Teapot001</span><br><span class="line"></span><br><span class="line">v  0.279771417379 0.523323953152 0.361592650414</span><br><span class="line">v  0.256112784147 0.523323953152 0.481412023306</span><br><span class="line">v  0.252184033394 0.539422273636 0.479740440845</span><br><span class="line">... ... ... ## details ignored</span><br><span class="line">v  0.207081869245 0.542744159698 0.262634694576</span><br><span class="line">v  0.235997557640 0.523323953152 0.250331819057</span><br><span class="line"># 529 vertices</span><br><span class="line"></span><br><span class="line">vn -0.966742336750 -0.255752444267 -0.000000119668</span><br><span class="line">vn -0.893014192581 -0.256344825029 -0.369882434607</span><br><span class="line">vn -0.893437385559 0.255995273590 -0.369101703167</span><br><span class="line">vn -0.966824233532 0.255442529917 -0.000000077787</span><br><span class="line">... ... ... ## details ignored</span><br><span class="line">vn 0.350497841835 0.925311684608 -0.144739553332</span><br><span class="line">vn 0.485588967800 0.850653529167 -0.201474279165</span><br><span class="line"># 530 vertex normals</span><br><span class="line"></span><br><span class="line">vt 2.000000000000 2.000000000000 0.000000000000</span><br><span class="line">vt 1.750000000000 2.000000000000 0.000000000000</span><br><span class="line">... ... ... ## details ignored</span><br><span class="line">vt 0.375000000000 0.999999880791 0.000000000000</span><br><span class="line"># 323 texture coords</span><br><span class="line"></span><br><span class="line">o Teapot001</span><br><span class="line">g Teapot001</span><br><span class="line">f 1/1/1 2/2/2 3/3/3 </span><br><span class="line">f 3/3/3 4/4/4 1/1/1 </span><br><span class="line">... ... ... ## details ignored</span><br><span class="line">f 528/250/529 471/254/472 473/256/474 </span><br><span class="line">f 473/256/474 529/252/530 528/250/529 </span><br><span class="line"># 1024 faces</span><br></pre></td></tr></table></figure>

<p>The content of the OBJ file above is a pretty simple once, with many details ignored but the whole structure is entirely considered. The ‘#’ can be regarded as comments, there is no headers or tails in any OBJ files. Beginning with the vertex data, the ‘v’ represents the geometric vertices, ‘vt’ means ‘texture vertices’, ‘vn’ is ‘vertex normals’, and in some of the OBJ files there is ‘vp’, which means the parameter space vertices. Then comes the groups, ‘o’ is for the name of the object, ‘g’ is for the name of the group. The ‘f’ is crucial for it means ‘face’, the vertex indexes are split by ‘&#x2F;‘, and always remember that the structure is mainly controlled by geometric vertices and the faces. We just stop deepening into the content of the file format as the detailed introduction about the OBJ file can be found online if you’re interested. Besides, you can even use FBX in your project rather than this kind of simple OBJ files. </p>
<p>Next, just I’m gonna show you the way to read OBJ file into our vertex container, namely, the computer memory we have constructed before. You can see that I divides the OBJ model data into the types(‘v’, ‘vt’, ‘vn’, ‘f’) before reading into the container just in accordance with the content of the files mentioned above.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ReadOBJFileIntoOBJModel</span><span class="params">(<span class="type">const</span> std::string&amp; path, ModelInfo* obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::ifstream in;</span><br><span class="line">	in.<span class="built_in">open</span>(path, std::ifstream::in);</span><br><span class="line">	<span class="keyword">if</span> (in.<span class="built_in">fail</span>()) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span> (in)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">int</span> vertexIndex = <span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> vertexCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		std::vector&lt;Vector4&gt; verts;</span><br><span class="line">		std::vector&lt;Vector3&gt; texs;</span><br><span class="line">		std::vector&lt;Vector4&gt; norms;</span><br><span class="line">		std::string line;</span><br><span class="line">		<span class="type">float</span> maxVx = -FLT_MAX, maxVy = -FLT_MAX, maxVz = -FLT_MAX;</span><br><span class="line">		<span class="type">float</span> minVx = FLT_MAX, minVy = FLT_MAX, minVz = FLT_MAX;</span><br><span class="line">		<span class="keyword">while</span> (!in.<span class="built_in">eof</span>()) &#123;</span><br><span class="line">			std::<span class="built_in">getline</span>(in, line);</span><br><span class="line">			<span class="function">std::istringstream <span class="title">iss</span><span class="params">(line.c_str())</span></span>;</span><br><span class="line">			<span class="type">char</span> trash;</span><br><span class="line">			<span class="keyword">if</span> (!line.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&quot;v &quot;</span>)) &#123;</span><br><span class="line">				iss &gt;&gt; trash;</span><br><span class="line">				<span class="type">float</span> x, y, z;</span><br><span class="line">				iss &gt;&gt; x;</span><br><span class="line">				iss &gt;&gt; y;</span><br><span class="line">				iss &gt;&gt; z;</span><br><span class="line">				<span class="function">Vector4 <span class="title">v</span><span class="params">(x, y, z, <span class="number">1.f</span>)</span></span>;</span><br><span class="line">				Vertex newVertex;</span><br><span class="line">				newVertex.pos = v;</span><br><span class="line">				obj-&gt;vertexVec.<span class="built_in">push_back</span>(newVertex);</span><br><span class="line">				vertexCount++;</span><br><span class="line">				maxVx = std::<span class="built_in">fmaxf</span>(maxVx, v.<span class="built_in">getX</span>());</span><br><span class="line">				maxVy = std::<span class="built_in">fmaxf</span>(maxVy, v.<span class="built_in">getY</span>());</span><br><span class="line">				maxVz = std::<span class="built_in">fmaxf</span>(maxVz, v.<span class="built_in">getZ</span>());</span><br><span class="line">				minVx = std::<span class="built_in">fminf</span>(minVx, v.<span class="built_in">getX</span>());</span><br><span class="line">				minVy = std::<span class="built_in">fminf</span>(minVy, v.<span class="built_in">getY</span>());</span><br><span class="line">				minVz = std::<span class="built_in">fminf</span>(minVz, v.<span class="built_in">getZ</span>());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!line.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="string">&quot;vt &quot;</span>)) &#123;</span><br><span class="line">				iss &gt;&gt; trash;</span><br><span class="line">				iss &gt;&gt; trash;</span><br><span class="line">				<span class="type">float</span> u, v;</span><br><span class="line">				iss &gt;&gt; u;</span><br><span class="line">				iss &gt;&gt; v;</span><br><span class="line">				<span class="keyword">if</span> (u &gt; <span class="number">1.0f</span>) u -= std::<span class="built_in">floor</span>(u);</span><br><span class="line">				<span class="keyword">if</span> (v &gt; <span class="number">1.0f</span>) v -= std::<span class="built_in">floor</span>(v);</span><br><span class="line">				obj-&gt;vertexVec[vertexIndex].tex = &#123; u, v &#125;;</span><br><span class="line">				obj-&gt;vertexVec[vertexIndex].rhw = <span class="number">1.0f</span>;</span><br><span class="line">				vertexIndex++;</span><br><span class="line">				<span class="keyword">if</span> (vertexIndex == vertexCount)</span><br><span class="line">				&#123;</span><br><span class="line">					vertexIndex = <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!line.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="string">&quot;vn &quot;</span>)) &#123;</span><br><span class="line">				iss &gt;&gt; trash;</span><br><span class="line">				iss &gt;&gt; trash;</span><br><span class="line">				<span class="type">float</span> x, y, z;</span><br><span class="line">				iss &gt;&gt; x;</span><br><span class="line">				iss &gt;&gt; y;</span><br><span class="line">				iss &gt;&gt; z;</span><br><span class="line">				obj-&gt;vertexVec[vertexIndex].normal = <span class="built_in">Vector4</span>(x, y, z, <span class="number">0.f</span>);</span><br><span class="line">				vertexIndex++;</span><br><span class="line">				<span class="keyword">if</span> (vertexIndex == vertexCount)</span><br><span class="line">				&#123;</span><br><span class="line">					vertexIndex = <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!line.<span class="built_in">compare</span>(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&quot;f &quot;</span>)) &#123;</span><br><span class="line">				std::vector&lt;<span class="type">int</span>&gt; v;</span><br><span class="line">				std::vector&lt;<span class="type">int</span>&gt; t;</span><br><span class="line">				std::vector&lt;<span class="type">int</span>&gt; n;</span><br><span class="line">				<span class="type">int</span> vx, vy, vz;</span><br><span class="line">				<span class="type">int</span> tx, ty, tz;</span><br><span class="line">				<span class="type">int</span> nx, ny, nz;</span><br><span class="line"></span><br><span class="line">				iss &gt;&gt; trash;</span><br><span class="line">				iss &gt;&gt; vx &gt;&gt; trash &gt;&gt; tx &gt;&gt; trash &gt;&gt; nx &gt;&gt;</span><br><span class="line">					vy &gt;&gt; trash &gt;&gt; ty &gt;&gt; trash &gt;&gt; ny &gt;&gt;</span><br><span class="line">					vz &gt;&gt; trash &gt;&gt; tz &gt;&gt; trash &gt;&gt; nz;</span><br><span class="line"></span><br><span class="line">				VerticeIndex indexes;</span><br><span class="line">				<span class="keyword">if</span> (MODEL_PATH == <span class="string">&quot;assets/Tonny.obj&quot;</span>) &#123;</span><br><span class="line">					indexes = &#123; vx , vy, vz &#125;;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					indexes = &#123; vz , vy, vx &#125;;  <span class="comment">// some obj files&#x27;s vertex order is different (For Back Culling Correctly) </span></span><br><span class="line">				&#125;</span><br><span class="line">				obj-&gt;verteciesIndexVec.<span class="built_in">push_back</span>(indexes);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		Vector4 center = <span class="built_in">Vector4</span>((maxVx + minVx) / <span class="number">2</span>, (maxVy + minVy) / <span class="number">2</span>, (maxVz + minVz) / <span class="number">2</span>, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">		in.<span class="built_in">close</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;No such file or path named \&#x27;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&#x27; !&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>By now, we have prepared a model data well. As you can see that the application stage is conducted in CPU, the programmer has the full control on every step and operation happened in this stage. You can try to reduce the count of the triangle during this stage in order to render it fast in the next stage, but the cost is obvious that the detail may lose. The CPU will send the data(model data which combined with vertices, vertices which includes positions, normals and texture coordinates) we stored into the hardware for the stage.</p>
<br>
<br>
<br>
<br>
<br>

<br>
<br>

<h3 id="2-Geometry-Stage"><a href="#2-Geometry-Stage" class="headerlink" title="2. Geometry Stage"></a>2. Geometry Stage</h3><p>The model data prepared and sent from the application stage will be used as the input content for geometry stage. <strong>The main tasks of the geometry stage is to tranfer the vertices, do the clippings, shad lights, make projections and conduct screen mappings.</strong></p>
<p>First and foremost, in order to make the mathematical calculations more unified, I have to mention that I use radiant(0~Π→0~180°) while describing an Euler angle, and use 0~1 rather than 0~255 while describing a color value, and use ‘vector • matrix’(vector-on-the-right-side) rule. The matrix are in ‘row-first’ order. Left-hand coordinate is used while doing geometric transforms.</p>
<p>In this stage there is a very important process called ‘MVP Transformation’, which is actually the combination of the ‘Model Transform’(the process during which we transform the model into its own space to the world space), ‘View Transform’(the process during which we transform the model from the world space into the view space) and the ‘Projection Transform’(the process during which we make the projection to the models in view space and transform it into the projection space). Let’s take a look at the detailed process of the geometry stage step by step.</p>
<p>Firstly, we have to transfer the model from its own space into the world space, but what is a ‘world space’? The world space is actually a space that holds all of the models, formally: objects. It should be able to hold all the objects with universal rules. The rule is originated from the world coordinates, which means that the world coordinate itself is a universal rule to all of the objects that are being rendered in the world space. Once we have learnt the origin of the universal rules, we are able to describe it in math, and you will find that describing a coordinate is simple in mathematics. It is a common sense that the coordinates can be easily described via matrix. <strong>As we can use a unit vector to form the base of a vector space, every vector in the space can be expressed as the linear combination of unit vectors, we can use a unit matrix to form the base of a matrix space. This means that the world space coordinate should be a unit matrix, so as to hold all the other objects. Thus the world space is created. Generally, we regard a unit matrix as a world space matrix, a world space, a world coordinate.</strong> A unit matrix is shown below, which can represent the world matrix. We can use a 3x3 matrix to represent a 3D space, but we choose 4x4 matrix, why? Because the position of our vertex is constructed in 4 dimension, with ‘w’ which represents the homogeneous coordinate. And we know that the mathematical rule does not allow us make arithmetic operations between a 3x3 matrix and a vector4. Also, the homogeneous coordinate W is crucial in the next steps that we can not lose it, we have to store it so as to use it later. As we use 2 dimentional array to define a matrix, we have to be clear about the inner side of it. In computing, row-major order and column-major order are methods for storing multidimensional arrays in linear storage such as random access memory. The difference between the orders lies in which elements of an array are contiguous in memory. In row-major order, the consecutive elements of a row reside next to each other, whereas the same holds true for consecutive elements of a column in column-major order. While the terms allude to the rows and columns of a two-dimensional array, i.e. a matrix, the orders can be generalized to arrays of any dimension by noting that the terms row-major and column-major are equivalent to lexicographic and co-lexicographic orders, respectively. Data layout is critical for correctly passing arrays between programs written in different programming languages. It is also important for performance when traversing an array because modern CPUs process sequential data more efficiently than non-sequential data. This is primarily due to CPU caching which exploits spatial locality of reference. In addition, contiguous access makes it possible to use SIMD instructions that operate on vectors of data. In some media such as tape or NAND flash memory, accessing sequentially is orders of magnitude faster than non-sequential access. We cannot clearly see whether the world matrix shown below is in row-major order or in column-major order for it is a unit matrix and the transpose of a unit matrix is actually itself, but I have to mention that all the matrices defined in this book and used in the relevant final project is in row-major order.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WorldMatrix = &#123;</span><br><span class="line">                 &#123;1, 0, 0, 0&#125;</span><br><span class="line">                 &#123;0, 1, 0, 0&#125;</span><br><span class="line">                 &#123;0, 0, 1, 0&#125;</span><br><span class="line">                 &#123;0, 0, 0, 1&#125;</span><br><span class="line">              &#125;;</span><br></pre></td></tr></table></figure>


<p>Then we have to place our models into the world space. As we have stored the model in a vertex which contains the attribute of position in 4 dimentional vector type, we can just multiply each of the position vectors with the world space matrix, thus transforming the positions of the model from its own space into the world space.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(type:matrix4f)ModelInWorldSpace = (type:vector4)ModelVertices[n].position * (type:matrix4f)WorldMatrix</span><br></pre></td></tr></table></figure>


<p>Notice that all of the interactions on the object&#x2F;models come from user side is applied on the models&#x2F;objects in world space. This means that the rotation transform, scale transform and translation transform are conducted directly after we placed the models&#x2F;objects in the world space through world matrix. First we have to map the user interaction from screen to 3D space if needed, for example, it’s needed that we map the rotation angle from 2D screen into 3D virtual world space if we want the user interact directly through the 2D screen when changing the rotation of the models&#x2F;objects. Just multiplying the world matrix with the transform matrices will make the objects&#x2F;models transform in the way we want. But how to describe our transform for the objects&#x2F;models? Here are the details of the rotation matrix, scale matrix and transformation matrix that we should bear in mind:</p>
<p><em>Rotate by X-axis</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RotationXMatrix = &#123;</span><br><span class="line">                 &#123;1, 0,       0,      0&#125;</span><br><span class="line">                 &#123;0, cos(θ),  sin(θ), 0&#125;</span><br><span class="line">                 &#123;0, -sin(θ), cos(θ), 0&#125;</span><br><span class="line">                 &#123;0, 0,       0,      1&#125;</span><br><span class="line">              &#125;;</span><br></pre></td></tr></table></figure>

<p><em>Rotate by Y-axis</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RotationYMatrix = &#123;</span><br><span class="line">                 &#123;cos(θ),  0, -sin(θ), 0&#125;</span><br><span class="line">                 &#123;0,       1,  0,      0&#125;</span><br><span class="line">                 &#123;sin(θ),  0,  cos(θ), 0&#125;</span><br><span class="line">                 &#123;0,       0,  0,      1&#125;</span><br><span class="line">              &#125;;</span><br></pre></td></tr></table></figure>

<p><em>Rotate by Z-axis</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RotationZMatrix = &#123;</span><br><span class="line">                 &#123;cos(θ),  sin(θ), 0, 0&#125;</span><br><span class="line">                 &#123;-sin(θ), cos(θ), 0, 0&#125;</span><br><span class="line">                 &#123;sin(θ),  0,      1, 0&#125;</span><br><span class="line">                 &#123;0,       0,      0, 1&#125;</span><br><span class="line">              &#125;;</span><br></pre></td></tr></table></figure>

<p>The way to build out these matrices in C++ goes like the codes below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function">Matrix4f <span class="title">Matrix4f::getRotateXMatrix</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; thetaX)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Matrix4f rotateXMatrix;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> angle = <span class="built_in">RadToDegree</span>(thetaX);</span><br><span class="line"></span><br><span class="line">	rotateXMatrix.matrix[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1.0f</span>;</span><br><span class="line">	rotateXMatrix.matrix[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> cosine = (<span class="type">float</span>)<span class="built_in">cos</span>(angle);</span><br><span class="line">	<span class="type">float</span> sine = (<span class="type">float</span>)<span class="built_in">sin</span>(angle);</span><br><span class="line">	rotateXMatrix.matrix[<span class="number">1</span>][<span class="number">1</span>] = cosine;</span><br><span class="line">	rotateXMatrix.matrix[<span class="number">2</span>][<span class="number">2</span>] = cosine;</span><br><span class="line">	rotateXMatrix.matrix[<span class="number">1</span>][<span class="number">2</span>] = sine;</span><br><span class="line">	rotateXMatrix.matrix[<span class="number">2</span>][<span class="number">1</span>] = -sine;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rotateXMatrix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Matrix4f <span class="title">Matrix4f::getRotateYMatrix</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; thetaY)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Matrix4f rotateYMatrix;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> angle = <span class="built_in">RadToDegree</span>(thetaY);</span><br><span class="line"></span><br><span class="line">	rotateYMatrix.matrix[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">1.0f</span>;</span><br><span class="line">	rotateYMatrix.matrix[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> cosine = (<span class="type">float</span>)<span class="built_in">cos</span>(angle);</span><br><span class="line">	<span class="type">float</span> sine = (<span class="type">float</span>)<span class="built_in">sin</span>(angle);</span><br><span class="line">	rotateYMatrix.matrix[<span class="number">0</span>][<span class="number">0</span>] = cosine;</span><br><span class="line">	rotateYMatrix.matrix[<span class="number">2</span>][<span class="number">2</span>] = cosine;</span><br><span class="line">	rotateYMatrix.matrix[<span class="number">0</span>][<span class="number">2</span>] = -sine;</span><br><span class="line">	rotateYMatrix.matrix[<span class="number">2</span>][<span class="number">0</span>] = sine;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rotateYMatrix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Matrix4f <span class="title">Matrix4f::getRotateZMatrix</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; thetaZ)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Matrix4f rotateZMatrix;</span><br><span class="line"></span><br><span class="line">	rotateZMatrix.matrix[<span class="number">2</span>][<span class="number">2</span>] = <span class="number">1.0f</span>;</span><br><span class="line">	rotateZMatrix.matrix[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> angle = <span class="built_in">RadToDegree</span>(thetaZ);</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> cosine = (<span class="type">float</span>)<span class="built_in">cos</span>(angle);</span><br><span class="line">	<span class="type">float</span> sine = (<span class="type">float</span>)<span class="built_in">sin</span>(angle);</span><br><span class="line">	rotateZMatrix.matrix[<span class="number">0</span>][<span class="number">0</span>] = cosine;</span><br><span class="line">	rotateZMatrix.matrix[<span class="number">1</span>][<span class="number">1</span>] = cosine;</span><br><span class="line">	rotateZMatrix.matrix[<span class="number">0</span>][<span class="number">1</span>] = sine;</span><br><span class="line">	rotateZMatrix.matrix[<span class="number">1</span>][<span class="number">0</span>] = -sine;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rotateZMatrix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>But notice that the direct rotation via Euler angles on any objects&#x2F;models will cause <code>Gimbal Lock</code>. <strong>Gimbal lock is the loss of one degree of freedom in a three-dimensional, three-gimbal mechanism that occurs when the axes of two of the three gimbals are driven into a parallel configuration, “locking” the system into rotation in a degenerate two-dimensional space.</strong><br>The word lock is misleading: no gimbal is restrained. All three gimbals can still rotate freely about their respective axes of suspension. Nevertheless, because of the parallel orientation of two of the gimbals’ axes there is no gimbal available to accommodate rotation about one axis.</p>
<p><img src="/Blog/Blog/2022/03/18/CG-In-Practice/GimbalLockOccasions.png" alt="CG"></p>
<p align="center">
All together there are 6 parenting combinations to choose from. In each case gimbal lock occurs on the parent when the middle axis is rotated too far.
<!-- <img src="./GimbalLockOccasions.png"> -->
</p>


<p>The cause of gimbal lock is the representation of orientation in calculations as three axial rotations based on Euler angles. A potential solution therefore is to represent the orientation in some other way. This could be as a rotation matrix, a quaternion , or a similar orientation representation that treats the orientation as a value rather than three separate and related values. Given such a representation, the user stores the orientation as a value. To quantify angular changes produced by a transformation, the orientation change is expressed as a delta angle&#x2F;axis rotation. The resulting orientation must be re-normalized to prevent the accumulation of floating-point error in successive transformations. For matrices, re-normalizing the result requires converting the matrix into its nearest orthonormal representation. For quaternions, re-normalization requires performing quaternion normalization.</p>
<p>To avoid gimbal lock, we can use quaternion. <code>Quaternion is</code> a complex system in math.<br>In mathematics, the quaternion number system extends the complex numbers. Quaternions were first applied to mechanics in three-dimensional space. Hamilton defined a quaternion as the quotient of two directed lines in a three-dimensional space, or, equivalently, as the quotient of two vectors. Multiplication of quaternions is noncommunicative. Quaternions are used in pure mathematics, but also have practical uses in applied mathematics, particularly for calculations involving three-dimensional rotations, such as in three-dimensional computer graphics, computer vision, and crystallographic texture analysis. They can be used alongside other methods of rotation, such as Euler angles and rotation matrices, or as an alternative to them, depending on the application. It can avoid Gimbal Lock.</p>
<p>The detail of an angle’s quaternion is a matrix shown below:<br><em>Quaternion matrix to describe the rotation</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">StartPoint(x1, y1, z1, 1)</span><br><span class="line">EndPoint(x1, y1, z1, 1)</span><br><span class="line">EulerAngle&lt;StartPoint, EndPoint&gt; = θ</span><br><span class="line">Quaternion  </span><br><span class="line">    = (</span><br><span class="line">        (StartPoint ⊗ EndPoint).x,</span><br><span class="line">        (StartPoint ⊗ EndPoint).y,</span><br><span class="line">        (StartPoint ⊗ EndPoint).z,</span><br><span class="line">        (StartPoint • EndPoint), // ==&gt; cos(θ / 2)</span><br><span class="line">      )</span><br></pre></td></tr></table></figure>

<p>The Euler angle between start point and the end point: θ, can be inversely calculated out through a quaternion for test, and it is equal to 2*arccos(Quaternion.w) when being inverted.</p>
<p>Here is the detailed method to get quaternion in real code:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Vector4 <span class="title">GetQuaternion</span><span class="params">(<span class="type">const</span> Vector2 &amp; lastPointV2, <span class="type">const</span> Vector2 &amp; curPointV2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Vector4 result;</span><br><span class="line"></span><br><span class="line">	Vector3 lastPointV3;</span><br><span class="line">	Vector3 curPointV3;</span><br><span class="line">	<span class="built_in">ArcBallTransform</span>(lastPointV2, lastPointV3);</span><br><span class="line">	<span class="built_in">ArcBallTransform</span>(curPointV2, curPointV3);</span><br><span class="line"></span><br><span class="line">	Vector3 perp;</span><br><span class="line">	perp = lastPointV3 ^ curPointV3;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (perp.<span class="built_in">getLength</span>() &gt; EPSILON)</span><br><span class="line">	&#123;</span><br><span class="line">		result.<span class="built_in">setX</span>(perp.<span class="built_in">getX</span>());</span><br><span class="line">		result.<span class="built_in">setY</span>(perp.<span class="built_in">getY</span>());</span><br><span class="line">		result.<span class="built_in">setZ</span>(perp.<span class="built_in">getZ</span>());</span><br><span class="line">		<span class="comment">// w=cos(rotationAngle/2) ---&gt; formula</span></span><br><span class="line">		result.<span class="built_in">setW</span>(lastPointV3 * curPointV3);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		result.<span class="built_in">setX</span>(<span class="number">.0</span>f);</span><br><span class="line">		result.<span class="built_in">setY</span>(<span class="number">.0</span>f);</span><br><span class="line">		result.<span class="built_in">setZ</span>(<span class="number">.0</span>f);</span><br><span class="line">		result.<span class="built_in">setW</span>(<span class="number">.0</span>f);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">///std::cout &lt;&lt; &quot;rotated (in degree)&quot; &lt;&lt; RadToDegree(2 * acosf(result.getW())) &lt;&lt; std::endl;</span></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can see that the function above includes a function called <code>ArcBallTransform, which is a mathematical way to map the 2D point onto a 3D sphere, thus making it possible to describe the user&#39;s interaction from 2D screen to 3D virtual world space.</code> The detail of the arc ball transform goes like the code shown below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="type">float</span> <span class="title">GetKFactorForArcBall</span><span class="params">(<span class="type">const</span> <span class="type">float</span> para)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// mouse point ranges from [0, window_width - 1]</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1.f</span> / ((para - <span class="number">1.f</span>) * <span class="number">0.5f</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ArcBallTransform</span><span class="params">(<span class="type">const</span> Vector2&amp; pointOnScreen, Vector3&amp; pointOnSphere)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// convert width&amp;height to [-1,1], left-hand coordinate</span></span><br><span class="line">	<span class="function">Vector2 <span class="title">tempVec2</span><span class="params">((pointOnScreen.getX() * GetKFactorForArcBall(WINDOW_WIDTH)) - <span class="number">1.f</span>, (pointOnScreen.getY() * GetKFactorForArcBall(WINDOW_HEIGHT)) - <span class="number">1.f</span>)</span></span>;</span><br><span class="line">	<span class="comment">//Vector2 tempVec2((pointOnScreen.getX() * GetKFactorForArcBall(WINDOW_WIDTH)) - 1.f,1.f - (pointOnScreen.getY() * GetKFactorForArcBall(WINDOW_HEIGHT))); // left-hand coordinate</span></span><br><span class="line">	<span class="type">float</span> length = <span class="built_in">pow</span>(tempVec2.<span class="built_in">getX</span>(), <span class="number">2</span>) + <span class="built_in">pow</span>(tempVec2.<span class="built_in">getY</span>(), <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if it&#x27;s outside the ball</span></span><br><span class="line">	<span class="keyword">if</span> (length &gt; <span class="number">1.f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// scale to sphere</span></span><br><span class="line">		<span class="type">float</span> norm = <span class="number">-1.f</span> / <span class="built_in">sqrtf</span>(length);</span><br><span class="line"></span><br><span class="line">		pointOnSphere.<span class="built_in">setX</span>(tempVec2.<span class="built_in">getX</span>() * norm);</span><br><span class="line">		pointOnSphere.<span class="built_in">setY</span>(tempVec2.<span class="built_in">getY</span>() * norm);</span><br><span class="line">		pointOnSphere.<span class="built_in">setZ</span>(<span class="number">0.f</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// if it&#x27;s inside the ball</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		pointOnSphere.<span class="built_in">setX</span>(tempVec2.<span class="built_in">getX</span>());</span><br><span class="line">		pointOnSphere.<span class="built_in">setY</span>(tempVec2.<span class="built_in">getY</span>());</span><br><span class="line">		pointOnSphere.<span class="built_in">setZ</span>(<span class="built_in">sqrtf</span>(<span class="number">1.f</span> - length));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="type">float</span> <span class="title">GetArcAngleCosineValue</span><span class="params">(<span class="type">const</span> Vector3&amp; position, <span class="type">const</span> Vector3&amp; startPosition, <span class="type">const</span> Vector3&amp; endPosition)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> r = position.<span class="built_in">getZ</span>();</span><br><span class="line">	<span class="type">float</span> pointDistance = </span><br><span class="line">                           <span class="built_in">sqrtf</span>(</span><br><span class="line">                                 <span class="built_in">pow</span>((endPosition.<span class="built_in">getX</span>() - startPosition.<span class="built_in">getX</span>()), <span class="number">2</span>)</span><br><span class="line">                               + <span class="built_in">pow</span>((endPosition.<span class="built_in">getY</span>() - startPosition.<span class="built_in">getY</span>()), <span class="number">2</span>)</span><br><span class="line">                               + <span class="built_in">pow</span>((endPosition.<span class="built_in">getZ</span>() - startPosition.<span class="built_in">getZ</span>()), <span class="number">2</span>));</span><br><span class="line">	<span class="type">float</span> consAngle = (<span class="built_in">pow</span>(r, <span class="number">2</span>) + <span class="built_in">pow</span>(r, <span class="number">2</span>) - <span class="built_in">pow</span>(pointDistance, <span class="number">2</span>)) / (<span class="number">2</span> * r * r); <span class="comment">// cosine formula</span></span><br><span class="line">	<span class="keyword">return</span> consAngle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Changing the location(Translating the objects&#x2F;models) directly from the screen-side(eg: the user clicked to select an object and moved the mouse from one point on screen to the other just to make the selected object move as the mouse’s track) is also in the same way I have mentioned above, but is much easier than doing rotation via arc ball transform plus quaternion. Only the subtraction of the 2 points is needed without any complicated calculations. However, the selection of the object&#x2F;model in virtual 3D world space from 2D screen is a little bit hard for most of the fresh-hands for it demands some more bounding-box related algorithms and knowledge basis to achieve this.</p>
<p>Now here is the details of the translation transform matrix, through which we are able to translate an object from one place to another in a 3D world space:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TranslationMatrix = &#123;</span><br><span class="line">                 &#123;1, 0, 0, 0&#125;</span><br><span class="line">                 &#123;0, 1, 0, 0&#125;</span><br><span class="line">                 &#123;0, 0, 1, 0&#125;</span><br><span class="line">                 &#123;x, y, z, 1&#125;</span><br><span class="line">              &#125;;</span><br></pre></td></tr></table></figure>

<p>And here is the way to get the translation matrix in C++:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Matrix4f <span class="title">Matrix4f::getTranslateMatrix</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; x, <span class="type">const</span> <span class="type">float</span>&amp; y, <span class="type">const</span> <span class="type">float</span>&amp; z)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Matrix4f translationMatrix;</span><br><span class="line"></span><br><span class="line">	translationMatrix.matrix[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1.0f</span>;</span><br><span class="line">	translationMatrix.matrix[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">1.0f</span>;</span><br><span class="line">	translationMatrix.matrix[<span class="number">2</span>][<span class="number">2</span>] = <span class="number">1.0f</span>;</span><br><span class="line">	translationMatrix.matrix[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	translationMatrix.matrix[<span class="number">3</span>][<span class="number">0</span>] = x;</span><br><span class="line">	translationMatrix.matrix[<span class="number">3</span>][<span class="number">1</span>] = y;</span><br><span class="line">	translationMatrix.matrix[<span class="number">3</span>][<span class="number">2</span>] = z;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> translationMatrix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After the translation, we might need some ways to scale the models&#x2F;objects in 3D world space so that the things can be in the size we expected. Here is the detail of the scale matrix:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ScaleMatrix = &#123;</span><br><span class="line">                 &#123;x, 0, 0, 0&#125;</span><br><span class="line">                 &#123;0, y, 0, 0&#125;</span><br><span class="line">                 &#123;0, 0, z, 0&#125;</span><br><span class="line">                 &#123;0, 0, 0, 1&#125;</span><br><span class="line">              &#125;;</span><br></pre></td></tr></table></figure>

<p>Here are 2 ways to get the scale matrix in C++:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Matrix4f <span class="title">Matrix4f::getScaleMatrix</span><span class="params">(<span class="type">const</span> <span class="type">float</span>&amp; x, <span class="type">const</span> <span class="type">float</span>&amp; y, <span class="type">const</span> <span class="type">float</span>&amp; z)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Matrix4f scaleMatrix;</span><br><span class="line"></span><br><span class="line">	scaleMatrix.matrix[<span class="number">0</span>][<span class="number">0</span>] = x;</span><br><span class="line">	scaleMatrix.matrix[<span class="number">1</span>][<span class="number">1</span>] = y;</span><br><span class="line">	scaleMatrix.matrix[<span class="number">2</span>][<span class="number">2</span>] = z;</span><br><span class="line">	scaleMatrix.matrix[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>  scaleMatrix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Matrix4f <span class="title">Matrix4f::getScaleMatrix</span><span class="params">(<span class="type">const</span> Matrix4f &amp; matrixToScale, <span class="type">const</span> <span class="type">float</span> scaleFactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Matrix4f result;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">			result.matrix[i][j] = matrixToScale.matrix[i][j] * scaleFactor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>All the transforms in world space from either the user interaction or the preset automation is conducted through matrices. The vertices multiplies the world space matrix, translation matrix, scale matrix as well as rotation matrix, the order of multiplying with the scale matrix, translation matrix and rotation matrix can be various be they should always be on the right side of the multiplication when using the ‘vector • matrix’(vector-on-the-right-side) rule. Otherwise, the transpose of them is needed to carry out the transformations correctly.</p>
<p>The formula goes like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInWorldSpaceAfterScaling = ModelInWorldSpace * ScaleMatrix</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInWorldSpaceAfterRotation = ModelInWorldSpace * RotationMatrix</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInWorldSpaceAfterTranslation = ModelInWorldSpace * TranslationMatrix</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInWorldSpaceAfterTransform = ModelInWorldSpace * ScaleMatrix * RotationMatrix * TranslationMatrix</span><br></pre></td></tr></table></figure>


<br>

<p>The second step is to transform the model from the world space into the view space. In order to create a view space, we have to construct a camera first. The main functions of this camera is to shot the models in scene and send the rendering data onto screen so that we can see what’s happening in the virtual 3D world. You can either separate the camera out as a single class or just inject it into the one of the class you think injectable and appropriate.</p>
<p>Before constructing a camera, we should learn the main function that the camera has to do for us while rendering. To make it more specific, the camera can be regarded as our eyes in the virtual 3D world, and in this way you’re going to realize the first thing the camera have to solve: seeing the models. How to see those models in the scene? There should be some rules so that the view is in correct and non-distorted state. Here are some rules we have to consider: </p>
<ol>
<li>The up-axis of the camera <em>[In order to view the models&#x2F;objects correctly]</em>;</li>
<li>The position we are viewing the models from <em>[We have to keep a distance from the models we want to see so that we can see them]</em>; </li>
<li>The target of the camera that is shooting <em>[In oder to specify the shooting position]</em>;</li>
</ol>
<p>These three aspects are crucial for a camera to shoot the models or objects in a 3D space correctly, so we are going to build up a way to describe the way a camera shoots the scene. In computer graphics, we still use a matrix to describe the way, but there are 2 types of rule that the one is in left-hand coordinate while the other is in right-hand coordinate. Just use the one that you will not change in the future. In this book I use the left hand coordinate system in building up my camera matrix, which is called “LookAtMatrix” formally in the project. Let’s just take a look at the details of the view matrix we are going to use:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Matrix4f <span class="title">getLookAtMatrixForLeftHandCoordinate</span><span class="params">(Vector3 * eyePos, <span class="type">const</span> Vector3 * lookAt, <span class="type">const</span> Vector3 * up, Vector3 &amp; newCameraUpAxis)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		Vector3 zAxis = *lookAt - *eyePos;</span><br><span class="line">		zAxis.<span class="built_in">Normalize</span>();</span><br><span class="line">		Vector3 xAxis = *up ^ zAxis; <span class="comment">// cross product</span></span><br><span class="line">		xAxis.<span class="built_in">Normalize</span>();</span><br><span class="line">		Vector3 yAxis = zAxis ^ xAxis; <span class="comment">// cross product</span></span><br><span class="line">		newCameraUpAxis = yAxis; <span class="comment">// store the last up-axis for updating camera position</span></span><br><span class="line"></span><br><span class="line">		Matrix4f result;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/// when(major==raw) =&gt; do: below</span></span><br><span class="line">		result.matrix[<span class="number">0</span>][<span class="number">0</span>] = xAxis.<span class="built_in">getX</span>();</span><br><span class="line">		result.matrix[<span class="number">0</span>][<span class="number">1</span>] = yAxis.<span class="built_in">getX</span>();</span><br><span class="line">		result.matrix[<span class="number">0</span>][<span class="number">2</span>] = zAxis.<span class="built_in">getX</span>();</span><br><span class="line">		result.matrix[<span class="number">0</span>][<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">		result.matrix[<span class="number">1</span>][<span class="number">0</span>] = xAxis.<span class="built_in">getY</span>();</span><br><span class="line">		result.matrix[<span class="number">1</span>][<span class="number">1</span>] = yAxis.<span class="built_in">getY</span>();</span><br><span class="line">		result.matrix[<span class="number">1</span>][<span class="number">2</span>] = zAxis.<span class="built_in">getY</span>();</span><br><span class="line">		result.matrix[<span class="number">1</span>][<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">		result.matrix[<span class="number">2</span>][<span class="number">0</span>] = xAxis.<span class="built_in">getZ</span>();</span><br><span class="line">		result.matrix[<span class="number">2</span>][<span class="number">1</span>] = yAxis.<span class="built_in">getZ</span>();</span><br><span class="line">		result.matrix[<span class="number">2</span>][<span class="number">2</span>] = zAxis.<span class="built_in">getZ</span>();</span><br><span class="line">		result.matrix[<span class="number">2</span>][<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">		result.matrix[<span class="number">3</span>][<span class="number">0</span>] = -(xAxis * (*eyePos));</span><br><span class="line">		result.matrix[<span class="number">3</span>][<span class="number">1</span>] = -(yAxis * (*eyePos));</span><br><span class="line">		result.matrix[<span class="number">3</span>][<span class="number">2</span>] = -(zAxis * (*eyePos));</span><br><span class="line">		result.matrix[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		Matrix-Structure(</span></span><br><span class="line"><span class="comment">				xaxis.x,			yaxis.x,			zaxis.x,			0,</span></span><br><span class="line"><span class="comment">				xaxis.y,			yaxis.y,			zaxis.y,			0,</span></span><br><span class="line"><span class="comment">				xaxis.z,			yaxis.z,			zaxis.z,			0,</span></span><br><span class="line"><span class="comment">			   -xaxis.Dot(eyePos), -yaxis.Dot(eyePos), -zaxis.Dot(eyePos),  1</span></span><br><span class="line"><span class="comment">		);*/</span></span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>It’s just creating a virtual camera for shooting the virtual 3D world using matrix. Ones all the significant information is stored in the matrices, it will be so easy for us to apply them onto the models in the 3D world be rendered. The result of the matrix we gain via the function above is the origin of our view matrix. So we apply the matrix we gain by using the function above to an empty matrix to store our view matrix. Now you will realize that you can directly regard the view matrix as the ‘camera matrix’ or ‘eye matrix’, any transforms conducted onto the camera shall directly be conducted on the view matrix.</p>
<p>Now that we gained the view matrix singly by configuring the camera we are using in the virtual 3D world, we can transform the vertices from the world space into the view space just by updating the vertices in the world space through: <code>multiplying the vertex positions already in the world space with the view matrix</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInViewSpace = ModelInWorldSpace * ViewMatrix;</span><br></pre></td></tr></table></figure>

<p>Till now, we have successfully transformed the models from the world space into the view space, next step after this is the transform of the model from the view space into the projection space. In order to make the transform, we have to gain projection matrix first.</p>
<p>There are 2 kinds of projections in our life, the one is orthographic while the other is perspective.</p>
<p><strong>In the orthographic projection, the things we see will be shown in the shape based on its original geometric shape, non-distorted surfaces with all of the lines and points mathematically-ordered.</strong> For this reason, we use a cube to project the objects&#x2F;models in the view space, all the shapes are projected mathematically through a cube.</p>
<p><strong>In the perspective projection, the things we see will be shown in the shape based on its realistic shape we see in our real life. It seems ‘realistic’ just because of the fact that the human eyes see things in perspective view, the shapes of the objects in real life is distorted when it is being projected into our brains from our eyes: mastering the rule that “Everything looks small in the distance and big on the contrary”.</strong> For this reason, we use cone to project the objects&#x2F;models in the view space rather than a cube, all the shapes are projected from a point, also, the furthest objects will disappear and become as a point after the projection.</p>
<p>Since we have noticed the main difference of 2 types of projection, the question lingers: What elements are needed when acquiring the projection matrix?</p>
<p>As we use a geometry to make the projection process(using a cube to make the orthographic projection while using a cone to make the perspective projection), the properties of the geometry selected shall be the attributes we have to consider when making the projection. We store the projection space in a 4x4 matrix as we did for the world space and view space before. </p>
<p>A cube has its width, height and length. When projecting, it’s enough for us to build out an orthographic projection matrix using these 3 attributes. We use its length to represent the distance from <code>the nearest z-position</code>(zNear) to <code>the furthest z-position</code>(zFar). Any objects&#x2F;models outside this range will not be seen and should be clipped away so that they will not be rendered on screen. We usually set a small number, for example 0.2 as the nearest z-position while a bigger like 500 as the furthest z-position. Conus left can be 0 while the conus right should be the width of the cube, conus bottom can be 0 while the conus top should be the height of the cube. Here is the details of the orthographic matrix:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Matrix4f <span class="title">Matrix4f::getOrthographicMatrix</span><span class="params">(<span class="type">const</span> <span class="type">float</span> conusLeft, <span class="type">const</span> <span class="type">float</span> conusRight, <span class="type">const</span> <span class="type">float</span> conusBottom, <span class="type">const</span> <span class="type">float</span> conusTop, <span class="type">float</span> zNear, <span class="type">float</span> zFar)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Matrix4f orthographicMatrix;</span><br><span class="line">	<span class="comment">/// make z range : [0,1], left hand coordinate</span></span><br><span class="line">	orthographicMatrix.matrix[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">2.f</span> / (conusRight - conusLeft);</span><br><span class="line">	orthographicMatrix.matrix[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">2.f</span> / (conusTop - conusBottom);</span><br><span class="line">	orthographicMatrix.matrix[<span class="number">2</span>][<span class="number">2</span>] = <span class="number">1.f</span> / (zFar - zNear); <span class="comment">// in left hand coordinate</span></span><br><span class="line">	orthographicMatrix.matrix[<span class="number">3</span>][<span class="number">0</span>] = -(conusRight + conusLeft) / (conusRight - conusLeft);</span><br><span class="line">	orthographicMatrix.matrix[<span class="number">3</span>][<span class="number">1</span>] = -(conusTop + conusBottom) / (conusTop - conusBottom);</span><br><span class="line">	orthographicMatrix.matrix[<span class="number">3</span>][<span class="number">2</span>] = -zNear / (zFar - zNear);</span><br><span class="line">	orthographicMatrix.matrix[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">1.f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> orthographicMatrix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>A cone, however, is different from a cube, and it has not width or height. Apart form using its length to represent the distance from <code>the nearest z-position</code>(zNear) to <code>the furthest z-position</code>(zFar), we use its angle on roof to represent the viewing field, which is formally called: <code>field of view</code>. And there is another element we have to consider when building the perspective matrix, that is: <code>aspect ratio</code>, <strong>which is the ratio of the rendering view’s(or the image’s) width to its height, and is expressed with 2 numbers separated by a colon</strong>, such as 16:9. Its simple to gain the aspect ratio once we configured the target rendering height and width. In the final project accompanied with this book, I used 720 as window width and 576 as window height, which means the aspect ratio is 720:576. By now, we have all the important information gained from a cone to build out a perspective projection matrix, which represents the perspective projection space itself. Let’s take a look at the details of the perspective matrix below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Matrix4f <span class="title">Matrix4f::getPerspectiveMatrix</span><span class="params">(<span class="type">float</span> fovYOZ, <span class="type">float</span> aspectRatio, <span class="type">float</span> zNear, <span class="type">float</span> zFar)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	fovYOZ = <span class="built_in">DegreeToRad</span>(fovYOZ);</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> focalLength = <span class="number">1.f</span> / <span class="built_in">tanf</span>(fovYOZ / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	Matrix4f perspectiveMatrix;</span><br><span class="line"></span><br><span class="line">	perspectiveMatrix.matrix[<span class="number">0</span>][<span class="number">0</span>] = focalLength / aspectRatio;</span><br><span class="line">	perspectiveMatrix.matrix[<span class="number">1</span>][<span class="number">1</span>] = focalLength;</span><br><span class="line">	perspectiveMatrix.matrix[<span class="number">2</span>][<span class="number">2</span>] = zFar / (zFar - zNear); <span class="comment">// in left hand coordinate</span></span><br><span class="line">	perspectiveMatrix.matrix[<span class="number">3</span>][<span class="number">2</span>] = -(zFar * zNear) / (zFar - zNear);</span><br><span class="line">	perspectiveMatrix.matrix[<span class="number">2</span>][<span class="number">3</span>] = <span class="number">1.f</span>; <span class="comment">// in left hand coordinate</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> perspectiveMatrix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then the way to transform the vertices from the view space into the projection space is as easy as what we have done when transforming the vertices form the world space into the view space: multiplying the model information matrix in view space with one of the projection matrix we calculated above. The formula goes like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInProjectionSpace = ModelInViewSpace * ProjectionMatrix;</span><br></pre></td></tr></table></figure>

<p>Notice that we should choose one type of projection at a time so that we can view in relevant projection mode, so the exact formula in a frame goes like this:<br><em>When using perspective mode</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInPerspectiveProjectionSpace = ModelInViewSpace * PerspectiveProjectionMatrix;</span><br></pre></td></tr></table></figure>

<p><em>When using orthographic mode</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInOrthographicProjectionSpace = ModelInViewSpace * OrthographicProjectionMatrix;</span><br></pre></td></tr></table></figure>

<p>Till now we have successfully processed the MVP transform, here is the recitation of the <code>MVP transform in a nut shell</code>:</p>
<p><em>(matrices are all with type:matrix4f)</em><br><em>(positions are all with type:vector4)</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInWorldSpace = ModelVertices[n].position * WorldMatrix;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInViewSpace = ModelInWorldSpace * ViewMatrix;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModelInProjectionSpace = ModelInViewSpace * ProjectionMatrix;</span><br></pre></td></tr></table></figure>

<p>After we have transformed the vertices into the relevant projection space(perspective or orthographic), we have to make clippings. Clipping is a way to ignore the vertices that need not to be rendered in our visible area. In formula, <code>when a vertex is inside the frustum, its position in X-axis and Y-axis will lay among the range of [-w, w] while its position in Z-axis will be in the range of [0, w]</code>. So we can use this formula to check whether a vertex is inside the frustum. Here is the detail of the way to check whether a vertex is inside the CVV:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="type">bool</span> <span class="title">IsOutsideCVV</span><span class="params">(<span class="type">const</span> Vector4&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> x = v.<span class="built_in">getX</span>();</span><br><span class="line">	<span class="type">float</span> y = v.<span class="built_in">getY</span>();</span><br><span class="line">	<span class="type">float</span> z = v.<span class="built_in">getZ</span>();</span><br><span class="line">	<span class="type">float</span> w = v.<span class="built_in">getW</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (x &lt;= w &amp;&amp; x &gt;= -w &amp;&amp; y &lt;= w &amp;&amp; y &gt;= -w &amp;&amp; z &lt;= w &amp;&amp; z &gt;= <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>A similar step with clippings is <code>back culling</code>, which <code>is a way to ignore the back side of the model being rendered so that the rendering efficiency may be accelerated.</code> When culling the backside of the model being rendered in virtual 3D world space, the important thing is to figure out its normal. The normal is decided upon the rule of drawing triangle: if you draw a triangle by connecting the vertices clockwise, the back side of the model is pointed to the inner side to the screen, vice versa. We can easily figure out the normal based on the Right-hand Screw Rule, but in programming, we have to know the way to express the Right-hand Screw Rule: we make subtractions twice to take all the three points into consideration as well as pretending to screw from one point to the other, then we calculate the cross product of the first point with the second point(or the second with the third, as is shown using ‘way 2’ below, but the points must be in continuity so as to pretend the screwing correctly). This normalized cross-product result best describes the normal of three points — the triangle. The back side of a primitive is easily figured out in this way. Here is the detail of CVV-Clipping and back-culling in my simple project:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">Vector4 <span class="title">GetNormalVectorForBackCulling</span><span class="params">(<span class="type">const</span> Vector4&amp; p1, <span class="type">const</span> Vector4&amp; p2, <span class="type">const</span> Vector4&amp; p3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Vector4 s1, s2, pn;</span><br><span class="line">	s1 = p3 - p2;</span><br><span class="line">	s2 = p2 - p1;</span><br><span class="line">	pn = s1 ^ s2; <span class="comment">//way 1</span></span><br><span class="line">	<span class="comment">//Vector4 s3;  s3 = p1 - p3; pn = s2 ^ s3; //way 2</span></span><br><span class="line">	pn.<span class="built_in">Normalize</span>();</span><br><span class="line">	<span class="keyword">return</span> pn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="type">bool</span> <span class="title">ShouldCullBack</span><span class="params">(<span class="type">const</span> Vector4&amp; vec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// anti-clock wise culling</span></span><br><span class="line">	<span class="function">Vector4 <span class="title">v</span><span class="params">(<span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">1.f</span>, <span class="number">0.f</span>)</span></span>;</span><br><span class="line">	<span class="keyword">if</span> (v * vec &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">DrawTriangle</span><span class="params">(Vertex&amp; v1, Vertex&amp; v2, Vertex&amp; v3, <span class="type">const</span> Colour** texture)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Vector4 pos1AfterMVP, pos2AfterMVP, pos3AfterMVP;</span><br><span class="line"></span><br><span class="line">	Vector4 pos1TransformedToWorld, pos2TransformedToWorld, pos3TransformedToWorld;</span><br><span class="line">	m_transform-&gt;<span class="built_in">ModelToWorld</span>(pos1TransformedToWorld, v1.pos);</span><br><span class="line">	m_transform-&gt;<span class="built_in">ModelToWorld</span>(pos2TransformedToWorld, v2.pos);</span><br><span class="line">	m_transform-&gt;<span class="built_in">ModelToWorld</span>(pos3TransformedToWorld, v3.pos);</span><br><span class="line"></span><br><span class="line">	v1.posInWorldSpace = pos1TransformedToWorld;</span><br><span class="line">	v2.posInWorldSpace = pos2TransformedToWorld;</span><br><span class="line">	v3.posInWorldSpace = pos3TransformedToWorld;</span><br><span class="line"></span><br><span class="line">	Vector4 pos1InView, pos2InView, pos3InView;</span><br><span class="line">	<span class="built_in">Vector4DotMatrix4f</span>(pos1InView, pos1TransformedToWorld, m_transform-&gt;viewMatrix);</span><br><span class="line">	<span class="built_in">Vector4DotMatrix4f</span>(pos2InView, pos2TransformedToWorld, m_transform-&gt;viewMatrix);</span><br><span class="line">	<span class="built_in">Vector4DotMatrix4f</span>(pos3InView, pos3TransformedToWorld, m_transform-&gt;viewMatrix);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">Vector4DotMatrix4f</span>(pos1AfterMVP, pos1InView, m_transform-&gt;projectionMatrix);</span><br><span class="line">	<span class="built_in">Vector4DotMatrix4f</span>(pos2AfterMVP, pos2InView, m_transform-&gt;projectionMatrix);</span><br><span class="line">	<span class="built_in">Vector4DotMatrix4f</span>(pos3AfterMVP, pos3InView, m_transform-&gt;projectionMatrix);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	Vector4 transformedVertNormal1, transformedVertNormal2, transformedVertNormal3;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// CVV Clip here</span></span><br><span class="line">	<span class="keyword">if</span> (m_transform-&gt;<span class="built_in">IsOutsideCVV</span>(pos1AfterMVP)</span><br><span class="line">		&amp;&amp; m_transform-&gt;<span class="built_in">IsOutsideCVV</span>(pos2AfterMVP)</span><br><span class="line">		&amp;&amp; m_transform-&gt;<span class="built_in">IsOutsideCVV</span>(pos3AfterMVP)) <span class="keyword">return</span>; <span class="comment">//The clipping happens here! Just stop here to prevent points from next steps.</span></span><br><span class="line"></span><br><span class="line">	m_transform-&gt;<span class="built_in">ModelToWorld</span>(transformedVertNormal1, v1.normal);</span><br><span class="line">	m_transform-&gt;<span class="built_in">ModelToWorld</span>(transformedVertNormal2, v2.normal);</span><br><span class="line">	m_transform-&gt;<span class="built_in">ModelToWorld</span>(transformedVertNormal3, v3.normal);</span><br><span class="line"></span><br><span class="line">	Vector4 homogenizedVertPos1, homogenizedVertPos2, homogenizedVertPos3;</span><br><span class="line">	<span class="comment">/// Set projection transform ---&gt; To NDC</span></span><br><span class="line">	m_transform-&gt;<span class="built_in">Homogenize</span>(homogenizedVertPos1, pos1AfterMVP);</span><br><span class="line">	m_transform-&gt;<span class="built_in">Homogenize</span>(homogenizedVertPos2, pos2AfterMVP);</span><br><span class="line">	m_transform-&gt;<span class="built_in">Homogenize</span>(homogenizedVertPos3, pos3AfterMVP);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	Vector4 pn = <span class="built_in">GetNormalVectorForBackCulling</span>(homogenizedVertPos1, homogenizedVertPos2, homogenizedVertPos3);</span><br><span class="line">	<span class="keyword">if</span> (m_transform-&gt;<span class="built_in">ShouldCullBack</span>(pn)) <span class="keyword">return</span>; <span class="comment">//The culling happens here! Just stop here to prevent the points from rasterization stage.</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">       <span class="built_in">ScanLineDraw</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>You can see that the points are just prevented from being sent to the rasterization stage when we are culling the back. The points are prevented from going to the next steps when clipping also.</p>
<p>There is a step not mentioned above that we may do before making the projection(inside the MVP, before ‘P’): shading lights. <code>Shading lights is an operation conducted on textures of the models</code>. When shading the light, lots of algorithms is used. In the final project asides this book, I showed the way of computing light and shading the light in Lambert mode. Main formula of Lambert Lighting is :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I = Ia * Ka + Ip * Kd * (N·L)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I = Ia * Ka + Ip * Kd * cosTheta;</span><br></pre></td></tr></table></figure>


<p>The details of lighting are shown below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Light</span></span><br><span class="line">	&#123;</span><br><span class="line">		Vector3 direction;</span><br><span class="line">		Colour color;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">Light</span>(<span class="type">const</span> Vector3&amp; direction, <span class="type">const</span> Colour&amp; color) :<span class="built_in">direction</span>(direction), <span class="built_in">color</span>(color) &#123;&#125;</span><br><span class="line">		<span class="built_in">Light</span>(<span class="type">const</span> Colour&amp; color) : <span class="built_in">color</span>(color) &#123;&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">DirectionalLight</span> : <span class="keyword">public</span> Light &#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="comment">// important to know that the initializer should be initiated from parent</span></span><br><span class="line">		<span class="built_in">DirectionalLight</span>(<span class="type">const</span> Colour&amp; c, <span class="type">const</span> Vector3&amp; position, <span class="type">const</span> Vector3&amp; target, <span class="type">float</span> intensity)</span><br><span class="line">			:<span class="built_in">Light</span>(c), <span class="built_in">position</span>(position), <span class="built_in">targetPosition</span>(target), <span class="built_in">intensity</span>(intensity) &#123;&#125;</span><br><span class="line">		<span class="built_in">DirectionalLight</span>(<span class="type">const</span> Colour&amp; c, <span class="type">const</span> Vector3&amp; direction, <span class="type">float</span> intensity)</span><br><span class="line">			:<span class="built_in">Light</span>(Vector3::<span class="built_in">Normalize</span>(direction), c), <span class="built_in">intensity</span>(<span class="built_in">Clamp</span>(intensity, <span class="number">0.f</span>, <span class="number">1.f</span>)) &#123;&#125;</span><br><span class="line">		~<span class="built_in">DirectionalLight</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Global directional light using Lambert Shading </span></span><br><span class="line">		<span class="comment">// I = Ia * Ka + Ip * Kd * (N·L)</span></span><br><span class="line">		<span class="comment">// Ia * Ka --&gt; ambient light</span></span><br><span class="line">		<span class="comment">// back side will be totally black in the case of removing the ambient light</span></span><br><span class="line">		<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">LambertLightOn</span><span class="params">(Colour&amp; ambientColour, DirectionalLight* light, Vector3&amp; normalInWorldSpace, Colour&amp; vertexColor)</span></span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="comment">//float I, Ia, Ip, Kd, cosTheta;</span></span><br><span class="line">			<span class="type">float</span> Ia, Ip, Kd, cosTheta;</span><br><span class="line">			Ia = <span class="number">0.2f</span>; <span class="comment">//ambient light intensity</span></span><br><span class="line">			Ip = light-&gt;intensity; <span class="comment">//directional light intensity</span></span><br><span class="line">			Kd = <span class="number">1.f</span>; <span class="comment">//coefficients of directional light</span></span><br><span class="line">			light-&gt;direction.<span class="built_in">Normalize</span>();</span><br><span class="line">			normalInWorldSpace.<span class="built_in">Normalize</span>(); <span class="comment">// must be normalized!!!</span></span><br><span class="line">			cosTheta = light-&gt;direction * normalInWorldSpace; <span class="comment">// incident angel</span></span><br><span class="line">			cosTheta &gt; <span class="number">1.f</span> ? (cosTheta = <span class="number">1.f</span>) : (cosTheta &lt; <span class="number">0.f</span> ? cosTheta = <span class="number">0.f</span> : cosTheta = cosTheta);</span><br><span class="line">			<span class="comment">////Formula: I = Ia * Ka + Ip * Kd * cosTheta;</span></span><br><span class="line">			Colour result = ambientColour * (Ia * Kd) + light-&gt;color * (Ip * Kd * cosTheta);</span><br><span class="line">			<span class="comment">// clamp the colors&#x27; rgb value into valid range in case of bounding outside</span></span><br><span class="line">			<span class="keyword">if</span> (result.r &gt; <span class="number">1.f</span> || result.g &gt; <span class="number">1.f</span> || result.b &gt; <span class="number">1.f</span>)</span><br><span class="line">				result.r = result.g = result.b = <span class="number">1.f</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (result.r &lt; <span class="number">0.f</span> || result.g &lt; <span class="number">0.f</span> || result.b &lt; <span class="number">0.f</span>)</span><br><span class="line">				result.r = result.g = result.b = <span class="number">0.f</span>;</span><br><span class="line">			vertexColor = result;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">ComputeLighting</span><span class="params">(<span class="type">const</span> DirectionalLight&amp; light, <span class="type">const</span> Vector3&amp; P, <span class="type">const</span> Vector3&amp; N,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="type">const</span> Vector3&amp; eyePosition, <span class="type">const</span> <span class="type">float</span> shininess,</span></span></span><br><span class="line"><span class="params"><span class="function">			Colour&amp; diffuseResult, Colour&amp; specularResult, <span class="type">const</span> <span class="type">float</span> attenuate)</span></span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="comment">// calculate diffuse</span></span><br><span class="line">			Vector3 L = (light.position - P);</span><br><span class="line">			L.<span class="built_in">Normalize</span>();</span><br><span class="line">			<span class="type">float</span> diffuseLight = <span class="built_in">max</span>(N * L, <span class="number">0</span>); <span class="comment">// always get the bigger value to ignore the error case such as shading from the back side</span></span><br><span class="line">			diffuseResult = light.color * diffuseLight * attenuate;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// calculate reflection</span></span><br><span class="line">			Vector3 V = eyePosition - P;</span><br><span class="line">			V.<span class="built_in">Normalize</span>();</span><br><span class="line">			Vector3 H = L + V;</span><br><span class="line">			H.<span class="built_in">Normalize</span>();</span><br><span class="line">			<span class="type">float</span> specularLight = <span class="built_in">pow</span>(<span class="built_in">max</span>((N*H), <span class="number">0</span>), shininess);</span><br><span class="line">			<span class="keyword">if</span> (diffuseLight &lt;= <span class="number">0</span>) specularLight = <span class="number">0</span>;</span><br><span class="line">			specularResult = light.color * specularLight * attenuate;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		Vector3 targetPosition;</span><br><span class="line">		Vector3 position;</span><br><span class="line">		<span class="type">float</span> intensity;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// calculate the normal vector of the light in world space coordinate</span></span><br><span class="line">		<span class="function"><span class="keyword">inline</span> Vector3 <span class="title">DirectionInWorldSpace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			Vector3 direction;</span><br><span class="line">			direction = position - targetPosition;</span><br><span class="line">			direction.<span class="built_in">Normalize</span>();</span><br><span class="line">			<span class="keyword">return</span> direction;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>


<p>After the MVP transform and clippings, we know that the models state does not change at all, they are still in 3D state, but we have to see it on a 2D screen, so the screen mapping comes to help us transform the 3D vertices into the 2D screen. <code>Screen mapping is a technic that maps the 3D vertices to the 2D screen</code>. As is the codes shown above in function ‘DrawTriangle’, we simply call it <code>Homogenize: the way to transform the vertices from the projection space into the screen space</code>. Here is the detail of homogenizing a vertex: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="type">void</span> <span class="title">Homogenize</span><span class="params">(Vector4&amp; result, <span class="type">const</span> Vector4&amp; posInProjectionSpace)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (posInProjectionSpace.W == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">Vector4</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">float</span> rhw = <span class="number">1</span> / posInProjectionSpace.W;</span><br><span class="line">	result.X = (<span class="number">1</span> + posInProjectionSpace.X * rhw) * canvasWidth * <span class="number">0.5</span>; <span class="comment">// screen coordinate</span></span><br><span class="line">	result.Y = (<span class="number">1</span> - posInProjectionSpace.Y * rhw) * canvasHeight * <span class="number">0.5</span>; <span class="comment">//screen coordinate ---&gt; top down</span></span><br><span class="line">	result.Z = posInProjectionSpace.Z * rhw;</span><br><span class="line">	result.W = rhw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>After such a long process, with the pixels we have just gain, we are entering into the next stage: rasterization stage, where we conduct multiple operations on each pixel so that each of the frame — namely an image, formed of many pixels — rendered on screen is in ideal state.</p>
<br>
<br>
<br>

<h3 id="3-Rasterization-Stage"><a href="#3-Rasterization-Stage" class="headerlink" title="3. Rasterization Stage"></a>3. Rasterization Stage</h3><p>The vertices we gain in screen space during the geometry stage will be used for drawing the final image, formally: single frame, that we are able to see directly. </p>
<p>After the screen mapping, through which we transformed the vertices from projection space to the screen space, some of the processes is still needed to make out a single frame to be rendered, and these processes are conducted in rasterization stage. Actually, it is the rasterization stage that converts vector information (composed of shapes or primitives) into a raster image (composed of pixels) for the purpose of displaying real-time 3D graphics.</p>
<p>During rasterization, each primitive is converted into pixels, while interpolating per-vertex values across each primitive. Rasterization includes clipping vertices to the view frustum, performing a divide by z to provide perspective, mapping primitives to a 2D viewport, and determining how to invoke the pixel shader. While using a pixel shader is optional, the rasterizer stage always performs clipping, a perspective divide to transform the points into homogeneous space, and maps the vertices to the viewport.</p>
<p>The positions[type:Vector4(x,y,z,w)] in each vertices, coming into the rasterizer stage are assumed to be in homogeneous clip-space. In this coordinate space the X axis points right, Y points up and Z points away from camera.</p>
<p>You may disable rasterization by telling the pipeline there is no pixel shader, and disabling depth and stencil testing. While disabled, rasterization-related pipeline counters will not update. There is also a complete description of the rasterization rules. Rasterization rules define how vector data is mapped into raster data. The raster data is snapped to integer locations that are then culled and clipped (to draw the minimum number of pixels), and per-pixel attributes are interpolated (from per-vertex attributes) before being passed to a pixel shader. There are several types of rules, which depend on the type of primitive that is being mapped, as well as whether or not the data uses multi-sampling to reduce aliasing. More related topics is available <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/direct3d11/d3d10-graphics-programming-guide-rasterizer-stage-rules">online</a> and in this book we are just talking about the simple steps to create the usable pixels for rendering.</p>
<p>The vertices are placed in screen space after being clipped in projection space, but not formally, they are still in projection space de facto. Because we only clipped away the vertices outside the projected area, there are still vertices inside the projected area but outside the screen area. Different from the back culling, the vertices outside the screen area&#x2F;space, which is also called: the view frustum, need to be clipped away not only for the reason that they are useless for rendering, but the consideration of those vertices may explode our frame buffer. <code>Frame buffer is a container that stores all of the pixels going to be rendered on screen.</code> Its volume is screenHeight*screenWidth large, so by now you will realize the importance of clipping of the vertices outside the screen space. </p>
<p>The RHW is the reciprocal of the homogeneous (clip space) w coordinate of a vertex (e.g., 1&#x2F;w).<br>Recall that we must expand our 3D vectors to 4D vectors in order to be able to multiply them with 4x4 matrices (which we do because 4x4 matrices allow us to completely encode both rotational, translational, and scaling terms). In doing so we often set (or assume) the expanded fourth (w) component is 1 for model vertices, and the nature of the transforms we use to bring model-space vertices into world or view space doesn’t include any terms that alter the w component.<br>However, the typical perspective projection transformation often takes the follow general form which, when multiplied with a general view-space vertex vector (x,y,z,1), gives you a vector like (Ax, By, Cz + E, zD) — note that the resulting vertex has a w component that is proportional to the original input’s z component. Also note that the space you’re in after multiplication by this matrix is called clip space, because the nature of the transform has distorted the viewing frustum into a cuboid, the edges of which are much easier to perform clipping against.<br>After clipping, the graphics pipeline divided by the w component to scale things based on distance to give you the perspective effect. This division cannot be encoded in a matrix transform.<br>Now, division by w is the same as multiplication by the reciprocal of w, and the reason that you are required to give the reciprocal of the clip space w coordinate is probably a throwback to the time when division was significantly slower than multiplication. When you use pre-transformed vertices, the transformation from model to world to view to clip space is skipped, but the rest of the pipeline (division by w, conversion to window coordinates, and rasterization, obviously) must still happen. Since the projection transform was skipped, there is no basis for the pipeline to determine the w coordinate to divide by, so it asks you for it.</p>
<p>There are some interesting uses for the value, but for the most part people use pre-transformed vertices when doing 2D rendering, and in that case its most useful to set the RHW value to 1, which effectively causes the divide to be a no-op.</p>
<p>The detail of initiating the RHW is shown below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">VertexRHWInit</span><span class="params">(Vertex&amp; v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	v.rhw = <span class="number">1</span> / v.pos.W;</span><br><span class="line">	v.tex.u *= v.rhw;</span><br><span class="line">	v.tex.v *= v.rhw;</span><br><span class="line">	v.normal.X = v.normal.X * v.rhw;</span><br><span class="line">	v.normal.Y = v.normal.Y * v.rhw;</span><br><span class="line">	v.normal.Z = v.normal.Z * v.rhw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are lots of ways to draw triangles when we have pixels in hand. Each of the way has its pros and cons and we have to choose the correct one to use. BUt in the final project, I provided multiple choices for learning. For example, you can use <code>Point-by-Point Comparison Method</code> to draw a line, it has its costs on performance but also has it advantage on some tiny models which ought to be rendered precisely. And, we can easily put some effects on each of the vertices when drawing the points. Here is the detail of the ‘Point-by-Point Comparison Method’:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="type">void</span> <span class="title">DrawPoint</span><span class="params">(<span class="type">const</span> Vector4&amp; p, <span class="type">const</span> Colour&amp; color, <span class="type">const</span> Texcoord&amp; tc, <span class="type">const</span> Vector3&amp; normal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> y = (<span class="type">int</span>)p.<span class="built_in">getY</span>();</span><br><span class="line">	<span class="type">int</span> x = (<span class="type">int</span>)p.<span class="built_in">getX</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (y &lt; <span class="number">0</span> || y &gt;= m_height) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span> (x &lt; <span class="number">0</span> || x &gt;= m_width) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span>&amp; z = m_zbuffer[y * m_width + x];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (z &lt; p.<span class="built_in">getZ</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> fcolor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> s = <span class="built_in">GetState</span>(m_state);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (s &amp; STATE_DRAW_COLOR)</span><br><span class="line">	&#123;</span><br><span class="line">		fcolor = <span class="built_in">GetHEXColor</span>(color);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Colour textureColor;</span><br><span class="line">		<span class="keyword">if</span> (s &amp; STATE_DRAW_TEX) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (m_interp == INTERP_NONE) &#123;</span><br><span class="line">				<span class="type">int</span> tx = (<span class="type">int</span>)<span class="built_in">roundf</span>((tc.u * (textureWidth - <span class="number">1</span>)));</span><br><span class="line">				<span class="type">int</span> ty = (<span class="type">int</span>)<span class="built_in">roundf</span>((tc.v * (textureHeight - <span class="number">1</span>)));</span><br><span class="line">				textureColor = pixelColorData[ty][tx];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				textureColor = <span class="built_in">BilinearInterp</span>(pixelColorData, textureWidth, textureHeight, tc.u, tc.v);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// default ambient light</span></span><br><span class="line">		<span class="function">Colour <span class="title">ambient</span><span class="params">(<span class="number">0.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>)</span></span>;</span><br><span class="line">		<span class="type">float</span> ambientIntensity = AMBIENT_INTENSITY;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// influence of ambient</span></span><br><span class="line">		ambient.r *= ambientIntensity * textureColor.r;</span><br><span class="line">		ambient.g *= ambientIntensity * textureColor.g;</span><br><span class="line">		ambient.b *= ambientIntensity * textureColor.b;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//fcolor = (int(ambient.r * 255) &lt;&lt; 16 | int(ambient.g * 255) &lt;&lt; 8 | int(ambient.b * 255));</span></span><br><span class="line">		fcolor = <span class="built_in">GetHEXColor</span>(<span class="built_in">Colour</span>(ambient.r, ambient.g, ambient.b)); <span class="comment">// simple functions of the code above</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m_framebuffer[y][x] = fcolor;</span><br><span class="line">	z = p.<span class="built_in">getZ</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here is the detail of the ‘Point-by-Point Comparison Method To Draw A Line’:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="comment">// Draw line via Point-by-Point Comparison Method</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawLine</span><span class="params">(<span class="type">const</span> Vector4&amp; p1, <span class="type">const</span> Vector4&amp; p2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Colour color = <span class="built_in">GetColorFromHEX</span>(m_foregroundColour);</span><br><span class="line"></span><br><span class="line">	Texcoord tex = &#123; <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">	<span class="function">Vector3 <span class="title">normal</span><span class="params">(<span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> x1, y1, x2, y2;</span><br><span class="line">	x1 = (<span class="type">int</span>)p1.<span class="built_in">getX</span>();</span><br><span class="line">	y1 = (<span class="type">int</span>)p1.<span class="built_in">getY</span>();</span><br><span class="line">	x2 = (<span class="type">int</span>)p2.<span class="built_in">getX</span>();</span><br><span class="line">	y2 = (<span class="type">int</span>)p2.<span class="built_in">getY</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> y, x;</span><br><span class="line">	y = p1.<span class="built_in">getY</span>();</span><br><span class="line">	x = p1.<span class="built_in">getX</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (x1 == x2 &amp;&amp; y1 == y2) &#123;</span><br><span class="line">		<span class="built_in">DrawPoint</span>(p1, color, tex, normal);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (x1 == x2) &#123;</span><br><span class="line">		<span class="built_in">DrawPoint</span>(p1, color, tex, normal);</span><br><span class="line">		<span class="type">int</span> increment = (y1 &lt; y2) ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">			y += increment;</span><br><span class="line">			<span class="keyword">if</span> (increment == <span class="number">1</span> &amp;&amp; y &gt;= y2) <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">if</span> (increment == <span class="number">-1</span> &amp;&amp; y &lt;= y2) <span class="keyword">break</span>;</span><br><span class="line">			<span class="function">Vector4 <span class="title">p</span><span class="params">(x, y, <span class="number">0.f</span>, <span class="number">1.f</span>)</span></span>;</span><br><span class="line">			<span class="built_in">DrawPoint</span>(p, color, tex, normal);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">DrawPoint</span>(p2, color, tex, normal);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (y1 == y2) &#123;</span><br><span class="line">		<span class="built_in">DrawPoint</span>(p1, color, tex, normal);</span><br><span class="line">		<span class="type">int</span> increment = (x1 &lt; x2) ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">			x += increment;</span><br><span class="line">			<span class="keyword">if</span> (increment == <span class="number">1</span> &amp;&amp; x &gt;= x2) <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">if</span> (increment == <span class="number">-1</span> &amp;&amp; x &lt;= x2) <span class="keyword">break</span>;</span><br><span class="line">			<span class="function">Vector4 <span class="title">p</span><span class="params">(x, y, <span class="number">0.f</span>, <span class="number">1.f</span>)</span></span>;</span><br><span class="line">			<span class="built_in">DrawPoint</span>(p, color, tex, normal);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">DrawPoint</span>(p2, color, tex, normal);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">DrawPoint</span>(p1, color, tex, normal);</span><br><span class="line">		<span class="type">float</span> t = (<span class="type">float</span>)<span class="built_in">abs</span>(x2 - x1) / <span class="built_in">abs</span>(y2 - y1);</span><br><span class="line">		<span class="type">int</span> xIncrement = (p1.<span class="built_in">getX</span>() &lt; p2.<span class="built_in">getX</span>()) ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">		<span class="type">int</span> yIncrement = (p1.<span class="built_in">getY</span>() &lt; p2.<span class="built_in">getY</span>()) ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">			y += yIncrement;</span><br><span class="line">			<span class="keyword">if</span> (yIncrement == <span class="number">1</span> &amp;&amp; y &gt;= y2) <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">if</span> (yIncrement == <span class="number">-1</span> &amp;&amp; y &lt;= y2) <span class="keyword">break</span>;</span><br><span class="line">			x += t * xIncrement;</span><br><span class="line">			<span class="function">Vector4 <span class="title">p</span><span class="params">(x, y, <span class="number">0.f</span>, <span class="number">1.f</span>)</span></span>;</span><br><span class="line">			<span class="built_in">DrawPoint</span>(p, color, tex, normal);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">DrawPoint</span>(p2, color, tex, normal);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>You can also choose another ways to draw line. In the final project, I separated the conduction on the pixel in the way below: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="type">void</span> <span class="title">DrawPixel</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">unsigned</span> <span class="type">int</span> hexColor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((x &lt; m_width) &amp;&amp; ((y &lt; m_height)) &amp;&amp; ((x &gt;= <span class="number">0</span>)) &amp;&amp; ((y &gt;= <span class="number">0</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		m_framebuffer[y][x] = hexColor;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawPixel</span><span class="params">(<span class="type">const</span> Vector2 &amp; point, <span class="type">unsigned</span> <span class="type">int</span> hexColor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> x = (<span class="type">int</span>)point.<span class="built_in">getX</span>();</span><br><span class="line">	<span class="type">int</span> y = (<span class="type">int</span>)point.<span class="built_in">getY</span>();</span><br><span class="line">	<span class="built_in">DrawPixel</span>(x, y, hexColor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawPixel</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">const</span> Colour &amp; color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((x &lt; m_width) &amp;&amp; ((y &lt; m_height))</span><br><span class="line">		&amp;&amp; ((x &gt;= <span class="number">0</span>)) &amp;&amp; ((y &gt;= <span class="number">0</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		m_framebuffer[y][x] = <span class="built_in">GetHEXColor</span>(color);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawPixel</span><span class="params">(<span class="type">const</span> Vector2 &amp; point, <span class="type">const</span> Colour &amp; color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> x = (<span class="type">int</span>)point.<span class="built_in">getX</span>();</span><br><span class="line">	<span class="type">int</span> y = (<span class="type">int</span>)point.<span class="built_in">getY</span>();</span><br><span class="line">	<span class="built_in">DrawPixel</span>(x, y, color);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Besides this way, you can use <code>Bresenhem Way</code> to draw the line, here are the details:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="type">void</span> <span class="title">DrawBresenhemLine</span><span class="params">(<span class="type">const</span> Vector4 &amp; startPoint, <span class="type">const</span> Vector4 &amp; endPoint)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (startPoint == endPoint)	<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> x0 = (<span class="type">int</span>)startPoint.<span class="built_in">getX</span>();</span><br><span class="line">	<span class="type">int</span> y0 = (<span class="type">int</span>)startPoint.<span class="built_in">getY</span>();</span><br><span class="line">	<span class="type">int</span> x1 = (<span class="type">int</span>)endPoint.<span class="built_in">getX</span>();</span><br><span class="line">	<span class="type">int</span> y1 = (<span class="type">int</span>)endPoint.<span class="built_in">getY</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> steep = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (std::<span class="built_in">abs</span>(x0 - x1) &lt; std::<span class="built_in">abs</span>(y0 - y1))</span><br><span class="line">	&#123;</span><br><span class="line">		std::<span class="built_in">swap</span>(x0, y0);</span><br><span class="line">		std::<span class="built_in">swap</span>(x1, y1);</span><br><span class="line">		steep = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (x0 &gt; x1)</span><br><span class="line">	&#123;</span><br><span class="line">		std::<span class="built_in">swap</span>(x0, x1);</span><br><span class="line">		std::<span class="built_in">swap</span>(y0, y1);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> dx = x1 - x0;</span><br><span class="line">	<span class="type">int</span> dy = y1 - y0;</span><br><span class="line">	<span class="type">int</span> derror2 = std::<span class="built_in">abs</span>(dy) * <span class="number">2</span>;</span><br><span class="line">	<span class="type">int</span> error2 = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> y = y0;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> x = x0; x &lt;= x1; ++x) &#123;</span><br><span class="line">		<span class="keyword">if</span> (steep) &#123;</span><br><span class="line">			<span class="function">Colour <span class="title">co</span><span class="params">(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>)</span></span>;</span><br><span class="line">			<span class="comment">//DrawPixel(y, x, GetColorIntensity(co)); // way 1</span></span><br><span class="line">			<span class="function">Vector4 <span class="title">p</span><span class="params">((<span class="type">float</span>)y, (<span class="type">float</span>)x, <span class="number">0.f</span>, <span class="number">0.f</span>)</span></span>;</span><br><span class="line">			<span class="built_in">DrawPoint</span>(p, co); <span class="comment">// way 2</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			Colour <span class="built_in">co</span>(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>);</span><br><span class="line">			<span class="comment">//DrawPixel(x, y, GetColorIntensity(co)); // way 1</span></span><br><span class="line">			<span class="function">Vector4 <span class="title">p</span><span class="params">((<span class="type">float</span>)x, (<span class="type">float</span>)y, <span class="number">0.f</span>, <span class="number">0.f</span>)</span></span>;</span><br><span class="line">			<span class="built_in">DrawPoint</span>(p, co); <span class="comment">// way 2</span></span><br><span class="line">		&#125;</span><br><span class="line">		error2 += derror2;</span><br><span class="line">		<span class="keyword">if</span> (error2 &gt; dx) &#123;</span><br><span class="line">			y += (y1 &gt; y0 ? <span class="number">1</span> : <span class="number">-1</span>);</span><br><span class="line">			error2 -= dx * <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The way to draw line in Bresenhem way shown above can even be optimized to the codes below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawBresenhemLineInUnoptimizedWay</span><span class="params">(<span class="type">const</span> Vector4 &amp; startPoint, <span class="type">const</span> Vector4 &amp; endPoint)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (startPoint == endPoint)	<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> x1 = startPoint.<span class="built_in">getX</span>();</span><br><span class="line">	<span class="type">float</span> y1 = startPoint.<span class="built_in">getY</span>();</span><br><span class="line">	<span class="type">float</span> x2 = endPoint.<span class="built_in">getX</span>();</span><br><span class="line">	<span class="type">float</span> y2 = endPoint.<span class="built_in">getY</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> xTemp, yTemp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*1：Draw the line segment with no slope.*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (x1 == x2)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// avoid oversteping the boundary of visual plane</span></span><br><span class="line">		<span class="keyword">if</span> (x1 &gt; m_width || x1 &lt; <span class="number">0</span>)	<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (y1 &gt; y2)</span><br><span class="line">		&#123;</span><br><span class="line">			yTemp = y1;</span><br><span class="line">			y1 = y2;</span><br><span class="line">			y2 = yTemp;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">float</span> y = y1; y &lt; y2&amp;&amp;y &lt; m_height&amp;&amp; y &gt;= <span class="number">0</span>; ++y)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">DrawPixel</span>(<span class="built_in">Vector2</span>(x1, y), <span class="built_in">Colour</span>(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*2：Draw the line segment with no slope.*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// stipulate X1&lt;X2, otherwise, swap them</span></span><br><span class="line">	<span class="keyword">if</span> (x1 &gt; x2)</span><br><span class="line">	&#123;</span><br><span class="line">		xTemp = x1;</span><br><span class="line">		x1 = x2;</span><br><span class="line">		x2 = xTemp;</span><br><span class="line"></span><br><span class="line">		yTemp = y1;</span><br><span class="line">		y1 = y2;</span><br><span class="line">		y2 = yTemp;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> k = (y2 - y1) / (x2 - x1);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1：as the gradient factor is less than 1 or bigger than 0</span></span><br><span class="line">	<span class="keyword">if</span> (k &gt;= <span class="number">0.0f</span>&amp;&amp;k &lt;= <span class="number">1.f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// draw pixel crosswise from x1 to x2 with attention of limiting inside window width</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">float</span> x = x1, y = y1; x &lt;= x2 &amp;&amp; x &gt;= <span class="number">0</span> &amp;&amp; x &lt; m_width; ++x)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">float</span> dis = (x - x1) * k + y1 - y;</span><br><span class="line">			<span class="keyword">if</span> (dis &gt;= <span class="number">0.5</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				++y;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">DrawPixel</span>(<span class="built_in">Vector2</span>(x, y), <span class="built_in">Colour</span>(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2：as the gradient factor is less than 0 or bigger than -1</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (k &lt; <span class="number">0.0f</span>&amp;&amp;k &gt;= <span class="number">-1.f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">float</span> x = x1, y = y1; x &lt;= x2 &amp;&amp; x &gt;= <span class="number">0</span> &amp;&amp; x &lt; m_width; ++x)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">float</span> dis = (x - x1)*k + y1 - y;</span><br><span class="line">			<span class="keyword">if</span> (dis &lt; <span class="number">-0.5</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				--y;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">DrawPixel</span>(<span class="built_in">Vector2</span>(x, y), <span class="built_in">Colour</span>(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3：as the gradient factor is bigger than -1</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (k &gt; <span class="number">1.f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">float</span> k1 = <span class="number">1.f</span> / k;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">float</span> y = y1, x = x1; y &lt;= y2 &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; y &lt; m_height; ++y)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">float</span> dis = (y - y1)*k1 + x1 - x;</span><br><span class="line">			<span class="keyword">if</span> (dis &gt;= <span class="number">0.5</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				++x;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">DrawPixel</span>(<span class="built_in">Vector2</span>(x, y), <span class="built_in">Colour</span>(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4：as the gradient factor is less than -1</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (k &lt; <span class="number">-1.f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">float</span> k1 = <span class="number">1.f</span> / k;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">float</span> y = y2, x = x2; y &lt;= y1 &amp;&amp; y &lt; m_height &amp;&amp; y &gt;= <span class="number">0</span>; ++y)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">float</span> dis = (y - y2)*k1 + x2 - x;</span><br><span class="line">			<span class="keyword">if</span> (dis &lt;= <span class="number">-0.5</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				--x;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">DrawPixel</span>(<span class="built_in">Vector2</span>(x, y), <span class="built_in">Colour</span>(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Once we are able to draw lines, we are able to draw triangles, too. By calling the method of drawing lines three times can we build out a triangle we want:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//           startPoint,            endPoint</span></span><br><span class="line">   <span class="built_in">DrawLine</span>(homogenizedVertPos1, homogenizedVertPos2);</span><br><span class="line"><span class="built_in">DrawLine</span>(homogenizedVertPos1, homogenizedVertPos3);</span><br><span class="line"><span class="built_in">DrawLine</span>(homogenizedVertPos2, homogenizedVertPos3);</span><br></pre></td></tr></table></figure>

<br>

<p>Apart from this, we can use <code>Scan-line Way</code> to <strong>rasterize triangles on screen</strong>, which is <strong>the core of our rendering</strong>. The detail of the scan-line way is shown below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScanlineFill</span><span class="params">(<span class="type">const</span> Vertex &amp; leftPoint, <span class="type">const</span>  Vertex &amp; rightPoint, <span class="type">const</span> <span class="type">int</span> yIndex, <span class="type">const</span> Colour** texture)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">float</span> lineWidth = rightPoint.pos.<span class="built_in">getX</span>() - leftPoint.pos.<span class="built_in">getX</span>();</span><br><span class="line">	<span class="type">float</span> step = <span class="number">1.f</span>;</span><br><span class="line">	<span class="keyword">if</span> (lineWidth &gt; <span class="number">0.f</span>) step = <span class="number">1.f</span> / lineWidth;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">float</span> x = leftPoint.pos.<span class="built_in">getX</span>(); x &lt;= rightPoint.pos.<span class="built_in">getX</span>(); x++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">int</span> xIndex = (<span class="type">int</span>)(x + <span class="number">0.5f</span>);</span><br><span class="line">		<span class="type">float</span> lerpFactor = (x - leftPoint.pos.<span class="built_in">getX</span>()) / lineWidth;</span><br><span class="line">		<span class="type">float</span> zValue = <span class="built_in">Lerp</span>(leftPoint.pos.<span class="built_in">getZ</span>(), rightPoint.pos.<span class="built_in">getZ</span>(), lerpFactor);</span><br><span class="line">		<span class="keyword">if</span> (xIndex &gt;= <span class="number">0</span> &amp;&amp; xIndex &lt; m_width &amp;&amp; zValue &gt; <span class="number">0.f</span> &amp;&amp; zValue &lt; <span class="number">1.f</span>) <span class="comment">// clip again</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">float</span> rhwTemp = <span class="built_in">Lerp</span>(leftPoint.rhw, rightPoint.rhw, lerpFactor);</span><br><span class="line"></span><br><span class="line">			<span class="type">float</span>&amp; zInBuffer = m_zbuffer[yIndex * m_width + xIndex];</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (zValue &lt; zInBuffer)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Perpective correction! ---&gt; useless in orthographic mode</span></span><br><span class="line">				<span class="type">float</span> w = <span class="number">1.f</span> / rhwTemp;</span><br><span class="line"></span><br><span class="line">				zInBuffer = zValue; <span class="comment">// write into z-buffer</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">// uv interpolation to get the texture color (multiplies w to gain perspective correction of uv-texcture)</span></span><br><span class="line">				<span class="type">float</span> u = <span class="built_in">Lerp</span>(leftPoint.tex.u, rightPoint.tex.u, lerpFactor) * w * (textureWidth - <span class="number">1</span>);</span><br><span class="line">				<span class="type">float</span> v = <span class="built_in">Lerp</span>(leftPoint.tex.v, rightPoint.tex.v, lerpFactor) * w * (textureHeight - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">				<span class="type">int</span> uIndex = (<span class="type">int</span>)(u + <span class="number">0.5f</span>); <span class="comment">// maybe this is more effective than (int)roundf(fNum) </span></span><br><span class="line">				<span class="type">int</span> vIndex = (<span class="type">int</span>)(v + <span class="number">0.5f</span>);</span><br><span class="line"></span><br><span class="line">				<span class="function">Colour <span class="title">vertexColor</span><span class="params">(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (uIndex &lt;= textureWidth - <span class="number">1</span> &amp;&amp; uIndex &gt;= <span class="number">0</span></span><br><span class="line">					&amp;&amp; vIndex &lt;= textureHeight - <span class="number">1</span> &amp;&amp; vIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (mLightOn)</span><br><span class="line">						vertexColor = <span class="built_in">Lerp</span>(leftPoint.color, rightPoint.color, lerpFactor);</span><br><span class="line"></span><br><span class="line">					Colour texColor;</span><br><span class="line">					<span class="keyword">if</span> (m_interp == INTERP_BILINEAR) &#123;</span><br><span class="line">						Colour** m_texture = (Colour**)texture;</span><br><span class="line">						texColor = <span class="built_in">BilinearInterp</span>(m_texture, textureWidth, textureHeight, u, v);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						texColor = texture[uIndex][vIndex];</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="type">float</span> xHere = <span class="built_in">Lerp</span>(leftPoint.posInWorldSpace.<span class="built_in">getX</span>(), rightPoint.posInWorldSpace.<span class="built_in">getX</span>(), lerpFactor);</span><br><span class="line">					<span class="type">float</span> yHere = <span class="built_in">Lerp</span>(leftPoint.posInWorldSpace.<span class="built_in">getY</span>(), rightPoint.posInWorldSpace.<span class="built_in">getY</span>(), lerpFactor);</span><br><span class="line">					<span class="type">float</span> zHere = <span class="built_in">Lerp</span>(leftPoint.posInWorldSpace.<span class="built_in">getZ</span>(), rightPoint.posInWorldSpace.<span class="built_in">getZ</span>(), lerpFactor);</span><br><span class="line">					posInWorldSpace = <span class="built_in">Vector4</span>(xHere, yHere, zHere, <span class="number">1.f</span>); <span class="comment">// For showing shadow of the models on the floor</span></span><br><span class="line"></span><br><span class="line">					<span class="built_in">Vector4DotMatrix4f</span>(lightScreenPosBeforsHomogenized, posInWorldSpace, lightSpaceMatrix);</span><br><span class="line">					m_transform-&gt;<span class="built_in">Homogenize</span>(posInLightScreen, lightScreenPosBeforsHomogenized);</span><br><span class="line"></span><br><span class="line">					<span class="type">int</span> hX = (<span class="type">int</span>)(posInLightScreen.<span class="built_in">getX</span>() + <span class="number">0.5f</span>);</span><br><span class="line">					<span class="type">int</span> hY = (<span class="type">int</span>)(posInLightScreen.<span class="built_in">getY</span>() + <span class="number">0.5f</span>);</span><br><span class="line"></span><br><span class="line">					<span class="type">float</span> bias = <span class="built_in">GetBiasDynamically</span>(biasDelta, rightPoint.normal, leftPoint.normal, lerpFactor);</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (hX &gt; <span class="number">0</span> &amp;&amp; hY &gt; <span class="number">0</span> &amp;&amp; hX &lt; m_width &amp;&amp; hY &lt; m_height) &#123;</span><br><span class="line">						<span class="keyword">if</span> (posInLightScreen.<span class="built_in">getZ</span>() - bias &gt; depthBufferFromLightPos[hY * m_width + hX])</span><br><span class="line">							texColor *= <span class="built_in">Colour</span>(<span class="number">0.3f</span>, <span class="number">0.3f</span>, <span class="number">0.3f</span>);</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					m_framebuffer[yIndex][xIndex] = <span class="built_in">GetHEXColor</span>(vertexColor * texColor);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>You can see that we conduct <code>Bilinear Interpolcation</code> in rasterization stage, its a way of avoiding the edges of the texture mapped on the models&#x2F;pbjects. The details of ‘Bilinear Interpolcation’ is shown below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Colour <span class="title">BilinearInterp</span><span class="params">(Colour** textureColorData, <span class="type">const</span> <span class="type">int</span> textureWidth, <span class="type">const</span> <span class="type">int</span> textureHeight, <span class="type">const</span> <span class="type">float</span> u, <span class="type">const</span> <span class="type">float</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//float y = u * textureHeight, x = v * textureWidth;</span></span><br><span class="line">	<span class="type">float</span> y = v, x = u;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> x0 = (<span class="type">int</span>)<span class="built_in">floorf</span>(x);</span><br><span class="line">	<span class="type">int</span> y0 = (<span class="type">int</span>)<span class="built_in">floorf</span>(y);</span><br><span class="line">	<span class="type">int</span> x1 = x0 + <span class="number">1</span>, y1 = y0 + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// border correction</span></span><br><span class="line">	<span class="keyword">if</span> (x0 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		x0 = <span class="number">0</span>;</span><br><span class="line">		x1 = <span class="number">1</span>;</span><br><span class="line">		x = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (y0 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		y0 = <span class="number">0</span>;</span><br><span class="line">		y1 = <span class="number">1</span>;</span><br><span class="line">		y = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (x1 &gt; textureWidth - <span class="number">1</span>) &#123;</span><br><span class="line">		x1 = textureWidth - <span class="number">1</span>;</span><br><span class="line">		x0 = textureWidth - <span class="number">2</span>;</span><br><span class="line">		x = (<span class="type">float</span>)textureWidth - <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (y1 &gt; textureHeight - <span class="number">1</span>) &#123;</span><br><span class="line">		y1 = textureHeight - <span class="number">1</span>;</span><br><span class="line">		y0 = textureHeight - <span class="number">2</span>;</span><br><span class="line">		y = (<span class="type">float</span>)textureHeight - <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> w00 = (<span class="type">float</span>)((y1 - y) * (x1 - x));</span><br><span class="line">	<span class="type">float</span> w01 = (<span class="type">float</span>)((y1 - y) * (x - x0));</span><br><span class="line">	<span class="type">float</span> w11 = (<span class="type">float</span>)((y - y0) * (x - x0));</span><br><span class="line">	<span class="type">float</span> w10 = (<span class="type">float</span>)((y - y0) * (x1 - x));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	Colour c00 = textureColorData[x0][y0];</span><br><span class="line">	Colour c01 = textureColorData[x1][y0];</span><br><span class="line">	Colour c10 = textureColorData[x0][y1];</span><br><span class="line">	Colour c11 = textureColorData[x1][y1];</span><br><span class="line"></span><br><span class="line">	Colour interpedResult00 = c00 * w00;</span><br><span class="line">	Colour interpedResult01 = c01 * w01;</span><br><span class="line">	Colour interpedResult10 = c10 * w10;</span><br><span class="line">	Colour interpedResult11 = c11 * w11;</span><br><span class="line"></span><br><span class="line">	Colour c = interpedResult00 + interpedResult01 + interpedResult10 + interpedResult11;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<br>

<p>When rasterizing, notice that the lerping is also needed in screen space for acquiring a correct pixel position on screen. More details of Lerping and resterizing triangles are shown below:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="function"><span class="type">float</span> <span class="title">Lerp</span><span class="params">(<span class="type">const</span> <span class="type">float</span> a, <span class="type">const</span> <span class="type">float</span> b, <span class="type">const</span> <span class="type">float</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (t &lt;= <span class="number">0.f</span>) <span class="keyword">return</span> a;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (t &gt;= <span class="number">1.f</span>) <span class="keyword">return</span> b;</span><br><span class="line">	<span class="keyword">else</span> <span class="built_in">return</span> (b - a) * t + a; <span class="comment">// optimized</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">Vector4 <span class="title">Lerp</span><span class="params">(<span class="type">const</span> Vector4 vecA, <span class="type">const</span> Vector4 vecB, <span class="type">const</span> <span class="type">float</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">Vector4 <span class="title">result</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		Lerp(vecA.getX(), vecB.getX(), t),</span></span></span><br><span class="line"><span class="params"><span class="function">		Lerp(vecA.getY(), vecB.getY(), t),</span></span></span><br><span class="line"><span class="params"><span class="function">		Lerp(vecA.getZ(), vecB.getZ(), t),</span></span></span><br><span class="line"><span class="params"><span class="function">		Lerp(vecA.getW(), vecB.getW(), t)</span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function">Vertex <span class="title">Lerp</span><span class="params">(<span class="type">const</span> Vertex vecA, <span class="type">const</span> Vertex  vecB, <span class="type">const</span> <span class="type">float</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Vertex result&#123;</span><br><span class="line">		<span class="built_in">Lerp</span>(vecA.pos, vecB.pos, t),</span><br><span class="line">		<span class="built_in">Lerp</span>(vecA.color, vecB.color, t),</span><br><span class="line">		<span class="built_in">Lerp</span>(vecA.tex.u, vecB.tex.u, t),</span><br><span class="line">		<span class="built_in">Lerp</span>(vecA.tex.v, vecB.tex.v, t),</span><br><span class="line">		<span class="built_in">Lerp</span>(vecA.normal, vecB.normal, t),</span><br><span class="line">		<span class="built_in">Lerp</span>(vecA.rhw, vecB.rhw, t),</span><br><span class="line">		<span class="built_in">Lerp</span>(vecA.posInWorldSpace, vecB.posInWorldSpace, t)</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line"><span class="function">Colour <span class="title">Lerp</span><span class="params">(<span class="type">const</span> Colour&amp; a, <span class="type">const</span> Colour&amp; b, <span class="type">float</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Colour result;</span><br><span class="line">	result.r = <span class="built_in">Lerp</span>(a.r, b.r, t);</span><br><span class="line">	result.g = <span class="built_in">Lerp</span>(a.g, b.g, t);</span><br><span class="line">	result.b = <span class="built_in">Lerp</span>(a.b, b.b, t);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LerpVertexInScreenSpace</span><span class="params">(Vertex &amp; v, <span class="type">const</span> Vertex &amp; v1, <span class="type">const</span> Vertex &amp; v2, <span class="type">float</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//optimized below ---&gt; using the inline Lerp functions rather than the one from Math.h</span></span><br><span class="line">	v.rhw = <span class="built_in">Lerp</span>(v1.rhw, v2.rhw, t);</span><br><span class="line">	v.tex.u = <span class="built_in">Lerp</span>(v1.tex.u, v2.tex.u, t);</span><br><span class="line">	v.tex.v = <span class="built_in">Lerp</span>(v1.tex.v, v2.tex.v, t);</span><br><span class="line">	v.color = <span class="built_in">Lerp</span>(v1.color, v2.color, t);</span><br><span class="line">	v.pos = <span class="built_in">Lerp</span>(v1.pos, v2.pos, t);</span><br><span class="line">	v.normal = <span class="built_in">Lerp</span>(v1.normal, v2.normal, t); <span class="comment">// comment this line to stay normal unchanged(in world space)</span></span><br><span class="line">	v.posInWorldSpace = <span class="built_in">Lerp</span>(v1.posInWorldSpace, v2.posInWorldSpace, t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">DrawTopTriangle</span><span class="params">(<span class="type">const</span> Vertex &amp; p1, <span class="type">const</span> Vertex &amp; p2, <span class="type">const</span> Vertex &amp; p3, <span class="type">const</span> Colour** texture)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">float</span> y = p1.pos.<span class="built_in">getY</span>(); y &lt;= p3.pos.<span class="built_in">getY</span>() &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; y &lt; m_height; y += <span class="number">0.5f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">int</span> yIndex = (<span class="type">int</span>)<span class="built_in">roundf</span>(y);</span><br><span class="line">		<span class="keyword">if</span> (yIndex &gt;= <span class="number">0</span> &amp;&amp; yIndex &lt; m_height)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">float</span> xl = (y - p1.pos.<span class="built_in">getY</span>()) * (p3.pos.<span class="built_in">getX</span>() - p1.pos.<span class="built_in">getX</span>()) / (p3.pos.<span class="built_in">getY</span>() - p1.pos.<span class="built_in">getY</span>()) + p1.pos.<span class="built_in">getX</span>();</span><br><span class="line">			<span class="type">float</span> x2 = (y - p2.pos.<span class="built_in">getY</span>()) * (p3.pos.<span class="built_in">getX</span>() - p2.pos.<span class="built_in">getX</span>()) / (p3.pos.<span class="built_in">getY</span>() - p2.pos.<span class="built_in">getY</span>()) + p2.pos.<span class="built_in">getX</span>();</span><br><span class="line"></span><br><span class="line">			<span class="type">float</span> dy = y - p1.pos.<span class="built_in">getY</span>();</span><br><span class="line">			<span class="type">float</span> t = dy / (p3.pos.<span class="built_in">getY</span>() - p1.pos.<span class="built_in">getY</span>());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// get the right and left point via interpolation</span></span><br><span class="line">			Vertex new1;</span><br><span class="line">			new1.pos.<span class="built_in">setX</span>(xl);</span><br><span class="line">			new1.pos.<span class="built_in">setY</span>(y);</span><br><span class="line">			<span class="built_in">LerpVertexInScreenSpace</span>(new1, p1, p3, t);</span><br><span class="line"></span><br><span class="line">			Vertex new2;</span><br><span class="line">			new2.pos.<span class="built_in">setX</span>(x2);</span><br><span class="line">			new2.pos.<span class="built_in">setY</span>(y);</span><br><span class="line">			<span class="built_in">LerpVertexInScreenSpace</span>(new2, p2, p3, t);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (new1.pos.<span class="built_in">getX</span>() &lt; new2.pos.<span class="built_in">getX</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ScanlineFill</span>(new1, new2, yIndex, texture);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ScanlineFill</span>(new2, new1, yIndex, texture);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DrawBottomTriangle</span><span class="params">(<span class="type">const</span> Vertex &amp; p1, <span class="type">const</span> Vertex &amp; p2, <span class="type">const</span> Vertex &amp; p3, <span class="type">const</span> Colour** texture)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">float</span> y = p1.pos.<span class="built_in">getY</span>(); y &lt;= p2.pos.<span class="built_in">getY</span>() &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; y &lt; m_height; y += <span class="number">0.5f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">int</span> yIndex = (<span class="type">int</span>)<span class="built_in">roundf</span>(y);</span><br><span class="line">		<span class="keyword">if</span> (yIndex &gt;= <span class="number">0</span> &amp;&amp; yIndex &lt; m_height)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">float</span> xl = (y - p1.pos.<span class="built_in">getY</span>()) * (p2.pos.<span class="built_in">getX</span>() - p1.pos.<span class="built_in">getX</span>()) / (p2.pos.<span class="built_in">getY</span>() - p1.pos.<span class="built_in">getY</span>()) + p1.pos.<span class="built_in">getX</span>();</span><br><span class="line">			<span class="type">float</span> x2 = (y - p1.pos.<span class="built_in">getY</span>()) * (p3.pos.<span class="built_in">getX</span>() - p1.pos.<span class="built_in">getX</span>()) / (p3.pos.<span class="built_in">getY</span>() - p1.pos.<span class="built_in">getY</span>()) + p1.pos.<span class="built_in">getX</span>();</span><br><span class="line"></span><br><span class="line">			<span class="type">float</span> dy = y - p1.pos.<span class="built_in">getY</span>();</span><br><span class="line">			<span class="type">float</span> t = dy / (p2.pos.<span class="built_in">getY</span>() - p1.pos.<span class="built_in">getY</span>());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// get the right and left point via interpolation</span></span><br><span class="line">			Vertex new1;</span><br><span class="line">			new1.pos.<span class="built_in">setX</span>(xl);</span><br><span class="line">			new1.pos.<span class="built_in">setY</span>(y);</span><br><span class="line">			<span class="built_in">LerpVertexInScreenSpace</span>(new1, p1, p2, t);</span><br><span class="line"></span><br><span class="line">			Vertex new2;</span><br><span class="line">			new2.pos.<span class="built_in">setX</span>(x2);</span><br><span class="line">			new2.pos.<span class="built_in">setY</span>(y);</span><br><span class="line">			<span class="built_in">LerpVertexInScreenSpace</span>(new2, p1, p3, t);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (new1.pos.<span class="built_in">getX</span>() &lt; new2.pos.<span class="built_in">getX</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ScanlineFill</span>(new1, new2, yIndex, texture);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ScanlineFill</span>(new2, new1, yIndex, texture);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TriangleRasterization</span><span class="params">(<span class="type">const</span> Vertex &amp; p1, <span class="type">const</span> Vertex &amp; p2, <span class="type">const</span> Vertex &amp; p3, <span class="type">const</span> Colour** texture)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (p1.pos.<span class="built_in">getY</span>() == p2.pos.<span class="built_in">getY</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (p1.pos.<span class="built_in">getY</span>() &lt; p3.pos.<span class="built_in">getY</span>())</span><br><span class="line">		&#123;<span class="comment">// Flat top</span></span><br><span class="line">			<span class="built_in">DrawTopTriangle</span>(p1, p2, p3, texture);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;<span class="comment">// Flat bottom</span></span><br><span class="line">			<span class="built_in">DrawBottomTriangle</span>(p3, p1, p2, texture);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (p1.pos.<span class="built_in">getY</span>() == p3.pos.<span class="built_in">getY</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (p1.pos.<span class="built_in">getY</span>() &lt; p2.pos.<span class="built_in">getY</span>())</span><br><span class="line">		&#123;<span class="comment">// Flat top</span></span><br><span class="line">			<span class="built_in">DrawTopTriangle</span>(p1, p3, p2, texture);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;<span class="comment">// Flat bottom</span></span><br><span class="line">			<span class="built_in">DrawBottomTriangle</span>(p2, p1, p3, texture);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (p2.pos.<span class="built_in">getY</span>() == p3.pos.<span class="built_in">getY</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (p2.pos.<span class="built_in">getY</span>() &lt; p1.pos.<span class="built_in">getY</span>())</span><br><span class="line">		&#123;<span class="comment">// Flat top</span></span><br><span class="line">			<span class="built_in">DrawTopTriangle</span>(p2, p3, p1, texture);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;<span class="comment">// Flat bottom</span></span><br><span class="line">			<span class="built_in">DrawBottomTriangle</span>(p1, p2, p3, texture);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;<span class="comment">// Segment the triangle </span></span><br><span class="line">		Vertex top;</span><br><span class="line"></span><br><span class="line">		Vertex bottom;</span><br><span class="line">		Vertex middle;</span><br><span class="line">		<span class="keyword">if</span> (p1.pos.<span class="built_in">getY</span>() &gt; p2.pos.<span class="built_in">getY</span>() &amp;&amp; p2.pos.<span class="built_in">getY</span>() &gt; p3.pos.<span class="built_in">getY</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			top = p3;</span><br><span class="line">			middle = p2;</span><br><span class="line">			bottom = p1;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (p3.pos.<span class="built_in">getY</span>() &gt; p2.pos.<span class="built_in">getY</span>() &amp;&amp; p2.pos.<span class="built_in">getY</span>() &gt; p1.pos.<span class="built_in">getY</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			top = p1;</span><br><span class="line">			middle = p2;</span><br><span class="line">			bottom = p3;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (p2.pos.<span class="built_in">getY</span>() &gt; p1.pos.<span class="built_in">getY</span>() &amp;&amp; p1.pos.<span class="built_in">getY</span>() &gt; p3.pos.<span class="built_in">getY</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			top = p3;</span><br><span class="line">			middle = p1;</span><br><span class="line">			bottom = p2;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (p3.pos.<span class="built_in">getY</span>() &gt; p1.pos.<span class="built_in">getY</span>() &amp;&amp; p1.pos.<span class="built_in">getY</span>() &gt; p2.pos.<span class="built_in">getY</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			top = p2;</span><br><span class="line">			middle = p1;</span><br><span class="line">			bottom = p3;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (p1.pos.<span class="built_in">getY</span>() &gt; p3.pos.<span class="built_in">getY</span>() &amp;&amp; p3.pos.<span class="built_in">getY</span>() &gt; p2.pos.<span class="built_in">getY</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			top = p2;</span><br><span class="line">			middle = p3;</span><br><span class="line">			bottom = p1;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (p2.pos.<span class="built_in">getY</span>() &gt; p3.pos.<span class="built_in">getY</span>() &amp;&amp; p3.pos.<span class="built_in">getY</span>() &gt; p1.pos.<span class="built_in">getY</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			top = p1;</span><br><span class="line">			middle = p3;</span><br><span class="line">			bottom = p2;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// 3 points colinear</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// get middle X by interpolation, get coeffiecient-t first</span></span><br><span class="line">		<span class="type">float</span> middleX = (middle.pos.<span class="built_in">getY</span>() - top.pos.<span class="built_in">getY</span>()) * (bottom.pos.<span class="built_in">getX</span>() - top.pos.<span class="built_in">getX</span>()) / (bottom.pos.<span class="built_in">getY</span>() - top.pos.<span class="built_in">getY</span>()) + top.pos.<span class="built_in">getX</span>();</span><br><span class="line">		<span class="type">float</span> dy = middle.pos.<span class="built_in">getY</span>() - top.pos.<span class="built_in">getY</span>();</span><br><span class="line">		<span class="type">float</span> t = dy / (bottom.pos.<span class="built_in">getY</span>() - top.pos.<span class="built_in">getY</span>());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// get the right and left point via interpolation</span></span><br><span class="line">		Vertex newMiddle;</span><br><span class="line">		newMiddle.pos.<span class="built_in">setX</span>(middleX);</span><br><span class="line">		newMiddle.pos.<span class="built_in">setY</span>(middle.pos.<span class="built_in">getY</span>());</span><br><span class="line">		newMiddle.normal = middle.normal;</span><br><span class="line">		<span class="built_in">LerpVertexInScreenSpace</span>(newMiddle, top, bottom, t);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">DrawBottomTriangle</span>(top, newMiddle, middle, texture);</span><br><span class="line">		<span class="built_in">DrawTopTriangle</span>(newMiddle, middle, bottom, texture);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>


<p>The final process of the rasterization stage is kind of like image processing, its main difference with the image processing is that the rasterization stage process vertices gain in geomotry stage, which means that the pixels are created and converted manually by the real vertices, while the image processing is to process an image from an pure pixel container: image itself. But there is no doubt that many conductions of image processing can be integrated from rasterization stage.</p>
<br>
<br>
<br>
<br>
<br>
<br>



<p align="right">© Alexander Ezharjan</p>
<p align="right">31st, March, 2022</p>




<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br></h6></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ezharjan.github.io/Blog/2024/04/06/On-Academic-Attitude/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/Blog/images/avatar.gif">
      <meta itemprop="name" content="Alexander Ezharjan">
      <meta itemprop="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Blog/2024/04/06/On-Academic-Attitude/" class="post-title-link" itemprop="url">On Academic Attitude</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-04-06 21:14:45 / Modified: 21:25:09" itemprop="dateCreated datePublished" datetime="2024-04-06T21:14:45+08:00">2024-04-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h6 align="center">Editor: Alexander Ezharjan<h6>

<p>As time passes by from when I started to dig into academia, I’ve met lots of nice researchers who have serious disciplines on themselves, while also meeting some researchers who are conducting research only for publishing it and obtain the degree they wanted, let alone their “reproducible accomplishments”.</p>
<p>How should we view those researchers who “do not want others to reproduce their results published”?<br>How should we view those researchers who “accidentally omit some important details for reproduction”?<br>How should we view those researchers who “mistakenly wrote the wrong version of their reproduction environment”?</p>
</h6></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ezharjan.github.io/Blog/2024/04/06/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/Blog/images/avatar.gif">
      <meta itemprop="name" content="Alexander Ezharjan">
      <meta itemprop="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Blog/2024/04/06/hello-world/" class="post-title-link" itemprop="url">Hexo Hello World</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-06 21:13:07" itemprop="dateCreated datePublished" datetime="2024-04-06T21:13:07+08:00">2024-04-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Blog/categories/Hexo-Intro/" itemprop="url" rel="index"><span itemprop="name">Hexo Intro</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ezharjan.github.io/Blog/2023/03/13/Ways-to-Reduce-Similarity-of-Papers-Submitted-via-Turnitin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/Blog/images/avatar.gif">
      <meta itemprop="name" content="Alexander Ezharjan">
      <meta itemprop="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Blog/2023/03/13/Ways-to-Reduce-Similarity-of-Papers-Submitted-via-Turnitin/" class="post-title-link" itemprop="url">Ways to Reduce Similarity of Papers Submitted via Turnitin</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-13 12:05:49" itemprop="dateCreated datePublished" datetime="2023-03-13T12:05:49+08:00">2023-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-06 21:13:07" itemprop="dateModified" datetime="2024-04-06T21:13:07+08:00">2024-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Blog/categories/Notes/" itemprop="url" rel="index"><span itemprop="name">Notes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h6 align="center">Editor: Alexander Ezharjan<h6>


<p>Using this method, the similarity index will be reduced enormously:</p>
<p><strong>Experimental Use Only</strong></p>
<ol>
<li>Write using Word;</li>
<li>Export as PDF in Word;</li>
<li>Open exported PDF;</li>
<li>Export all the pages into multiple JPEG files;</li>
<li>Create a new Word document and set its style of all borders to 0cm;</li>
<li>Integrate all the JPEG files into the the Word document at once;</li>
<li>Save the Word document created in step-6 as a PDF file;</li>
<li>Combine the PDF file created in step-2 with the files created in step-7 to reduce the similarity rate of the paper.</li>
<li>Eg. In my tested case, ‘final-opt-v1.pdf’ used only Page 7~11 as the image, the similarity index droped from 44% to 43%; while ‘final-opt-v2.pdf’ added Page 19~21 based on it, the similarity index dropped from 43% to 27%.</li>
</ol>
<br>

<p><img src="https://img2023.cnblogs.com/blog/1991547/202303/1991547-20230313115609390-30665254.png"></p>
<br>


<p><strong>Note</strong> that the <strong>FILE SIZE MATTERS</strong>!<br>Reduce the file size as much as possible while keeping the resolution as high as possible!</p>
<p><em>Be kindly reminded that this is only an experiment for testing the qualification of using Turnitin as a formal way for submitting assignment RATHER THAN an approach for submitting the papers directly via the methods mentioned above.</em></p>
<br>
<br>
<br>

<p><a target="_blank" rel="noopener" href="https://guides.lib.monash.edu/turnitin/increasing-originality">Here</a> are <a target="_blank" rel="noopener" href="https://guides.lib.monash.edu/ld.php?content_id=8482075">other formal ways</a> to reduce similarity index better.</p>
</h6></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ezharjan.github.io/Blog/2023/02/24/Video-List/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/Blog/images/avatar.gif">
      <meta itemprop="name" content="Alexander Ezharjan">
      <meta itemprop="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Blog/2023/02/24/Video-List/" class="post-title-link" itemprop="url">Video List</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-24 09:54:25" itemprop="dateCreated datePublished" datetime="2023-02-24T09:54:25+08:00">2023-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-06 21:13:07" itemprop="dateModified" datetime="2024-04-06T21:13:07+08:00">2024-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Blog/categories/Notes/" itemprop="url" rel="index"><span itemprop="name">Notes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="My-Lectures-amp-Micro-films-amp-Videos"><a href="#My-Lectures-amp-Micro-films-amp-Videos" class="headerlink" title="My Lectures &amp; Micro-films &amp; Videos"></a>My Lectures &amp; Micro-films &amp; Videos</h1><h6 align="center">Editor: Alexander Ezharjan<h6>

<b>
<b>
<b>


<ol>
<li>[PREFIX]&#x2F;VpN2uhHLG_M</li>
<li>[PREFIX]&#x2F;jBY1V1uklxs</li>
<li>[PREFIX]&#x2F;MtCl0HI2JJE</li>
<li>[PREFIX]&#x2F;B59-yAfN-5c</li>
<li>[PREFIX]&#x2F;UfdyJO3H5mo</li>
<li>[PREFIX]&#x2F;uGPFPjTT2hE</li>
<li>[PREFIX]&#x2F;6UkKKxXtNh0</li>
<li>[PREFIX]&#x2F;eh2bNNBGggU</li>
<li>[PREFIX]&#x2F;x37alkIDvVQ</li>
<li>[PREFIX]&#x2F;R8f6mFvO6Wg</li>
<li>[PREFIX]&#x2F;bX1B6C4x86I</li>
<li>[PREFIX]&#x2F;CotuolTvC2c</li>
<li>[PREFIX]&#x2F;SvUFpckm0BI</li>
</ol>
<b>
<b>
<b>
<b>


<hr>
<p>I&#x3D;utu<br>.<br>EF&#x3D;&#x2F;&#x2F;yo<br>PR&#x3D;https:<br>X&#x3D;be</p>
</b></b></b></b></b></b></b></h6></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ezharjan.github.io/Blog/2023/02/23/FFmpeg%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E5%90%88%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/Blog/images/avatar.gif">
      <meta itemprop="name" content="Alexander Ezharjan">
      <meta itemprop="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Blog/2023/02/23/FFmpeg%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E5%90%88%E9%9B%86/" class="post-title-link" itemprop="url">FFmpeg常用指令合集</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-23 16:12:44" itemprop="dateCreated datePublished" datetime="2023-02-23T16:12:44+08:00">2023-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-06 21:13:07" itemprop="dateModified" datetime="2024-04-06T21:13:07+08:00">2024-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Blog/categories/Notes/" itemprop="url" rel="index"><span itemprop="name">Notes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h6 align="center">Editor: Alexander Ezharjan<h6>



<ol>
<li><strong>切割MP3，按时间准确切割</strong></li>
</ol>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i F:\源.mp3 -ss 00:20:00 -to 02:30:05 F:\目标文件.mp3</span><br></pre></td></tr></table></figure>


<ol>
<li><strong>MTS到MP4</strong></li>
</ol>
<p><em>说明：（-b 4m：码率是4M；-s 1280*720：这个是设定视频大小。这2个参数其实可以删掉）</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i F:\源.mts -b 4M -s 1280*720 F:\结果.mp4</span><br></pre></td></tr></table></figure>


<ol start="3">
<li><strong>MP4到WMV</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i f:\视频.mp4 -b 4M f:\out.wmv</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>MP4图像旋转</strong></li>
</ol>
<p><em>说明：主要参数： -vf “transpose&#x3D;1” ，这里等于1是顺时针90度旋转；如果用手机录制的时候录反了，则执行2次这个操作就正过来了</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i f:\o.mp4 -vf &quot;transpose=1&quot; f:\o2.mp4</span><br></pre></td></tr></table></figure>


<ol start="5">
<li><strong>MP4到MP4改尺寸</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i G:\源.mp4 -b 4M -s 640*340 g:\OUT.mp4</span><br></pre></td></tr></table></figure>

<ol start="6">
<li><strong>MP4到MP4改尺寸加水印</strong></li>
</ol>
<p><em>说明：1: -vf “movie&#x3D;logo.png [logo];[in][logo] overlay&#x3D;10:20 [out]” 这里面的是加水印的参数，logo.png是我自己做的PNG水印，大小</em><br><em>300<em>100,10:20是水印的位置，为了方便，就把logo.png拷贝到FFMPEg的bin目录下(必须放，加路径就失败)，这样不用再加路径了 ;2: -b 2M 是用2M压缩率; 3: -s 640</em>340 意思是图像分辨率改为640*340。</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i G:\源.mp4 -vf &quot;movie=logo.png [logo];[in][logo] overlay=10:20 [out]&quot; -b 2M -s 640*340 g:\OUT.mp4</span><br></pre></td></tr></table></figure>


<ol start="7">
<li><strong>快速剪切某段视频作为输出</strong></li>
</ol>
<p><em>说明：上面截取 H:\源.mpg 这个视频，从第0秒开始，到23分20秒，这样一段，保存到G:\out.mp4，注意参数必须是 -c copy ，这样执行起来特别快，也就不到半分钟就搞定。</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i H:\源.mpg -ss 0:0:0 -to 0:23:20 -c copy G:\OUT.MP4</span><br></pre></td></tr></table></figure>

<ol start="8">
<li><strong>该编码为H265,让MP4瘦身2&#x2F;3，1G的MP4可以压缩到300M</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i 源.MP4 -vcodec libx265 -acodec copy F:\OUT.MP4</span><br></pre></td></tr></table></figure>


<ol start="9">
<li><strong>WAV转换格式到amr</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i test.wav -acodec libamr_nb -ab 12.2k -ar 8000 -ac 1 wav2amr.amr</span><br></pre></td></tr></table></figure>

<ol start="10">
<li><strong>提取视频中的声音保存成一个mp3</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i 源.mp4 输出.mp3</span><br></pre></td></tr></table></figure>


<ol start="11">
<li><strong>要实现批量转换，可以直接用这个批处理文件</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for %%i in (*.mkv) do ffmpeg.exe -i &quot;%%i&quot; -vcodec copy -acodec copy &quot;%%~ni.mp4&quot;</span><br></pre></td></tr></table></figure>

<ol start="12">
<li><strong>合并多个MP4为一个</strong></li>
</ol>
<p><em>方法一</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i INPUT1.MP4 -i INPUT2.MP4 -f FORMAT -acodec AUDIOCODEC -vcodec VIDEOCODEC -sameq OUTPUT.MP4</span><br></pre></td></tr></table></figure>


<p><em>方法二</em></p>
<p>（1） 先创建一个文本文件 <code>filelist.txt</code>， 内容如下:(注意input1、2、3是你的文件的名字，都在该目录下)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file &#x27;input1.mp4&#x27;</span><br><span class="line">file &#x27;input2.mp4&#x27;</span><br><span class="line">file &#x27;input3.mp4&#x27;</span><br></pre></td></tr></table></figure>


<p>（2） 以上是这个文本文件的内容，保存后，在命令行执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -f concat -i filelist.txt -c copy output.mp4</span><br></pre></td></tr></table></figure>


<ol start="13">
<li><strong>下载直播流</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FFmpeg -i xxxxxxxxx.m3u8 -c copy out.mp4</span><br></pre></td></tr></table></figure>

<ol start="14">
<li><strong>FFmpeg将MP4转换为M3U8</strong></li>
</ol>
<p>（1）  直接将MP4文件转成m3u8：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i demo.mp4 -hls_time 10 -hls_list_size 0 -hls_segment_filename ene_%05d.ts ene.m3u8</span><br></pre></td></tr></table></figure>



<p>（2） 如果已经是ts文件了,则只需要执行下方命令即可:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i demo.ts -c copy -map 0 -f segment -segment_list playlist.m3u8 -segment_time 10 output%03d.ts</span><br></pre></td></tr></table></figure>


<p>（3） 将大量分割成ts文件的视频片段全部转换成mp4视频片段 — 直接上批处理脚本:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> %%a <span class="keyword">in</span> (<span class="string">&quot;D:\VideoProjects\NewDemo\*.ts&quot;</span>) <span class="keyword">do</span> ffmpeg -i <span class="string">&quot;%%a&quot;</span>   -vcodec copy -vcodec copy -f mp4 <span class="string">&quot;D:\VideoProjects\NewDemo\NewMP4\%%~na.mp4&quot;</span></span><br><span class="line">pause</span><br></pre></td></tr></table></figure>

<p>（4） 上面的  ffmpeg -i test.ts -acodec copy -vcodec copy -f mp4 test.mp4  是将ts文件转换为mp4文件的意思，再在其之上套了一层for循环，%%a就是每个文件，转换命令最末尾的%%~na是将文件保持原来的文件名的情况下进行输出，存放到指定文件夹的意思。</p>
<ol start="15">
<li><strong>mp4视频转flv</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i test.mp4 -acodec copy -vcodec copy -f flv test.flv </span><br></pre></td></tr></table></figure>

<ol start="16">
<li><strong>将本地指定的demo.ts文件进行推流</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re  -i demo.ts  -c copy -f mpegts   udp://127.0.0.1:1997</span><br></pre></td></tr></table></figure>

<ol start="17">
<li><strong>强制把输出视频文件帧率改为 24 fps</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.avi -r 24 output.avi</span><br></pre></td></tr></table></figure>


<ol start="18">
<li><strong>对视频每个一秒截一个图并存在本地</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i out.mp4 -f image2 -vf fps=fps=1 out%d.png</span><br></pre></td></tr></table></figure>


<ol start="19">
<li><strong>每隔20秒截一个图</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i out.mp4 -f image2 -vf fps=fps=1/20 out%d.png</span><br></pre></td></tr></table></figure>


<ol start="20">
<li><strong>将视频转换为图片，一帧一图</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i out.mp4 out%4d.png</span><br></pre></td></tr></table></figure>

<br>
<br>



<p><br> <a href="https://www.jianshu.com/p/91727ab25227" target="_blank">参考</a><br><br> <a href="https://ffmpeg.org/ffmpeg.html" target="_blank">官网</a></p>
</h6></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ezharjan.github.io/Blog/2023/02/13/49%E5%A4%A9%E6%95%88%E5%BA%94/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/Blog/images/avatar.gif">
      <meta itemprop="name" content="Alexander Ezharjan">
      <meta itemprop="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Blog/2023/02/13/49%E5%A4%A9%E6%95%88%E5%BA%94/" class="post-title-link" itemprop="url">49天效应</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-13 11:14:35" itemprop="dateCreated datePublished" datetime="2023-02-13T11:14:35+08:00">2023-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-06 21:13:07" itemprop="dateModified" datetime="2024-04-06T21:13:07+08:00">2024-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Blog/categories/Notes/" itemprop="url" rel="index"><span itemprop="name">Notes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h6 align="center">作者: 艾孜尔江·艾尔斯兰<h6>


<p><strong>49天效应</strong>旨在说明<br><code>全球西方的一些发达、最为先进的科学技术在国内普罗大众之间的广泛传播、达到国内一定程度上众所周知的地步所需要花费的时间约为49天</code></p>
<p>这种规律的掌握有利于对各类技术领域提前研究，甚至在商业领域进行推广和营销。</p>
<p>提出该效应的人是艾孜尔江·艾尔斯兰。</p>
<br>

<br>

<p>拿ChatGPT为例，首先报道此新闻的是西方技术相关媒体，而后在一周到两周的时间内，针对国内而言对此消息获悉最早的是一批以诸如微信公众号、抖音等为载体的小型科技类自媒体（非官方媒体），最后经过一系列传播，不断扩大，更多的非科技类媒体也便参与其中，使消息不断在更多人群中扩散，在49天的时间里形成了以大型媒体以及技术大厂为主体的新型传播样态。学界也涌入其中。</p>
<p>如下图显示的是ChatGPT的全球搜索趋势</p>
<p><img src="/Blog/Blog/2023/02/13/49%E5%A4%A9%E6%95%88%E5%BA%94/49Effect.png" alt="49Effect"></p>
</h6></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ezharjan.github.io/Blog/2022/10/17/%E8%A7%A3%E5%86%B3conda%E8%A3%85%E8%99%9A%E6%8B%9FPython%E7%8E%AF%E5%A2%83%E8%81%94%E7%BD%91%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/Blog/images/avatar.gif">
      <meta itemprop="name" content="Alexander Ezharjan">
      <meta itemprop="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Blog/2022/10/17/%E8%A7%A3%E5%86%B3conda%E8%A3%85%E8%99%9A%E6%8B%9FPython%E7%8E%AF%E5%A2%83%E8%81%94%E7%BD%91%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">解决conda装虚拟Python环境联网失败问题</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-17 10:09:53" itemprop="dateCreated datePublished" datetime="2022-10-17T10:09:53+08:00">2022-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-06 21:13:07" itemprop="dateModified" datetime="2024-04-06T21:13:07+08:00">2024-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Blog/categories/%E7%AD%94%E7%96%91/" itemprop="url" rel="index"><span itemprop="name">答疑</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h6 align="center">Editor: Alexander Ezharjan<h6>

<ol>
<li><p>使用 <code>conda create -n carla python=3.7</code> 命令安装虚拟环境出错，说网络连接异常，经久查询未果：<br><img src="https://img-blog.csdnimg.cn/0af662487e2c48f7baaf3f323d1dbc73.png" alt="在这里插入图片描述"></p>
</li>
<li><p>在终端输入下面这些：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/msys2/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span><br><span class="line">conda config --set show_channel_urls yes</span><br></pre></td></tr></table></figure>
</li>
<li><p>走进 <code>C:/Users/USER_NAME/.condarc</code>，删除内部的 <code>-defaults</code> 选项，保存退出；<br><img src="https://img-blog.csdnimg.cn/3d4a61eddb84466586e14749939fd41c.png" alt="在这里插入图片描述"></p>
</li>
<li><p>重新运行 <code>conda create -n carla python=3.7</code> 指令即可。</p>
</li>
</ol>
<br>

<br>
<br>


<p>作者：艾孜尔江·艾尔斯兰</p>
</h6></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ezharjan.github.io/Blog/2022/10/16/MOSES%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/Blog/images/avatar.gif">
      <meta itemprop="name" content="Alexander Ezharjan">
      <meta itemprop="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Blog/2022/10/16/MOSES%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">MOSES入门</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-16 22:08:48" itemprop="dateCreated datePublished" datetime="2022-10-16T22:08:48+08:00">2022-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-06 21:13:07" itemprop="dateModified" datetime="2024-04-06T21:13:07+08:00">2024-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Blog/categories/Notes/" itemprop="url" rel="index"><span itemprop="name">Notes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h6 align="center">编者：艾孜尔江<h6>


<hr>
<p>摩西是统计（或称基于数据的）机器翻译（MT）的一个实现方法。这是该领域目前的主要方法，并被谷歌和微软等公司部署的在线翻译系统所采用。在统计机器翻译（SMT）中，翻译系统接受大量并行数据的训练（系统从中学习如何翻译小段），以及更大量的单语数据（系统从中学习目标语言应该怎么组织）。平行数据是两种不同语言的句子集合，它们是句子对齐的，因为一种语言的每个句子都与另一种语言中相应的翻译句子相匹配，它也被称为bitext。</p>
<p>摩西的训练过程接收平行数据，并使用单词和语言片段（即为短语）的同时出现来推断两种语言之间的对应关系。在基于短语的机器翻译中，这些对应关系仅在连续的单词序列之间，而在基于分层短语的机器翻译或基于语法的翻译中，更多关于句子的结构被添加到对应关系中。例如，一个分层的机器翻译系统可以知道德国hat<br>X gegessen 对应于英语中的ate<br>X，其中Xs能被任何德语-英语单词对所替换。在这些类型的系统中使用的额外结构可能或并不能从并行语料的语言分析得到。摩西还实现了基于短语的机器翻译的扩展，称为因式翻译，可以将额外的语言信息添加到基于短语的翻译系统中。</p>
<p>有关摩西翻译模型的更多信息，请参见摩西网站上关于<a target="_blank" rel="noopener" href="http://www.statmt.org/moses/?n=Moses.Tutorial">基于短语的机器翻译系统</a>，基于<a target="_blank" rel="noopener" href="http://www.statmt.org/moses/?n=Moses.SyntaxTutorial">句法的翻译系统</a>或基于因子的翻译系统。</p>
<p>无论您使用哪种类型的机器翻译模型，创建一个表现良好的翻译系统的关键都是大量优质数据（语料）。您可以使用许多<a target="_blank" rel="noopener" href="http://www.statmt.org/moses/?n=Moses.LinksToCorpora">免费的并行数据源</a>来训练样本系统，比如：<a target="_blank" rel="noopener" href="http://www.statmt.org/moses/?n=Moses.LinksToCorpora">http://www.statmt.org/moses/?n=Moses.LinksToCorpora</a>。但（通常）您使用的数据越接近您要翻译的语言类型，得到的结果就越好。这是使用像Moses这样的开源工具的优势之一，如果您拥有自己的数据，那么您可以根据需要定制自己的翻译系统，并且可能比通用翻译系统获得更好的性能。摩西用来训练翻译系统的过程中需要句子对齐的数据，但如果语料在文档级别对齐，则通常可以使用像<a target="_blank" rel="noopener" href="http://mokk.bme.hu/resources/hunalign/">hunalign</a>这样的工具将其转换为句子对齐的数据。</p>
<h2 id="Moses系统的组成部分"><a href="#Moses系统的组成部分" class="headerlink" title="Moses系统的组成部分"></a><strong>Moses系统的组成部分</strong></h2><p>摩西系统的两个主要组成部分是训练管道和解码器。还有各种开源社区贡献的工具和实用程序。训练管道实际上是一组工具（主要用perl编写，有些用C<br>++编写），它们采用原始数据（并行语料和单语言）并将其转换为机器翻译模型。解码器是一个单独的C<br>++应用程序，给定一个训练有素的机器翻译模型和源句子，将源语句翻译成目标语言。</p>
<p>1.培训管道：</p>
<p>从培训数据生成翻译系统涉及各个阶段，这些阶段在培训文档和基线系统指南中有更详细的描述。这些作为管道被完成，并且可由摩西实验管理系统所控制，而Moses通常可以轻松地将不同类型的外部工具插入到培训管道中</p>
<p>数据在被用于训练之前需要做一些准备工作，标记文本并且将标记转换为标准案例。启发式用于删除看起来未对齐的句子对，并删除长句子。然后，并行的句子需要词对齐，通常使用<br>GIZA<br>++来完成，它实现了80年代在IBM开发的一组统计模型。这些词对齐被用于根据需要提取短语-短语翻译或分层规则，并且使用这些规则的语料库范围统计来估计概率。</p>
<p>翻译系统的一个重要部分是语言模型，一种使用目标语言中的单语言数据构建的统计模型，并由解码器用来尝试确保输出的流畅性。摩西依靠<a target="_blank" rel="noopener" href="http://www.statmt.org/moses/?n=FactoredTraining.BuildingLanguageModel">外部工具</a>（<a target="_blank" rel="noopener" href="http://www.statmt.org/moses/?n=FactoredTraining.BuildingLanguageModel%EF%BC%89%E8%BF%9B%E8%A1%8C%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E6%9E%84%E5%BB%BA%E3%80%82">http://www.statmt.org/moses/?n=FactoredTraining.BuildingLanguageModel）进行语言模型构建。</a></p>
<p>创建机器翻译系统的最后一步是<em>调优</em>，其中不同的统计模型相互加权以产生最佳可能的翻译。摩西系统包含了最流行的调优算法的实现。</p>
<p>2.解码器</p>
<p>摩西解码器的工作是找到与给定源句子相对应的目标语言（根据翻译模型）的最高评分句子。解码器还可以输出候选的翻译的从好到坏的排序列表，并且还提供关于其如何做出决策的各种类型的信息（例如，它使用的短语-短语对应关系）。</p>
<p>解码器以模块化方式编写，并允许用户以各种方式改变解码过程，例如：</p>
<ul>
<li><p>输入：这可以是一个简单的句子，或者它可以用类似xml的元素的注释来指导翻译过程，或者它可以是更复杂的结构，如格子或混淆网络（例如，从语音识别的输出）</p>
</li>
<li><p>翻译模型：这可以使用短语-短语规则或分层（也可能是句法）规则。它可以编译成二进制形式，以加快加载速度。它可以通过将额外的信息添加到翻译过程中来补充一些特性，例如阐明短语对的来源以控制他们的可靠性的特性。</p>
</li>
<li><p>解码算法：解码问题是一个巨型的搜索问题，通常对于精确搜索来说太大了，而且Moses为这种搜索实现了几种不同的策略，例如基于堆栈，立方体修剪，图表解析等。</p>
</li>
<li><p>语言模型：<br>Moses支持几种不同的语言模型工具包（SRILM，KenLM，IRSTLM，RandLM），每种工具包都有自己的优点和缺点，添加一个新的LM工具包很简单。</p>
</li>
</ul>
<p>Moses解码器还支持多线程解码（因为翻译具有<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Embarrassingly_parallel">很高的的并行性</a>），并且如果您有权访问群集服务器，摩西提供启用多进程解码的脚本。</p>
<h2 id="贡献工具"><a href="#贡献工具" class="headerlink" title="贡献工具"></a>贡献工具</h2><p>摩西有许多贡献工具，它们提供额外的功能和超越标准训练和解码管道的附加功能。这些包括：</p>
<ul>
<li><p>Moses服务器：为解码器提供xml-rpc接口，需要安装xmlrpc-c。</p>
</li>
<li><p>Web翻译：一组脚本，使Moses可用于翻译网页</p>
</li>
<li><p>分析工具：与参考文献相比，是一个可以对摩西输出进行分析和可视化的脚本。</p>
</li>
</ul>
<p>还有用于评估翻译的工具，替代短语评分方法，用于加权短语表的技术的实现，用于减小短语表的规模的工具以及其他贡献工具。</p>
<h2 id="一-安装相关依赖项："><a href="#一-安装相关依赖项：" class="headerlink" title="一 安装相关依赖项："></a>一 安装相关依赖项：</h2><p>在本教程中，我用来搭建Moses系统的服务器环境如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root\@VM-0-15-ubuntu:/home/ubuntu/mosesdecoder\<span class="comment"># lsb_release -a</span></span><br><span class="line"></span><br><span class="line">No LSB modules are available.</span><br><span class="line"></span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line"></span><br><span class="line">Description: Ubuntu 16.04.4 LTS</span><br><span class="line"></span><br><span class="line">Release: 16.04</span><br><span class="line"></span><br><span class="line">Codename: xenial</span><br></pre></td></tr></table></figure>

<p>安装如下依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential git-core pkg-config automake libtool wget</span><br><span class="line">zlib1g-dev python-dev libbz2-dev</span><br></pre></td></tr></table></figure>
<p>从Github克隆Moses：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> &lt;https://github.com/moses-smt/mosesdecoder.git&gt;</span><br><span class="line"><span class="built_in">cd</span> mosesdecoder</span><br></pre></td></tr></table></figure>

<p>运行以下命令安装最新的boost库，cmph (for<br>CompactPT，即C Minimal Perfect Hashing Library), irstlm (language model from<br>FBK, required to pass the regression tests),和 xmlrpc-c (for moses<br>server)。这些都会默认安装在你的当前工作目录的.&#x2F;opt路径。其中xmlrpc不是必须，但是如果将moses作为服务提供必须安装xmlrpc。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -f contrib/Makefiles/install-dependencies.gmake</span><br></pre></td></tr></table></figure>

<p>编译Moses：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">./compile.sh [additional options]</span><br><span class="line"></span><br><span class="line">\--prefix=/destination/path --install-scripts 安装到其他目录</span><br><span class="line"></span><br><span class="line">\--with-mm 使用基于后缀数组的短语表</span><br></pre></td></tr></table></figure>

<p>其中，MOSES<br>SERVER使你可以把MOSES解码器作为一个服务器进程来运行，发送给其的句子将通过XMLRPC来翻译。这意味着无论客户使用java,python,perl,php还是其它别的XMLRPC集合里有的语言来编码，MOSES进程都可以服务客户且分布式地服务客户。</p>
<p>XMLRPC是Userland<br>Software公司设计的一种格式：是一种使用HTTP协议传输XML格式文件来获取远程程序调用（Remote<br>Procedure<br>Call）的传输方式。远程程序调用简单地讲是指，一台机器通过网络调用另一台机器里的应用程序，同时将执行结果返回。一般一台机器作为服务器端，另一台作为客户端。服务器端需要轮询是否有客户端进行RPC请求。一个简单的例子。一台服务器提供查询当前时间的RPC服务。其他任何一台机器通过网络，使用客户端，都可以到该服务器查询当前的时间。</p>
<p>MLRPC是RPC机制的实现方式之一。采用XML语言作为服务器与客户端的数据交互格式，方便使用者阅读。XMLRPC可以用很多种语言实现，包括perl，phyon，c等。使用c与c++实现的库，就是XMLRPC-c。</p>
<p>Boost<br>1.48版本在编译Moses时会出现一个严重的bug。在有些Linux的分发版本中，比如Ubuntu<br>12.04，Boost库存在着这种版本的Boost库。在这种情况下，你必须要手动下载和编译Boost。</p>
<p>下载编译boost：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">wget &lt;https://dl.bintray.com/boostorg/release/1.64.0/source/boost_1_64_0.tar.gz&gt;</span><br><span class="line"></span><br><span class="line">tar zxvf boost_1_64_0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> boost_1_64_0/</span><br><span class="line"></span><br><span class="line">./bootstrap.sh</span><br><span class="line"></span><br><span class="line">./b2 -j4 --prefix=\<span class="variable">$PWD</span> --libdir=\<span class="variable">$PWD</span>/lib64 --layout=system <span class="built_in">link</span>=static install</span><br><span class="line">\|\| <span class="built_in">echo</span> FAILURE \<span class="comment">#或者执行./b2安装在当前目录下</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述命令在文件夹lib64中创建文件夹，并不是在系统目录下。因此，你不必使用系统root权限来执行上述命令。然而，你需要告诉Moses如何找到boost。当boost被暗账好以后，你可以开始编译Moses，你需要用 –with-boost标记告诉Moses系统<br>boost安装在哪里。</p>
<p>下载安装cmph:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">wget</span><br><span class="line">http://www.mirrorservice.org/sites/download.sourceforge.net/pub/sourceforge/c/cm/cmph/cmph/cmph-2.0.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf cmph-2.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">cd</span> cmph-2.0/</span><br><span class="line"></span><br><span class="line">./configure --prefix= /usr/local/cmph</span><br><span class="line">\<span class="comment">#指定安装路径，这里我选择了/usr/local/cmph</span></span><br><span class="line"></span><br><span class="line">Make</span><br><span class="line"></span><br><span class="line">Make install</span><br></pre></td></tr></table></figure>

<p>下载安装xmlrpc-c：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">wget</span><br><span class="line">https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/xmlrpc-c/1.33.14-8build1/xmlrpc-c_1.33.14.orig.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf xmlrpc-c_1.33.14.orig.tar.gz</span><br><span class="line"></span><br><span class="line">cd xmlrpc-c-1.33.14/</span><br><span class="line"></span><br><span class="line">./configure --prefix= /usr/local/xmlrpc-c</span><br><span class="line">\#指定安装路径，这里我选择了/usr/local/xmlrpc-c</span><br><span class="line"></span><br><span class="line">Make</span><br><span class="line"></span><br><span class="line">Make install</span><br></pre></td></tr></table></figure>

<p>接下来，用bjam编译Moses：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bjam --with-boost=/home/ubuntu/boost_1_64_0 --with-cmph=/usr/local/cmph</span><br><span class="line">--with-xmlrpc-c=/usr/local/xmlrpc-c -j4</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意： –with-boost<br>后的路径为你自己安装时指定的路径，-j4 用于指定核心数。Moses可选的语言模型有IRSTLM，SRILM，KenLM.其中，KenLM已经默认包含在Moses工具包中。我们在这里使用Moses自带的语言模型工具KenLM，不再安装irstlm。</p>
<h2 id="二-安装词对齐工具GIZA"><a href="#二-安装词对齐工具GIZA" class="headerlink" title="二 安装词对齐工具GIZA++"></a>二 安装词对齐工具GIZA++</h2><p>接下来，安装词对齐工具GIZA++：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> &lt;https://github.com/moses-smt/giza-pp.git&gt;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> giza-pp</span><br><span class="line"></span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>编译完成后，将生成三个二进制文件：</p>
<p>· giza-pp&#x2F;GIZA++-v2&#x2F;GIZA++</p>
<p>· giza-pp&#x2F;GIZA++-v2&#x2F;snt2cooc.out</p>
<p>· giza-pp&#x2F;mkcls-v2&#x2F;mkcls</p>
<p>记得在编译完之后将上面的三个文件拷到一个目录下，便于访问使用。如下面的命令所示，我是直接将其放在tools文件夹下的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd \~/mosesdecoder</span><br><span class="line"></span><br><span class="line">mkdir tools</span><br><span class="line"></span><br><span class="line">cp \~/giza-pp/GIZA++-v2/GIZA++ \~/giza-pp/GIZA++-v2/snt2cooc.out \\</span><br><span class="line"></span><br><span class="line">\~/giza-pp/mkcls-v2/mkcls tools</span><br></pre></td></tr></table></figure>

<p>编译创建好GIZA++后，有两种方式来使用它，一是在编译Moses时将GIZA++的地址作为选项参数。如果在编译Moses时没有指定GIZA++的地址，可以采用另外一个方法，那就是在训练语言模型时指明GIZA++三个可执行文件的路径，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">train-model.perl -external-bin-dir \<span class="variable">$HOME</span>/external-bin-dir</span><br><span class="line"></span><br><span class="line">我在实际操作中，采用的是第二种方法，即在使用Moses时，给一个参数指明GIZA++路径。</span><br></pre></td></tr></table></figure>

<h2 id="三-语料准备"><a href="#三-语料准备" class="headerlink" title="三 语料准备"></a>三 语料准备</h2><p>接下来，准备平行语料：</p>
<p>我的英汉平行语料来自联合国的网站提供的英汉平行语料，（<a target="_blank" rel="noopener" href="https://conferences.unite.un.org/uncorpus/zh%EF%BC%89%EF%BC%8C%E5%A4%A7%E7%BA%A61600%E4%B8%87%E5%AF%B9%E3%80%82%E5%9B%A0%E6%88%91%E4%BD%BF%E7%94%A8%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%86%85%E5%AD%98%E5%8F%AA%E6%9C%894G%EF%BC%8C%E6%89%80%E4%BB%A5%E5%B0%86%E5%8E%9F%E6%96%87%E4%BB%B6%E5%88%86%E6%88%9030%E4%BB%BD%EF%BC%8C%E4%BB%8E%E4%B8%AD%E6%88%AA%E5%8F%96%E4%BA%86%E7%BA%A660%E4%B8%87%E5%AF%B9%E7%94%A8%E6%9D%A5%E5%81%9A%E6%AD%A4%E6%AC%A1%E5%AE%9E%E9%AA%8C%E3%80%82">https://conferences.unite.un.org/uncorpus/zh），大约1600万对。因我使用的服务器内存只有4G，所以将原文件分成30份，从中截取了约60万对用来做此次实验。</a></p>
<p>我们的英文语料为：un_en-zh23.en，汉语语料为：un_en-zh23.cn。</p>
<p>在准备训练翻译系统之前，我们需要对语料做如下的处理：</p>
<ol>
<li><strong>tokenisation：</strong>这一步主要是在单词和单词之间或者单词和标点之间插入空白，以便于后续识别和其他操作。</li>
</ol>
<p>对于英文语料，我们运行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/tokenizer/tokenizer.perl -l en \\</span><br><span class="line"></span><br><span class="line">\&lt; \~/corpus/training/un_en-zh23.en \\</span><br><span class="line"></span><br><span class="line">\&gt; \~/corpus/un_en-zh23.tok.en</span><br></pre></td></tr></table></figure>

<blockquote>
<p>  注：命令当中的~为Mosesdecoder的安装路径和语料所在的具体路径，下同</p>
</blockquote>
<p>对于汉语语料。我们需要进行分词。在这里，我们使用清华大学自然语言处理与社会人文计算实验室研制推出的中文词法分析工具包（<a href="http://thulac.thunlp.org），具有中文分词和词性标注功能。具有能力强，准确率高，速度快的特点。具体使用方法请参照网页。在这里，我们使用Python版本来对中文语料进行分词，具体代码如下：">http://thulac.thunlp.org），具有中文分词和词性标注功能。具有能力强，准确率高，速度快的特点。具体使用方法请参照网页。在这里，我们使用Python版本来对中文语料进行分词，具体代码如下：</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> thulac</span><br><span class="line"></span><br><span class="line">thu1=thulac.thulac(user_dict=<span class="string">&quot;/home/ubuntu/corpus/un_en-zh_23/dict.txt&quot;</span>,seg_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment">#只进行分词，不进行词性标注</span></span><br><span class="line"></span><br><span class="line">thu1.cut_f(<span class="string">&quot;/home/ubuntu/corpus/un_en-zh_23/un_en-zh23.cn&quot;</span>,</span><br><span class="line"><span class="string">&quot;/home/ubuntu/corpus/un_en-zh_23/un_en-zh23.fc&quot;</span>)</span><br><span class="line">\<span class="comment">#对un_en-zh23.cn文件内容进行分词，输出到un_en-zh23.fc</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>  经过tokenisation，我们得到un_en-zh23.fc和un_en-zh23.tok.en两个文件。</p>
</blockquote>
<ol>
<li>truecase：初始每句话的字和词组都被转换为没有格式的形式(例如统一为小写）。这有助于减少数据稀疏性问题。</li>
</ol>
<blockquote>
<p>  Truecase首先需要训练，以便提取关于文本的一些统计信息</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/recaser/train-truecaser.perl \\</span><br><span class="line"></span><br><span class="line">\--model \~/corpus/truecase-model.en --corpus \\</span><br><span class="line"></span><br><span class="line">\~/corpus/ un_en-zh23.tok.en</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/recaser/train-truecaser.perl \\</span><br><span class="line"></span><br><span class="line">\--model \~/corpus/truecase-model.cn --corpus \\</span><br><span class="line"></span><br><span class="line">\~/corpus/ un_en-zh23.fc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>  经过此步，我们得到truecase-model.en和truecase-model.cn两个文件。</p>
</blockquote>
<blockquote>
<p>  接下来，我们对tokenisation后的文件进行truecase：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/recaser/truecase.perl \\</span><br><span class="line"></span><br><span class="line">\--model \~/corpus/truecase-model.en \\</span><br><span class="line"></span><br><span class="line">\&lt; \~/corpus/ un_en-zh23.tok.en \\</span><br><span class="line"></span><br><span class="line">\&gt; \~/corpus/ un_en-zh23.true.en</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/recaser/truecase.perl \\</span><br><span class="line"></span><br><span class="line">\--model \~/corpus/truecase-model.cn \\</span><br><span class="line"></span><br><span class="line">\&lt; \~/corpus/ un_en-zh23.fc \\</span><br><span class="line"></span><br><span class="line">\&gt; \~/corpus/un_en-zh23.true.cn</span><br></pre></td></tr></table></figure>

<p>经过truecase，我们得到un_en-zh23.true.cn和un_en-zh23.true.en两个文件。</p>
<ol start="3">
<li>cleaning：长句和空语句可引起训练过程中的问题，因此将其删除，同时删除明显不对齐的句子。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/training/clean-corpus-n.perl \\</span><br><span class="line"></span><br><span class="line">\~/corpus/ un_en-zh23.true cn en \\</span><br><span class="line"></span><br><span class="line">\~/corpus/ un_en-zh23.clean 1 80</span><br><span class="line"></span><br></pre></td></tr></table></figure>
需要注意的是，这句命令会对truecase-model.en和truecase-model.cn两个文件同时进行清洗。经过clean，我们得到un_en-zh23.clean.en和un_en-zh23.clean.cn两个文件。</li>
</ol>
<h2 id="四-语言模型训练（Language-Model-Training）"><a href="#四-语言模型训练（Language-Model-Training）" class="headerlink" title="四 语言模型训练（Language Model Training）"></a>四 语言模型训练（Language Model Training）</h2><p>语言模型的训练是为了保证能够产生流利的输出，所以要用目标语言来建立。本例的目标语言是汉语。在这里，我们使用Moses系统中内置的语言语言模型工具KenLM，当然，你也可以使用其他一些开源的语言模型工具，比如，IRSTLM，BerkeleyLM，SRILM等。接下来，我们建立一个合适的3元文语言模型。</p>
<p>建立文件夹lm，然后运行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> \~/lm</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> \~/lm</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/bin/lmplz -o 3 \&lt;\~/corpus/ un_en-zh23.true.cn \&gt;</span><br><span class="line">un_en-zh23.arpa.cn</span><br></pre></td></tr></table></figure>

<p>你会看到建立语言模型的五个步骤：</p>
<p>1&#x2F;5 Counting and sorting n-grams</p>
<p>2&#x2F;5 Calculating and sorting adjusted counts</p>
<p>3&#x2F;5 Calculating and sorting initial probabilities</p>
<p>4&#x2F;5 Calculating and writing order- interpolated probabilities</p>
<p>5&#x2F;5 Writing ARPA model &#x3D;FE Name</p>
<p>此步我们生成un_en-zh23.arpa.cn<br>文件，接下来我们为了加载的更快一些，我们使用KenLm来对*.arpa.en文件二进制化。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\~/mosesdecoder/bin/build_binary \\</span><br><span class="line"></span><br><span class="line">un_en-zh23.arpa.cn \\</span><br><span class="line"></span><br><span class="line">un_en-zh23.blm.cn</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>当你看到绿色的SUCCESS字样时说明二进制化已经成功了。我们可以在这一步之后通过查询测试来判断训练的模型是否正确，运行如下的linux命令你会看到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\$ <span class="built_in">echo</span> <span class="string">&quot;我 爱 我的 好姑娘&quot;</span> \\</span><br><span class="line"></span><br><span class="line">\| \~/mosesdecoder/bin/query un_en-zh23.blm.cn</span><br><span class="line"></span><br><span class="line">Loading statistics:</span><br><span class="line"></span><br><span class="line">我=8872 2 -2.282969 爱=18074 1 -6.466906 我的=9416 1 -4.8714185</span><br><span class="line"></span><br><span class="line">好姑娘=0 1 -6.4878592 \&lt;/s\&gt;=2 1 -2.288369 Total: -22.397522 OOV: 1</span><br><span class="line"></span><br><span class="line">Perplexity including OOVs: 30165.07396388977</span><br><span class="line"></span><br><span class="line">Perplexity excluding OOVs: 9493.266676976866</span><br><span class="line"></span><br><span class="line">OOVs: 1</span><br><span class="line"></span><br><span class="line">Tokens: 5</span><br><span class="line"></span><br><span class="line">Name:query VmPeak:151680 kB VmRSS:4088 kB RSSMax:136452 kB</span><br><span class="line"></span><br><span class="line">user:0.008 sys:0 CPU:0.008 real:0.00995472</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="五-训练翻译模型（Training-the-Translation-System）"><a href="#五-训练翻译模型（Training-the-Translation-System）" class="headerlink" title="五 训练翻译模型（Training the Translation System）"></a>五 训练翻译模型（Training the Translation System）</h2><p>接下来，我们进行到最主要的一步，训练翻译模型。在这一步，我们进行词对齐（用GIZA++），短语抽取，打分，创建词汇化重新排序表，并且创建属于我们自己的摩西配置文件(moses.ini)。我们运行如下的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> \~/working</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> \~/working</span><br><span class="line"></span><br><span class="line"><span class="built_in">nohup</span> <span class="built_in">nice</span> \~/mosesdecoder/scripts/training/train-model.perl -root-dir train \\</span><br><span class="line"></span><br><span class="line">\-corpus \~/corpus/ un_en-zh23.clean \\</span><br><span class="line"></span><br><span class="line">\-f en -e cn -alignment grow-diag-final-and -reordering msd-bidirectional-fe \\</span><br><span class="line"></span><br><span class="line">\-lm 0:3:\<span class="variable">$HOME</span>/lm/un_en-zh23.blm.cn:8 \\</span><br><span class="line"></span><br><span class="line">\-external-bin-dir \~/mosesdecoder/tools \&gt;&amp; training.out &amp;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果你的CPU是多核的，建议你加上-cores<br>参数来加快词对齐的过程。注意，如果在训练翻译系统的过程中遇到了 Exit<br>code:137错误，一般是因为内存不足，需要增大服务器的内存配置。上述过程完成后，你可以在~&#x2F;working&#x2F;train&#x2F;model<br>文件夹下找到一个moses.ini配置文件，这是需要在moses解码时使用到的。但这里有几个问题，首先是它的加载速度很慢，这个问题我们可以通过二值化(binarising)短语表和短语重排序表来解决，即编译成一个可以很快地加载的格式。第二个问题是，该配置文件中moses解码系统用来权衡不同的模型之间重要程度的权重信息都是刚初始化的，即非最优的，如果你用VIM打开moses.ini文件看看的话，你会看到各种权重都被设置为默认值，如0.2，0.3等。要寻找更好的权重，我们需要调整(tuning)翻译系统，即下一步。</p>
<h2 id="六-调优-Tuning"><a href="#六-调优-Tuning" class="headerlink" title="六 调优(Tuning)"></a>六 调优(Tuning)</h2><p>这是整个过程中最慢的一步，Tuning需要一小部分的平行语料，与训练数据相分离开。这里，我们再次从联合国的平行语料中截取一部分。我们用来调优的语料文件名称为un_dev.cn和un_dev.en。我们将用这两个文件来完成调优的过程，所以我们在之前必须对着两个文件进行  tokenise<br>和 truecase。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd \~/corpus</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/tokenizer/tokenizer.perl -l en \\</span><br><span class="line"></span><br><span class="line">\&lt; dev/un_dev.en \&gt; un_dev.tok.en</span><br></pre></td></tr></table></figure>

<p>同样的，对un_dev.cn进行中文分词，得到un_dev.fc。</p>
<p>然后进行truecase：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/recaser/truecase.perl --model truecase-model.en \\</span><br><span class="line"></span><br><span class="line">\&lt; un_dev.tok.en \&gt; un_dev.true.en</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/recaser/truecase.perl --model truecase-model.fr \\</span><br><span class="line"></span><br><span class="line">\&lt; un_dev.fc \&gt; un_dev.true.cn</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后回到我们用来训练的目录，开始调优的过程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd \~/working</span><br><span class="line"></span><br><span class="line">nohup nice \~/mosesdecoder/scripts/training/mert-moses.pl \\</span><br><span class="line"></span><br><span class="line">\~/corpus/ un_dev.true.en \~/corpus/ un_dev.true.cn \\</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/bin/moses train/model/moses.ini --mertdir \~/mosesdecoder/bin/</span><br><span class="line">\\</span><br><span class="line"></span><br><span class="line">&amp;\&gt; mert.out &amp;</span><br></pre></td></tr></table></figure>

<p>如果你的CPU是多核的，那么用多线程来运行摩西会明显加快速度。在上面的最后一行加上–decoder-flags&#x3D;”-threads<br>4”可以用四线程来运行解码器。</p>
<p>最后的调优结果是一个包含训练权重的ini文件，如果你用的跟我一样的目录结构的话，应该存在于~&#x2F;working&#x2F;mert-<br>work&#x2F;moses.ini文件夹中。</p>
<h2 id="七-测试"><a href="#七-测试" class="headerlink" title="七 测试"></a>七 测试</h2><p>接下来你可以运行下面的命令来翻译句子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\~/mosesdecoder/bin/moses -f \~/working/mert-work/moses.ini</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行命令后，会得到下面的提示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Defined parameters (per moses.ini or switch):</span><br><span class="line"></span><br><span class="line">config: /home/ubuntu/corpus/un_en-zh_23/working/mert-work/moses.ini</span><br><span class="line"></span><br><span class="line">distortion-limit: 6</span><br><span class="line"></span><br><span class="line">feature: UnknownWordPenalty WordPenalty PhrasePenalty PhraseDictionaryMemory</span><br><span class="line">name=TranslationMode l0 num-features=4</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/working/train/model/phrase-table.gz</span><br><span class="line">input-factor=0 output-factor=0 LexicalReordering name=LexicalReordering0</span><br><span class="line">num-features=6 <span class="built_in">type</span>=wbe-msd-bidirectional-fe-a llff input-factor=0</span><br><span class="line">output-factor=0</span><br><span class="line">path=/home/ubuntu/corpus/un_enzh_23/working/train/model/reordering-t</span><br><span class="line">able.wbe-msd-bidirectional-fe.gz Distortion KENLM name=LM0 <span class="built_in">factor</span>=0</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/ lm/un_en-zh23.blm.cn order=3</span><br><span class="line"></span><br><span class="line">input-factors: 0</span><br><span class="line"></span><br><span class="line">mapping: 0 T 0</span><br><span class="line"></span><br><span class="line">weight: LexicalReordering0= 0.0614344 0.0245557 0.242242 0.0725016 0.0539617</span><br><span class="line">0.0566553 Distortion 0= 0.00534453 LM0= 0.0696027 WordPenalty0= -0.166007</span><br><span class="line">PhrasePenalty0= 0.0688629 TranslationModel0= 0.03900 17 0.0457273 0.0730895</span><br><span class="line">0.0210141 UnknownWordPenalty0= 1</span><br><span class="line"></span><br><span class="line">line=UnknownWordPenalty</span><br><span class="line"></span><br><span class="line">FeatureFunction: UnknownWordPenalty0 start: 0 end: 0</span><br><span class="line"></span><br><span class="line">line=WordPenalty</span><br><span class="line"></span><br><span class="line">FeatureFunction: WordPenalty0 start: 1 end: 1</span><br><span class="line"></span><br><span class="line">line=PhrasePenalty</span><br><span class="line"></span><br><span class="line">FeatureFunction: PhrasePenalty0 start: 2 end: 2</span><br><span class="line"></span><br><span class="line">line=PhraseDictionaryMemory name=TranslationModel0 num-features=4</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/wo rking/train/model/phrase-table.gz</span><br><span class="line">input-factor=0 output-factor=0</span><br><span class="line"></span><br><span class="line">FeatureFunction: TranslationModel0 start: 3 end: 6</span><br><span class="line"></span><br><span class="line">line=LexicalReordering name=LexicalReordering0 num-features=6</span><br><span class="line"><span class="built_in">type</span>=wbe-msd-bidirectional-fe-allff input-f actor=0 output-factor=0</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/working/train/model/reordering-table.wbe-msd</span><br><span class="line">-bidirectional-fe.gz</span><br><span class="line"></span><br><span class="line">Initializing Lexical Reordering Feature..</span><br><span class="line"></span><br><span class="line">FeatureFunction: LexicalReordering0 start: 7 end: 12</span><br><span class="line"></span><br><span class="line">line=Distortion</span><br><span class="line"></span><br><span class="line">FeatureFunction: Distortion0 start: 13 end: 13</span><br><span class="line"></span><br><span class="line">line=KENLM name=LM0 <span class="built_in">factor</span>=0</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/lm/un_en-zh23.blm.cn order=3</span><br><span class="line"></span><br><span class="line">FeatureFunction: LM0 start: 14 end: 14</span><br><span class="line"></span><br><span class="line">Loading UnknownWordPenalty0</span><br><span class="line"></span><br><span class="line">Loading WordPenalty0</span><br><span class="line"></span><br><span class="line">Loading PhrasePenalty0</span><br><span class="line"></span><br><span class="line">Loading LexicalReordering0</span><br><span class="line"></span><br><span class="line">Loading table into memory...done.</span><br><span class="line"></span><br><span class="line">Loading Distortion0</span><br><span class="line"></span><br><span class="line">Loading LM0</span><br><span class="line"></span><br><span class="line">Loading TranslationModel0</span><br><span class="line"></span><br><span class="line">Start loading text phrase table. Moses format : [133.871] seconds</span><br><span class="line"></span><br><span class="line">Reading /home/ubuntu/corpus/un_en-zh_23/working/train/model/phrase-table.gz</span><br><span class="line"></span><br><span class="line">\----5---10---15---20---25---30---35---40---45---50---55---60---65---70---75---80---85---90---95--100</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输入你喜欢的英语句子，然后查看结果。你会注意到，解码器会话费很长一段时间来启动。如上所示，我们此次启动花费了133.871秒，并且CPU和内存一直处于满载状态。为了让解码器启动的更快一些，我们可以将短语表和词汇化再排序模型二进制化。注意，binarise操作需要使用cmph，如果没有按照本文档事先安装cmph，在此时才安装cmph，那么必须进入mosesdecoder安装文件夹重新执行.&#x2F;bjam，并补全编译参数重新编译moses。否则执行moses.ini时会报错。</p>
<p>我们要创建一个合适的目录并且按如下的命令来二进制化模型：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> \~/working/binarised-model</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> \~/working</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/bin/processPhraseTableMin \\</span><br><span class="line"></span><br><span class="line">\-<span class="keyword">in</span> train/model/phrase-table.gz -nscores 4 \\</span><br><span class="line"></span><br><span class="line">\-out binarised-model/phrase-table</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/bin/processLexicalTableMin \\</span><br><span class="line"></span><br><span class="line">\-<span class="keyword">in</span> train/model/reordering-table.wbe-msd-bidirectional-fe.gz \\</span><br><span class="line"></span><br><span class="line">\-out binarised-model/reordering-table</span><br></pre></td></tr></table></figure>

<p>输入命令，你会看到如下的信息，分别是将短语表和重排序表二值化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Used options:</span><br><span class="line"></span><br><span class="line">Text phrase table will be <span class="built_in">read</span> from: train/model/phrase-table.gz</span><br><span class="line"></span><br><span class="line">Output phrase table will be written to: binarised-model/phrase-table.minphr</span><br><span class="line"></span><br><span class="line">Step size <span class="keyword">for</span> <span class="built_in">source</span> landmark phrases: 2\^10=1024</span><br><span class="line"></span><br><span class="line">Source phrase fingerprint size: 16 bits / P(fp)=1.52588e-05</span><br><span class="line"></span><br><span class="line">Selected target phrase encoding: Huffman + PREnc</span><br><span class="line"></span><br><span class="line">Maxiumum allowed rank <span class="keyword">for</span> PREnc: 100</span><br><span class="line"></span><br><span class="line">Number of score components <span class="keyword">in</span> phrase table: 4</span><br><span class="line"></span><br><span class="line">Single Huffman code <span class="built_in">set</span> <span class="keyword">for</span> score components: no</span><br><span class="line"></span><br><span class="line">Using score quantization: no</span><br><span class="line"></span><br><span class="line">Explicitly included alignment information: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">Running with 1 threads</span><br><span class="line"></span><br><span class="line">Pass 1/3: Creating <span class="built_in">hash</span> <span class="keyword">function</span> <span class="keyword">for</span> rank assignment</span><br><span class="line"></span><br><span class="line">..................................................[5000000]</span><br><span class="line"></span><br><span class="line">..................................................[10000000]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Pass 2/3: Creating <span class="built_in">source</span> phrase index + Encoding target phrases</span><br><span class="line"></span><br><span class="line">..................................................[5000000]</span><br><span class="line"></span><br><span class="line">..................................................[10000000]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Intermezzo: Calculating Huffman code sets</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 90037 target phrase symbols</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 69575 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 5814858 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 58305 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 5407479 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 50 alignment points</span><br><span class="line"></span><br><span class="line">Pass 3/3: Compressing target phrases</span><br><span class="line"></span><br><span class="line">..................................................[5000000]</span><br><span class="line"></span><br><span class="line">..................................................[10000000]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Saving to binarised-model/phrase-table.minphr</span><br><span class="line"></span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line">Used options:</span><br><span class="line"></span><br><span class="line">Text reordering table will be <span class="built_in">read</span> from:</span><br><span class="line">train/model/reordering-table.wbe-msd-bidirectional-fe.gz</span><br><span class="line"></span><br><span class="line">Output reordering table will be written to:</span><br><span class="line">binarised-model/reordering-table.minlexr</span><br><span class="line"></span><br><span class="line">Step size <span class="keyword">for</span> <span class="built_in">source</span> landmark phrases: 2\^10=1024</span><br><span class="line"></span><br><span class="line">Phrase fingerprint size: 16 bits / P(fp)=1.52588e-05</span><br><span class="line"></span><br><span class="line">Single Huffman code <span class="built_in">set</span> <span class="keyword">for</span> score components: no</span><br><span class="line"></span><br><span class="line">Using score quantization: no</span><br><span class="line"></span><br><span class="line">Running with 1 threads</span><br><span class="line"></span><br><span class="line">Pass 1/2: Creating phrase index + Counting scores</span><br><span class="line"></span><br><span class="line">..................................................[5000000]</span><br><span class="line"></span><br><span class="line">..................................................[10000000]</span><br><span class="line"></span><br><span class="line">..................................................[15000000]</span><br><span class="line"></span><br><span class="line">........................</span><br><span class="line"></span><br><span class="line">Intermezzo: Calculating Huffman code sets</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 16117 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 8771 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 16117 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 15936 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 8975 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 16122 scores</span><br><span class="line"></span><br><span class="line">Pass 2/2: Compressing scores</span><br><span class="line"></span><br><span class="line">..................................................[5000000]</span><br><span class="line"></span><br><span class="line">..................................................[10000000]</span><br><span class="line"></span><br><span class="line">..................................................[15000000]</span><br><span class="line"></span><br><span class="line">........................</span><br><span class="line"></span><br><span class="line">Saving to binarised-model/reordering-table.minlexr</span><br><span class="line"></span><br><span class="line">Done</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：如果你遇到了如下的错误，请确保你在刚开始用CMPH来编译摩西。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> ...\~/mosesdecoder/bin/processPhraseTableMin: No such file or directory</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将 ~&#x2F;working&#x2F;mert-work&#x2F;moses.ini复制到binarised-model<br>目录中，并且改变短语和重排序表以让他们指向二进制版本，你可以按如下的命令运行：</p>
<ol>
<li><p>将 binarised-model目录下的Moses.ini文件中的# feature<br>functions一栏中的PhraseDictionaryMemory 改为 PhraseDictionaryCompact</p>
</li>
<li><p>将 binarised-model目录下的Moses.ini文件中的# feature<br>functions一栏中的PhraseDictionary 的路径设置为如下：</p>
</li>
</ol>
<p>$HOME&#x2F;working&#x2F;binarised-model&#x2F;phrase-table.minphr</p>
<ol>
<li>将 binarised-model目录下的Moses.ini文件中# feature<br>functions一栏中的LexicalReordering 的路径设置为如下：</li>
</ol>
<p>$HOME&#x2F;working&#x2F;binarised-model&#x2F;reordering-table</p>
<p>修改后的Moses.ini中的feature function部分如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\# feature functions</span><br><span class="line"></span><br><span class="line">[feature]</span><br><span class="line"></span><br><span class="line">UnknownWordPenalty</span><br><span class="line"></span><br><span class="line">WordPenalty</span><br><span class="line"></span><br><span class="line">PhrasePenalty</span><br><span class="line"></span><br><span class="line">PhraseDictionaryCompact name=TranslationModel0 num-features=4</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/working/binarised-model/phrase-table.minphr</span><br><span class="line">input-factor=0 output-factor=0</span><br><span class="line"></span><br><span class="line">LexicalReordering name=LexicalReordering0 num-features=6</span><br><span class="line">type=wbe-msd-bidirectional-fe-allff input-factor=0 output-factor=0</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/working/binarised-model/reordering-table</span><br><span class="line"></span><br><span class="line">Distortion</span><br><span class="line"></span><br><span class="line">KENLM name=LM0 factor=0</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/lm/un_en-zh23.blm.cn order=3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再次运行Moses:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\~/mosesdecoder/bin/moses -f \~/working/binarised-model/moses.ini</span><br></pre></td></tr></table></figure>

<p>接下来你会发现加载和运行一次翻译将会变得非常迅速。这里我们输入英语句子“however ,<br>there are good reasons for supporting the government .”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">Defined parameters (per moses.ini or switch):</span><br><span class="line"></span><br><span class="line">config: /home/ubuntu/corpus/un_en-zh_23/working/binarised-model/moses.ini</span><br><span class="line"></span><br><span class="line">distortion-limit: 6</span><br><span class="line"></span><br><span class="line">feature: UnknownWordPenalty WordPenalty PhrasePenalty PhraseDictionaryCompact</span><br><span class="line">name=TranslationModel0 num -features=4</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/working/binarised-model/phrase-table.minphr</span><br><span class="line">input-factor=0 outp ut-factor=0 LexicalReordering name=LexicalReordering0</span><br><span class="line">num-features=6 <span class="built_in">type</span>=wbe-msd-bidirectional-fe-allff input-f actor=0</span><br><span class="line">output-factor=0</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/working/binarised-model/reordering-table</span><br><span class="line">Distortion KENLM name=LM0 <span class="built_in">factor</span>=0</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/lm/un_en-zh23.blm.cn order=3</span><br><span class="line"></span><br><span class="line">input-factors: 0</span><br><span class="line"></span><br><span class="line">mapping: 0 T 0</span><br><span class="line"></span><br><span class="line">weight: LexicalReordering0= 0.0614344 0.0245557 0.242242 0.0725016 0.0539617</span><br><span class="line">0.0566553 Distortion0= 0.00 534453 LM0= 0.0696027 WordPenalty0= -0.166007</span><br><span class="line">PhrasePenalty0= 0.0688629 TranslationModel0= 0.0390017 0.0457273 0 .0730895</span><br><span class="line">0.0210141 UnknownWordPenalty0= 1</span><br><span class="line"></span><br><span class="line">line=UnknownWordPenalty</span><br><span class="line"></span><br><span class="line">FeatureFunction: UnknownWordPenalty0 start: 0 end: 0</span><br><span class="line"></span><br><span class="line">line=WordPenalty</span><br><span class="line"></span><br><span class="line">FeatureFunction: WordPenalty0 start: 1 end: 1</span><br><span class="line"></span><br><span class="line">line=PhrasePenalty</span><br><span class="line"></span><br><span class="line">FeatureFunction: PhrasePenalty0 start: 2 end: 2</span><br><span class="line"></span><br><span class="line">line=PhraseDictionaryCompact name=TranslationModel0 num-features=4</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/working/</span><br><span class="line">binarised-model/phrase-table.minphr input-factor=0 output-factor=0</span><br><span class="line"></span><br><span class="line">FeatureFunction: TranslationModel0 start: 3 end: 6</span><br><span class="line"></span><br><span class="line">line=LexicalReordering name=LexicalReordering0 num-features=6</span><br><span class="line"><span class="built_in">type</span>=wbe-msd-bidirectional-fe-allff input-factor=0 output-factor=0</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/working/binarised-model/reordering-table</span><br><span class="line"></span><br><span class="line">Initializing Lexical Reordering Feature..</span><br><span class="line"></span><br><span class="line">FeatureFunction: LexicalReordering0 start: 7 end: 12</span><br><span class="line"></span><br><span class="line">line=Distortion</span><br><span class="line"></span><br><span class="line">FeatureFunction: Distortion0 start: 13 end: 13</span><br><span class="line"></span><br><span class="line">line=KENLM name=LM0 <span class="built_in">factor</span>=0</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/lm/un_en-zh23.blm.cn order=3</span><br><span class="line"></span><br><span class="line">FeatureFunction: LM0 start: 14 end: 14</span><br><span class="line"></span><br><span class="line">Loading UnknownWordPenalty0</span><br><span class="line"></span><br><span class="line">Loading WordPenalty0</span><br><span class="line"></span><br><span class="line">Loading PhrasePenalty0</span><br><span class="line"></span><br><span class="line">Loading LexicalReordering0</span><br><span class="line"></span><br><span class="line">Loading Distortion0</span><br><span class="line"></span><br><span class="line">Loading LM0</span><br><span class="line"></span><br><span class="line">Loading TranslationModel0</span><br><span class="line"></span><br><span class="line">Created input-output object : [0.428] seconds</span><br><span class="line"></span><br><span class="line">however , there are good reasons <span class="keyword">for</span> supporting the government</span><br><span class="line"></span><br><span class="line">Translating: however , there are good reasons <span class="keyword">for</span> supporting the government</span><br><span class="line"></span><br><span class="line">Line 0: Initialize search took 0.000 seconds total</span><br><span class="line"></span><br><span class="line">Line 0: Collecting options took 0.567 seconds at moses/Manager.cpp Line 141</span><br><span class="line"></span><br><span class="line">Line 0: Search took 0.308 seconds</span><br><span class="line"></span><br><span class="line">然而 ， 有 充分 理由 支持 政府</span><br><span class="line"></span><br><span class="line">BEST TRANSLATION: 然而 ， 有 充分 理由 支持 政府 [1111111111] [total=-3.462]</span><br><span class="line">core=(0.000,-7.000,4.000,-13.611,-24.516,-3.431,-11.391,-3.059,0.000,0.000,-2.434,0.000,0.000,0.000,-34.379)</span><br><span class="line"></span><br><span class="line">Line 0: Decision rule took 0.000 seconds total</span><br><span class="line"></span><br><span class="line">Line 0: Additional reporting took 0.000 seconds total</span><br><span class="line"></span><br><span class="line">Line 0: Translation took 0.877 seconds total \\</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>你会发现，此次加载运行一次翻译系统只需0.877秒，而且在此期间，CPU和内存的占用几乎可以忽略不计。说明我们的二值化取得了非常良好的效果。在这一步，你可能很想知道这个翻译系统的表现如何。为了衡量这一点，我们使用另一组之前没有使用过的平行数据（测试集）。我们的测试集文件名称是un_test.cn和un_test.en。首先，和之前一样，我们需要对测试集进行tokenise<br>和truecase。</p>
<p>此处对un_test.cn进行tokenise时依然采用thulac分词工具，得到un_test.fc文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd \~/corpus</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/tokenizer/tokenizer.perl -l en \\</span><br><span class="line"></span><br><span class="line">\&lt; dev/un_test.en \&gt; un_test.tok.en</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/recaser/truecase.perl --model truecase-model.en \\</span><br><span class="line"></span><br><span class="line">\&lt; un_test.tok.en \&gt; un_test.true.en</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/recaser/truecase.perl --model truecase-model.cn \\</span><br><span class="line"></span><br><span class="line">\&lt; un_test.fc \&gt; un_test.true.cn</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以针对次测试机过滤我们训练过的模型，这意味着我们只保留需要的条目来翻译。这会使翻译速度加快一些。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd \~/working</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/training/filter-model-given-input.pl \\</span><br><span class="line"></span><br><span class="line">filtered-newstest2011 \~/working/mert-work/moses.ini \~/corpus/un_test.true.en</span><br><span class="line">\\</span><br><span class="line"></span><br><span class="line">\-Binarizer \~/mosesdecoder/bin/processPhraseTableMin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行命令后，你会看到如下的提示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Executing: <span class="built_in">mkdir</span> -p /home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test</span><br><span class="line"></span><br><span class="line">Stripping XML...</span><br><span class="line"></span><br><span class="line">Executing: /home/ubuntu/mosesdecoder/scripts/training/../generic/strip-xml.perl</span><br><span class="line">\&lt; /home/ubuntu/corpus/un_en-zh_23/test/un_test.true.en \&gt;</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/input.16677</span><br><span class="line"></span><br><span class="line">pt:PhraseDictionaryMemory name=TranslationModel0 num-features=4</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/working/train/model/phrase-table.gz</span><br><span class="line">input-factor=0 output-factor=0</span><br><span class="line"></span><br><span class="line">Considering <span class="built_in">factor</span> 0</span><br><span class="line"></span><br><span class="line">ro:LexicalReordering name=LexicalReordering0 num-features=6</span><br><span class="line"><span class="built_in">type</span>=wbe-msd-bidirectional-fe-allff input-factor=0 output-factor=0</span><br><span class="line">path=/home/ubuntu/corpus/un_en-zh_23/working/train/model/reordering-table.wbe-msd-bidirectional-fe.gz</span><br><span class="line"></span><br><span class="line">Considering <span class="built_in">factor</span> 0</span><br><span class="line"></span><br><span class="line">Filtering files...</span><br><span class="line"></span><br><span class="line">filtering /home/ubuntu/corpus/un_en-zh_23/working/train/model/phrase-table.gz</span><br><span class="line">-\&gt;</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/phrase-table.0-0.1.1...</span><br><span class="line"></span><br><span class="line">2351834 of 17491572 phrases pairs used (13.45%) - note: max length 10</span><br><span class="line"></span><br><span class="line">binarizing...</span><br><span class="line"></span><br><span class="line">Executing: gzip -<span class="built_in">cd</span></span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/phrase-table.0-0.1.1.gz \|</span><br><span class="line">LC_ALL=C <span class="built_in">sort</span> --compress-program gzip -T</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test \| gzip - \&gt;</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/phrase-table.0-0.1.1.gz.sorted.gz</span><br><span class="line">&amp;&amp; /home/ubuntu/mosesdecoder/bin/processPhraseTableMin -<span class="keyword">in</span></span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/phrase-table.0-0.1.1.gz.sorted.gz</span><br><span class="line">-out /home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/phrase-table.0-0.1.1</span><br><span class="line">-nscores 4 -threads 1 &amp;&amp; <span class="built_in">rm</span></span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/phrase-table.0-0.1.1.gz.sorted.gz</span><br><span class="line"></span><br><span class="line">Used options:</span><br><span class="line"></span><br><span class="line">Text phrase table will be <span class="built_in">read</span> from:</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/phrase-table.0-0.1.1.gz.sorted.gz</span><br><span class="line"></span><br><span class="line">Output phrase table will be written to:</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/phrase-table.0-0.1.1.minphr</span><br><span class="line"></span><br><span class="line">Step size <span class="keyword">for</span> <span class="built_in">source</span> landmark phrases: 2\^10=1024</span><br><span class="line"></span><br><span class="line">Source phrase fingerprint size: 16 bits / P(fp)=1.52588e-05</span><br><span class="line"></span><br><span class="line">Selected target phrase encoding: Huffman + PREnc</span><br><span class="line"></span><br><span class="line">Maxiumum allowed rank <span class="keyword">for</span> PREnc: 100</span><br><span class="line"></span><br><span class="line">Number of score components <span class="keyword">in</span> phrase table: 4</span><br><span class="line"></span><br><span class="line">Single Huffman code <span class="built_in">set</span> <span class="keyword">for</span> score components: no</span><br><span class="line"></span><br><span class="line">Using score quantization: no</span><br><span class="line"></span><br><span class="line">Explicitly included alignment information: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">Running with 1 threads</span><br><span class="line"></span><br><span class="line">Pass 1/3: Creating <span class="built_in">hash</span> <span class="keyword">function</span> <span class="keyword">for</span> rank assignment</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line"></span><br><span class="line">Pass 2/3: Creating <span class="built_in">source</span> phrase index + Encoding target phrases</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line"></span><br><span class="line">Intermezzo: Calculating Huffman code sets</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 37180 target phrase symbols</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 59255 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 779126 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 55190 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 1373326 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 50 alignment points</span><br><span class="line"></span><br><span class="line">Pass 3/3: Compressing target phrases</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line"></span><br><span class="line">Saving to</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/phrase-table.0-0.1.1.minphr</span><br><span class="line"></span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line">filtering</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/working/train/model/reordering-table.wbe-msd-bidirectional-fe.gz</span><br><span class="line">-\&gt;</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/reordering-table.wbe-msd-bidirectional-fe.0-0.1...</span><br><span class="line"></span><br><span class="line">2351834 of 17491572 phrases pairs used (13.45%) - note: max length 10</span><br><span class="line"></span><br><span class="line">binarizing...</span><br><span class="line"></span><br><span class="line">Executing: gzip -<span class="built_in">cd</span></span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/reordering-table.wbe-msd-bidirectional-fe.0-0.1.gz</span><br><span class="line">\| LC_ALL=C <span class="built_in">sort</span> --compress-program gzip -T</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test \| gzip - \&gt;</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/reordering-table.wbe-msd-bidirectional-fe.0-0.1.gz.sorted.gz</span><br><span class="line">&amp;&amp; /home/ubuntu/mosesdecoder/bin/processLexicalTableMin -<span class="keyword">in</span></span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/reordering-table.wbe-msd-bidirectional-fe.0-0.1.gz.sorted.gz</span><br><span class="line">-out</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/reordering-table.wbe-msd-bidirectional-fe.0-0.1</span><br><span class="line">-threads 1 &amp;&amp; <span class="built_in">rm</span></span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/reordering-table.wbe-msd-bidirectional-fe.0-0.1.gz.sorted.gz</span><br><span class="line"></span><br><span class="line">Used options:</span><br><span class="line"></span><br><span class="line">Text reordering table will be <span class="built_in">read</span> from:</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/reordering-table.wbe-msd-bidirectional-fe.0-0.1.gz.sorted.gz</span><br><span class="line"></span><br><span class="line">Output reordering table will be written to:</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/reordering-table.wbe-msd-bidirectional-fe.0-0.1.minlexr</span><br><span class="line"></span><br><span class="line">Step size <span class="keyword">for</span> <span class="built_in">source</span> landmark phrases: 2\^10=1024</span><br><span class="line"></span><br><span class="line">Phrase fingerprint size: 16 bits / P(fp)=1.52588e-05</span><br><span class="line"></span><br><span class="line">Single Huffman code <span class="built_in">set</span> <span class="keyword">for</span> score components: no</span><br><span class="line"></span><br><span class="line">Using score quantization: no</span><br><span class="line"></span><br><span class="line">Running with 1 threads</span><br><span class="line"></span><br><span class="line">Pass 1/2: Creating phrase index + Counting scores</span><br><span class="line"></span><br><span class="line">.......................</span><br><span class="line"></span><br><span class="line">Intermezzo: Calculating Huffman code sets</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 14663 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 8197 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 14660 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 14562 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 8162 scores</span><br><span class="line"></span><br><span class="line">Creating Huffman codes <span class="keyword">for</span> 14774 scores</span><br><span class="line"></span><br><span class="line">Pass 2/2: Compressing scores</span><br><span class="line"></span><br><span class="line">.......................</span><br><span class="line"></span><br><span class="line">Saving to</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/reordering-table.wbe-msd-bidirectional-fe.0-0.1.minlexr</span><br><span class="line"></span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line">To run the decoder, please call:</span><br><span class="line"></span><br><span class="line">moses -f /home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/moses.ini -i</span><br><span class="line">/home/ubuntu/corpus/un_en-zh_23/test/filtered-un_test/input.16677</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>你可以在第一次翻译测试数据时运行BLEU脚本来测试解码器。当然，这需要很短一段时间。命令中的<br>-lc是无视大小写的BLEU评分，不使用参数-lc是大小写敏感的BLEU评分。 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nohup nice \~/mosesdecoder/bin/moses \\</span><br><span class="line"></span><br><span class="line">\-f \~/working/filtered-un_test/moses.ini -i \\</span><br><span class="line"></span><br><span class="line">\&lt; \~/corpus/ un_test.true.en \\</span><br><span class="line"></span><br><span class="line">\&gt; \~/working/un_test.translated.cn \\</span><br><span class="line"></span><br><span class="line">2\&gt; \~/working/un_test.out</span><br><span class="line"></span><br><span class="line">\~/mosesdecoder/scripts/generic/multi-bleu.perl \\</span><br><span class="line"></span><br><span class="line">\-lc \~/corpus/un_test.true.cn \\</span><br><span class="line"></span><br><span class="line">\&lt; \~/working/un_test.translated.cn</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述命令中，un_test.true.en<br>是我们待翻译的文件，un_test.translated.cn是我们得到的翻译后的文件，un_test.out是我们在翻译过程中生成的日志文件，你可以用VIM工具查看其中的内容。</p>
<p>命令执行完成后，我们会得到如下的信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">BLEU = 29.29, 68.1/36.9/22.0/13.3 (BP=1.000, ratio=1.001, hyp_len=106809,</span><br><span class="line">ref_len=106725)</span><br><span class="line"></span><br><span class="line">It is in-advisable to publish scores from multi-bleu.perl. The scores depend on</span><br><span class="line">your tokenizer, which is unlikely to be reproducible from your paper or</span><br><span class="line">consistent across research groups. Instead you should detokenize then use</span><br><span class="line">mteval-v14.pl, which has a standard tokenization. Scores from multi-bleu.perl</span><br><span class="line">can still be used for internal purposes when you have a consistent tokenizer.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从multi-bleu.perl得到的分数是可信的。<br>最终得到的分数取决于你的分词工具的好坏，在你的论文中或者整个研究小组中每次得到的分数都应该是不同的。相反，你应该使用mteval-v14.pl，它可以进行标准的符号化。当您拥有一致的标记生成器时，来自multi-bleu.perl的分数仍可用于内部目的。</p>
<p>我们这里得到的BLEU成绩是29.29分，每次进行翻译时，得到的BLEU分数应该是不一样的。在tuning和最终test的时候参考译文的数量以及使用不同分词工具所造成的预处理的不同，语言模型是n-gram的不同都会影响到最终BLEU分数。</p>
<h2 id="八-搭建moses-server"><a href="#八-搭建moses-server" class="headerlink" title="八 搭建moses server"></a>八 搭建moses server</h2><p>如果希望把moses作为服务开放使用，必须通过设置将moses设为moses<br>server。具体步骤如下： <br>1.<br>安装xmlrpc（如果前面按照本文档已经安装xmlrpc，该步可以略过。否则参见该文档前半部分。安装完成后重新编译moses）。 <br>2. 修改moses.pl参数 <br>进入~&#x2F;mosesdecoder&#x2F;contrib&#x2F;iSenWeb文件夹，打开moses.pl文件，在该文件中指定moses和moses.ini(配置文件)的位置。我这里的MOSES参数为“&#x2F;home&#x2F;ubuntu&#x2F;mosesdecoder&#x2F;bin&#x2F;moses”，<br>MOSES_INI参数为”<br>&#x2F;home&#x2F;ubuntu&#x2F;corpus&#x2F;un_en-zh_23&#x2F;working&#x2F;binarised-model&#x2F;moses.ini”。关闭并保存。如下所示： </p>
<p>将Moses.pl文件中的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">\#------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">\# constants, global vars, config</span><br><span class="line"></span><br><span class="line">my \$MOSES = &#x27;/home/tianliang/research/moses-smt/scripts/training/model/moses&#x27;;</span><br><span class="line"></span><br><span class="line">my \$MOSES_INI =</span><br><span class="line">&#x27;/home/tianliang/research/moses-smt/scripts/training/model/moses.ini&#x27;;</span><br><span class="line"></span><br><span class="line">die &quot;usage: daemon.pl \&lt;hostname\&gt; \&lt;port\&gt;&quot; unless (\@ARGV == 2);</span><br><span class="line"></span><br><span class="line">my \$LISTEN_HOST = shift;</span><br><span class="line"></span><br><span class="line">my \$LISTEN_PORT = shift;</span><br><span class="line"></span><br><span class="line">\#------------------------------------------------------------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">\<span class="comment">#------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># constants, global vars, config</span></span><br><span class="line"></span><br><span class="line">my \<span class="variable">$MOSES</span> = <span class="string">&#x27;/home/ubuntu/mosesdecoder/bin/moses&#x27;</span>;</span><br><span class="line"></span><br><span class="line">my \<span class="variable">$MOSES_INI</span> =</span><br><span class="line"><span class="string">&#x27;/home/ubuntu/corpus/un_en-zh_23/working/binarised-model/moses.ini&#x27;</span>;</span><br><span class="line"></span><br><span class="line">die <span class="string">&quot;usage: daemon.pl \&lt;hostname\&gt; \&lt;port\&gt;&quot;</span> unless (\@ARGV == 2);</span><br><span class="line"></span><br><span class="line">my \<span class="variable">$LISTEN_HOST</span> = <span class="built_in">shift</span>;</span><br><span class="line"></span><br><span class="line">my \<span class="variable">$LISTEN_PORT</span> = <span class="built_in">shift</span>;</span><br><span class="line"></span><br><span class="line">\<span class="comment">#------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>进入到~&#x2F;mosesdecoder&#x2F;contrib&#x2F;iSenWeb文件夹，在terminal中输入：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">./moses.pl 192.168.0.1 9999</span><br></pre></td></tr></table></figure>

<p>即：moses.pl &lt;hostname&gt; &lt;port&gt;</p>
<p>其中， 192.168.1.1 是本机地址，9999是端口号。TCP&#x2F;IP协议中端口号的范围从0~65535,1024以下的端口用于系统服务，1024~65535端口我们可以使用。我们可以在&#x2F;etc&#x2F;service文件中看到各个端口的情况。</p>
<p>我们也可以持续运行moses server：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">nohup</span> \~ /mosesdecoder/contrib/iSenWeb/moses.pl 192.168.0.1 9999&amp;</span><br></pre></td></tr></table></figure>

<p>运行命令后会显示忽略输入并把输出追加到”nohup.out”。即成功运行了moses<br>server。在Linux中，nohup的意思是忽略SIGHUP信号， 所以当运行nohup .&#x2F;a.out的时候，<br>关闭shell,<br>那么a.out进程还是存在的，即对SIGHUP信号免疫。后面的&amp;符号意为让任务在后台运行。 运行后会在当前路径下产生一个文件nohup.out。</p>
<ol>
<li><p>测试翻译平台： </p>
</li>
<li><p>输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot; may I help you&quot;</span> \| nc 192.168.0.1 9999</span><br></pre></td></tr></table></figure></li>
</ol>
<p>可以看到返回结果：</p>
<p>我 是 否 可以 帮助 你</p>
<ol start="5">
<li>如果需要关闭moses server，使用killall moses.pl就可以了。</li>
</ol>
</h6></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ezharjan.github.io/Blog/2022/05/15/ES6%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/Blog/images/avatar.gif">
      <meta itemprop="name" content="Alexander Ezharjan">
      <meta itemprop="description" content="This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Blog/2022/05/15/ES6%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">ES6入门</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-15 19:33:20" itemprop="dateCreated datePublished" datetime="2022-05-15T19:33:20+08:00">2022-05-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-06 21:13:07" itemprop="dateModified" datetime="2024-04-06T21:13:07+08:00">2024-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Blog/categories/Notes/" itemprop="url" rel="index"><span itemprop="name">Notes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h6 align="center">编者：艾孜尔江<h6>

<h1 id="1-ECMAScirpt-6-简介"><a href="#1-ECMAScirpt-6-简介" class="headerlink" title="1. ECMAScirpt 6 简介"></a>1. ECMAScirpt 6 简介</h1><p>ESMAScript 6 是javascript 2016年发布的新标准。</p>
<h1 id="2-let和const命令"><a href="#2-let和const命令" class="headerlink" title="2. let和const命令"></a>2. let和const命令</h1><h3 id="2-1-let命令"><a href="#2-1-let命令" class="headerlink" title="2.1 let命令"></a>2.1 let命令</h3><h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><p><code>let</code> 声明的变量只在代码块中有效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  let a = 10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>for</code> 循环的计数器，就很适合使用<code>let</code>命令。此时计数器i只在循环体内有效。</p>
<p>另外，循环语句部分的变量和循环体内部的变量是分离的。</p>
<h4 id="不存在变量提升"><a href="#不存在变量提升" class="headerlink" title="不存在变量提升"></a>不存在变量提升</h4><p><code>let</code> 声明的变量不可以在声明之前被使用。否则会抛出错误。</p>
<h4 id="暂时性死区"><a href="#暂时性死区" class="headerlink" title="暂时性死区"></a>暂时性死区</h4><p>只要一个代码块中使用了<code>let</code>声明一个变量，则它的全局同名变量在该代码块中不可用。</p>
<p>总之，在代码块内，使用let命令声明变量之前，该变量都是不可用的。这在语法上，称为“暂时性死区”（temporal dead zone，简称 TDZ）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (true) &#123;</span><br><span class="line">  // TDZ开始</span><br><span class="line">  tmp = &#x27;abc&#x27;; // ReferenceError</span><br><span class="line">  console.log(tmp); // ReferenceError</span><br><span class="line"></span><br><span class="line">  let tmp; // TDZ结束</span><br><span class="line">  console.log(tmp); // undefined</span><br><span class="line"></span><br><span class="line">  tmp = 123;</span><br><span class="line">  console.log(tmp); // 123</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="不允许重复声明"><a href="#不允许重复声明" class="headerlink" title="不允许重复声明"></a>不允许重复声明</h4><p><code>let</code>不允许在相同作用域内，重复声明同一个变量。</p>
<h3 id="2-2块级作用域"><a href="#2-2块级作用域" class="headerlink" title="2.2块级作用域"></a>2.2块级作用域</h3><h4 id="为什么需要块级作用域？"><a href="#为什么需要块级作用域？" class="headerlink" title="为什么需要块级作用域？"></a>为什么需要块级作用域？</h4><ol>
<li>内层变量可能会覆盖外层变量。</li>
<li>用来计数的循环变量泄露为全局变量。</li>
</ol>
<h4 id="ES6-的块级作用域"><a href="#ES6-的块级作用域" class="headerlink" title="ES6 的块级作用域"></a>ES6 的块级作用域</h4><p><code>let</code>实际上为 JavaScript 新增了块级作用域。</p>
<p>ES6 允许块级作用域的任意嵌套。</p>
<p>内层作用域可以定义外层作用域的同名变量。</p>
<p>块级作用域的出现，实际上使得获得广泛应用的立即执行函数表达式（IIFE）不再必要了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// IIFE 写法</span><br><span class="line">(function () &#123;</span><br><span class="line">  var tmp = ...;</span><br><span class="line">  ...</span><br><span class="line">&#125;());</span><br><span class="line"></span><br><span class="line">// 块级作用域写法</span><br><span class="line">&#123;</span><br><span class="line">  let tmp = ...;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="块级作用域与函数声明"><a href="#块级作用域与函数声明" class="headerlink" title="块级作用域与函数声明"></a>块级作用域与函数声明</h4><p>ES5 规定，函数只能在顶层作用域和函数作用域之中声明，不能在块级作用域声明。</p>
<p>ES6 引入了块级作用域，明确允许在块级作用域之中声明函数。ES6 规定，块级作用域之中，函数声明语句的行为类似于<code>let</code>，在块级作用域之外不可引用。</p>
<p>考虑到环境导致的行为差异太大，应该避免在块级作用域内声明函数。如果确实需要，也应该写成函数表达式，而不是函数声明语句。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 函数声明语句</span><br><span class="line">&#123;</span><br><span class="line">  let a = &#x27;secret&#x27;;</span><br><span class="line">  function f() &#123;</span><br><span class="line">    return a;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 函数表达式</span><br><span class="line">&#123;</span><br><span class="line">  let a = &#x27;secret&#x27;;</span><br><span class="line">  let f = function () &#123;</span><br><span class="line">    return a;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="const命令"><a href="#const命令" class="headerlink" title="const命令"></a>const命令</h3><p><code>const</code>声明一个只读的常量。一旦声明，常量的值就不能改变。</p>
<p><code>const</code>的作用域与<code>let</code>命令相同：只在声明所在的块级作用域内有效。</p>
<h3 id="顶层对象的属性"><a href="#顶层对象的属性" class="headerlink" title="顶层对象的属性"></a>顶层对象的属性</h3><p>顶层对象，在浏览器环境指的是<code>window</code>对象，在Node指的是<code>global</code>对象。</p>
<p>ES6为了改变这一点，一方面规定，为了保持兼容性，<code>var</code>命令和<code>function</code>命令声明的全局变量，依旧是顶层对象的属性；另一方面规定，<code>let</code>命令、<code>const</code>命令、<code>class</code>命令声明的全局变量，不属于顶层对象的属性。也就是说，从ES6开始，全局变量将逐步与顶层对象的属性脱钩。</p>
<h3 id="global对象"><a href="#global对象" class="headerlink" title="global对象"></a>global对象</h3><p>垫片库<code>system.global</code>模拟了这个提案，可以在所有环境拿到<code>global</code>。</p>
<h1 id="3-变量的解构赋值"><a href="#3-变量的解构赋值" class="headerlink" title="3.变量的解构赋值"></a>3.变量的解构赋值</h1><h3 id="3-1数组的结构赋值"><a href="#3-1数组的结构赋值" class="headerlink" title="3.1数组的结构赋值"></a>3.1数组的结构赋值</h3><p>ES6 允许按照一定模式，从数组和对象中提取值，对变量进行赋值，这被称为解构（Destructuring）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let [a, b, c] = [1, 2, 3];</span><br></pre></td></tr></table></figure>
<p>解构赋值允许指定默认值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let [foo = true] = [];</span><br><span class="line">foo // true</span><br><span class="line"></span><br><span class="line">let [x, y = &#x27;b&#x27;] = [&#x27;a&#x27;]; // x=&#x27;a&#x27;, y=&#x27;b&#x27;</span><br><span class="line">let [x, y = &#x27;b&#x27;] = [&#x27;a&#x27;, undefined]; // x=&#x27;a&#x27;, y=&#x27;b&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="3-2对象的解构赋值"><a href="#3-2对象的解构赋值" class="headerlink" title="3.2对象的解构赋值"></a>3.2对象的解构赋值</h3><p>解构不仅可以用于数组，还可以用于对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let &#123; foo, bar &#125; = &#123; foo: &quot;aaa&quot;, bar: &quot;bbb&quot; &#125;;</span><br><span class="line">foo // &quot;aaa&quot;</span><br><span class="line">bar // &quot;bbb&quot;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-字符串的解构赋值"><a href="#3-3-字符串的解构赋值" class="headerlink" title="3.3 字符串的解构赋值"></a>3.3 字符串的解构赋值</h3><p>字符串也可以解构赋值。这是因为此时，字符串被转换成了一个类似数组的对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const [a, b, c, d, e] = &#x27;hello&#x27;;</span><br><span class="line">a // &quot;h&quot;</span><br><span class="line">b // &quot;e&quot;</span><br><span class="line">c // &quot;l&quot;</span><br><span class="line">d // &quot;l&quot;</span><br><span class="line">e // &quot;o&quot;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-数值和布尔值的解构赋值"><a href="#3-4-数值和布尔值的解构赋值" class="headerlink" title="3.4 数值和布尔值的解构赋值"></a>3.4 数值和布尔值的解构赋值</h3><p>解构赋值时，如果等号右边是数值和布尔值，则会先转为对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let &#123;toString: s&#125; = 123;</span><br><span class="line">s === Number.prototype.toString // true</span><br><span class="line"></span><br><span class="line">let &#123;toString: s&#125; = true;</span><br><span class="line">s === Boolean.prototype.toString // true</span><br></pre></td></tr></table></figure>
<h3 id="3-5-函数参数的解构赋值"><a href="#3-5-函数参数的解构赋值" class="headerlink" title="3.5 函数参数的解构赋值"></a>3.5 函数参数的解构赋值</h3><p>函数的参数也可以使用解构赋值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function add([x, y])&#123;</span><br><span class="line">  return x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add([1, 2]); // 3</span><br></pre></td></tr></table></figure>
<h3 id="3-6-用途"><a href="#3-6-用途" class="headerlink" title="3.6 用途"></a>3.6 用途</h3><ol>
<li>交换变量的值<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let x = 1;</span><br><span class="line">let y = 2;</span><br><span class="line"></span><br><span class="line">[x, y] = [y, x];</span><br></pre></td></tr></table></figure>
2.从函数返回多个值<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 返回一个数组</span><br><span class="line"></span><br><span class="line">function example() &#123;</span><br><span class="line">  return [1, 2, 3];</span><br><span class="line">&#125;</span><br><span class="line">let [a, b, c] = example();</span><br><span class="line"></span><br><span class="line">// 返回一个对象</span><br><span class="line"></span><br><span class="line">function example() &#123;</span><br><span class="line">  return &#123;</span><br><span class="line">    foo: 1,</span><br><span class="line">    bar: 2</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">let &#123; foo, bar &#125; = example();</span><br></pre></td></tr></table></figure>
3.函数参数的定义<br>解构赋值可以方便地将一组参数与变量名对应起来。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 参数是一组有次序的值</span><br><span class="line">function f([x, y, z]) &#123; ... &#125;</span><br><span class="line">f([1, 2, 3]);</span><br><span class="line"></span><br><span class="line">// 参数是一组无次序的值</span><br><span class="line">function f(&#123;x, y, z&#125;) &#123; ... &#125;</span><br><span class="line">f(&#123;z: 3, y: 2, x: 1&#125;);</span><br></pre></td></tr></table></figure></li>
<li>提取JSON数据<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">let jsonData = &#123;</span><br><span class="line">  id: 42,</span><br><span class="line">  status: &quot;OK&quot;,</span><br><span class="line">  data: [867, 5309]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">let &#123; id, status, data: number &#125; = jsonData;</span><br><span class="line"></span><br><span class="line">console.log(id, status, number);</span><br><span class="line">// 42, &quot;OK&quot;, [867, 5309]</span><br></pre></td></tr></table></figure></li>
<li>函数参数的默认值<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">jQuery.ajax = function (url, &#123;</span><br><span class="line">  async = true,</span><br><span class="line">  beforeSend = function () &#123;&#125;,</span><br><span class="line">  cache = true,</span><br><span class="line">  complete = function () &#123;&#125;,</span><br><span class="line">  crossDomain = false,</span><br><span class="line">  global = true,</span><br><span class="line">  // ... more config</span><br><span class="line">&#125;) &#123;</span><br><span class="line">  // ... do stuff</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
6.遍历map结构<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var map = new Map();</span><br><span class="line">map.set(&#x27;first&#x27;, &#x27;hello&#x27;);</span><br><span class="line">map.set(&#x27;second&#x27;, &#x27;world&#x27;);</span><br><span class="line"></span><br><span class="line">for (let [key, value] of map) &#123;</span><br><span class="line">  console.log(key + &quot; is &quot; + value);</span><br><span class="line">&#125;</span><br><span class="line">// first is hello</span><br><span class="line">// second is world</span><br></pre></td></tr></table></figure></li>
<li>输入模块的指定方法<br>加载模块时，往往需要指定输入哪些方法。解构赋值使得输入语句非常清晰。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const &#123; SourceMapConsumer, SourceNode &#125; = require(&quot;source-map&quot;);</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="4-字符串的扩展"><a href="#4-字符串的扩展" class="headerlink" title="4. 字符串的扩展"></a>4. 字符串的扩展</h1><h3 id="4-1字符的Unicode表示法"><a href="#4-1字符的Unicode表示法" class="headerlink" title="4.1字符的Unicode表示法"></a>4.1字符的Unicode表示法</h3><p>ES6 对这一点做出了改进，只要将码点放入大括号，就能正确解读该字符。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;\u&#123;20BB7&#125;&quot;</span><br><span class="line">// &quot;𠮷&quot;</span><br><span class="line"></span><br><span class="line">&quot;\u&#123;41&#125;\u&#123;42&#125;\u&#123;43&#125;&quot;</span><br><span class="line">// &quot;ABC&quot;</span><br><span class="line"></span><br><span class="line">let hello = 123;</span><br><span class="line">hell\u&#123;6F&#125; // 123</span><br><span class="line"></span><br><span class="line">&#x27;\u&#123;1F680&#125;&#x27; === &#x27;\uD83D\uDE80&#x27;</span><br><span class="line">// true</span><br></pre></td></tr></table></figure>
<h3 id="4-2-codePointAt"><a href="#4-2-codePointAt" class="headerlink" title="4.2 codePointAt()"></a>4.2 codePointAt()</h3><p>ES6提供了codePointAt方法，能够正确处理4个字节储存的字符，返回一个字符的码点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var s = &#x27;𠮷a&#x27;;</span><br><span class="line"></span><br><span class="line">s.codePointAt(0) // 134071</span><br><span class="line">s.codePointAt(1) // 57271</span><br><span class="line">s.codePointAt(2) // 97</span><br></pre></td></tr></table></figure>
<h3 id="4-3-String-fromCodePoint"><a href="#4-3-String-fromCodePoint" class="headerlink" title="4.3 String.fromCodePoint()"></a>4.3 String.fromCodePoint()</h3><p>ES5提供String.fromCharCode方法，用于从码点返回对应字符。</p>
<h3 id="4-4-字符串的遍历器接口"><a href="#4-4-字符串的遍历器接口" class="headerlink" title="4.4 字符串的遍历器接口"></a>4.4 字符串的遍历器接口</h3><p>ES6为字符串添加了遍历器接口，使得字符串可以被for…of循环遍历。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (let codePoint of &#x27;foo&#x27;) &#123;</span><br><span class="line">  console.log(codePoint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-at"><a href="#4-5-at" class="headerlink" title="4.5 at()"></a>4.5 at()</h3><p>ES5对字符串对象提供charAt方法，返回字符串给定位置的字符。</p>
<h3 id="4-7-includes-startsWith-endsWith"><a href="#4-7-includes-startsWith-endsWith" class="headerlink" title="4.7 includes(), startsWith(), endsWith()"></a>4.7 includes(), startsWith(), endsWith()</h3><ul>
<li>includes()：返回布尔值，表示是否找到了参数字符串。</li>
<li>startsWith()：返回布尔值，表示参数字符串是否在源字符串的头部。</li>
<li>endsWith()：返回布尔值，表示参数字符串是否在源字符串的尾部。</li>
</ul>
<h3 id="4-8-repeat"><a href="#4-8-repeat" class="headerlink" title="4.8 repeat()"></a>4.8 repeat()</h3><p>repeat方法返回一个新字符串，表示将原字符串重复n次。</p>
<h3 id="4-9-padStart-，padEnd"><a href="#4-9-padStart-，padEnd" class="headerlink" title="4.9 padStart()，padEnd()"></a>4.9 padStart()，padEnd()</h3><p>ES2017引入了字符串补全长度的功能。如果某个字符串不够指定长度，会在头部或尾部补全。padStart()用于头部补全，padEnd()用于尾部补全。</p>
<h3 id="4-10-模板字符串"><a href="#4-10-模板字符串" class="headerlink" title="4.10 模板字符串"></a>4.10 模板字符串</h3><p>模板字符串（template string）是增强版的字符串，用反引号（&#96;）标识。它可以当作普通字符串使用，也可以用来定义多行字符串，或者在字符串中嵌入变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 普通字符串</span><br><span class="line">`In JavaScript &#x27;\n&#x27; is a line-feed.`</span><br><span class="line"></span><br><span class="line">// 多行字符串</span><br><span class="line">`In JavaScript this is</span><br><span class="line"> not legal.`</span><br><span class="line"></span><br><span class="line">console.log(`string text line 1</span><br><span class="line">string text line 2`);</span><br><span class="line"></span><br><span class="line">// 字符串中嵌入变量</span><br><span class="line">var name = &quot;Bob&quot;, time = &quot;today&quot;;</span><br><span class="line">`Hello $&#123;name&#125;, how are you $&#123;time&#125;?`</span><br></pre></td></tr></table></figure>

<p>上面代码中，所有模板字符串的空格和换行，都是被保留的，比如<ul>标签前面会有一个换行。如果你不想要这个换行，可以使用trim方法消除它。</ul></p>
<p>模板字符串中嵌入变量，需要将变量名写在${}之中。<br>模板字符串之中还能调用函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">`foo <span class="subst">$&#123;fn()&#125;</span> bar`</span></span><br></pre></td></tr></table></figure>

<h3 id="4-12-标签模板"><a href="#4-12-标签模板" class="headerlink" title="4.12 标签模板"></a>4.12 标签模板</h3><h3 id="4-13-String-raw"><a href="#4-13-String-raw" class="headerlink" title="4.13 String.raw()"></a>4.13 String.raw()</h3><p>String.raw方法，往往用来充当模板字符串的处理函数，返回一个斜杠都被转义（即斜杠前面再加一个斜杠）的字符串，对应于替换变量后的模板字符串。</p>
<h1 id="5-正则的扩展（跳过）"><a href="#5-正则的扩展（跳过）" class="headerlink" title="5. 正则的扩展（跳过）"></a>5. 正则的扩展（跳过）</h1><h1 id="6-数值的扩展"><a href="#6-数值的扩展" class="headerlink" title="6. 数值的扩展"></a>6. 数值的扩展</h1><h3 id="6-1-二进制和八进制表示法"><a href="#6-1-二进制和八进制表示法" class="headerlink" title="6.1 二进制和八进制表示法"></a>6.1 二进制和八进制表示法</h3><p>ES6 提供了二进制和八进制数值的新的写法，分别用前缀0b（或0B）和0o（或0O）表示。</p>
<h3 id="6-2-Number-isFinite-Number-isNaN"><a href="#6-2-Number-isFinite-Number-isNaN" class="headerlink" title="6.2 Number.isFinite(), Number.isNaN()"></a>6.2 Number.isFinite(), Number.isNaN()</h3><p>Number.isFinite()用来检查一个数值是否为有限的（finite）。<br>Number.isNaN()用来检查一个值是否为NaN。</p>
<h1 id="7-函数的扩展"><a href="#7-函数的扩展" class="headerlink" title="7. 函数的扩展"></a>7. 函数的扩展</h1><h3 id="函数参数的默认值"><a href="#函数参数的默认值" class="headerlink" title="函数参数的默认值"></a>函数参数的默认值</h3><p>ES6 允许为函数的参数设置默认值，即直接写在参数定义的后面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">log</span>(<span class="params">x, y = <span class="string">&#x27;World&#x27;</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(x, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数变量是默认声明的，所以不能用let或const再次声明。</p>
<h3 id="与解构赋值默认值结合使用"><a href="#与解构赋值默认值结合使用" class="headerlink" title="与解构赋值默认值结合使用"></a>与解构赋值默认值结合使用</h3><p>参数默认值可以与解构赋值的默认值，结合起来使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">&#123;x, y = <span class="number">5</span>&#125;</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(x, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参数默认值的位置"><a href="#参数默认值的位置" class="headerlink" title="参数默认值的位置"></a>参数默认值的位置</h3><p>通常情况下，定义了默认值的参数，应该是函数的尾参数。因为这样比较容易看出来，到底省略了哪些参数。如果非尾部的参数设置默认值，实际上这个参数是没法省略的。</p>
<h3 id="函数的length属性"><a href="#函数的length属性" class="headerlink" title="函数的length属性"></a>函数的length属性</h3><p>指定了默认值以后，函数的length属性，将返回没有指定默认值的参数个数。也就是说，指定了默认值后，length属性将失真。</p>
<p>这是因为length属性的含义是，该函数预期传入的参数个数。某个参数指定默认值以后，预期传入的参数个数就不包括这个参数了。同理，rest 参数也不会计入length属性。</p>
<p>如果设置了默认值的参数不是尾参数，那么length属性也不再计入后面的参数了。</p>
<h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><p>一旦设置了参数的默认值，函数进行声明初始化时，参数会形成一个单独的作用域（context）。等到初始化结束，这个作用域就会消失。</p>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>利用参数默认值，可以指定某一个参数不得省略，如果省略就抛出一个错误。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">throwIfMissing</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Missing parameter&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">mustBeProvided = throwIfMissing()</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> mustBeProvided;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rest参数"><a href="#rest参数" class="headerlink" title="rest参数"></a>rest参数</h3><p>ES6 引入 rest 参数（<strong>形式为…变量名</strong>），用于获取函数的多余参数，这样就不需要使用arguments对象了。rest 参数搭配的变量是一个数组，该变量将多余的参数放入数组中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">...values</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> val <span class="keyword">of</span> values) &#123;</span><br><span class="line">    sum += val;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">add</span>(<span class="number">2</span>, <span class="number">5</span>, <span class="number">3</span>) <span class="comment">// 10</span></span><br></pre></td></tr></table></figure>

<h3 id="严格模式"><a href="#严格模式" class="headerlink" title="严格模式"></a>严格模式</h3><p>ES2016 做了一点修改，规定只要函数参数使用了默认值、解构赋值、或者扩展运算符，那么函数内部就不能显式设定为严格模式，否则会报错。</p>
<h3 id="name属性"><a href="#name属性" class="headerlink" title="name属性"></a>name属性</h3><p>函数的name属性，返回该函数的函数名。</p>
<h3 id="箭头函数"><a href="#箭头函数" class="headerlink" title="箭头函数"></a>箭头函数</h3><p>ES6 允许使用“箭头”（&#x3D;&gt;）定义函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title function_">f</span> = v =&gt; v;</span><br></pre></td></tr></table></figure>
<p>第一个v为参数，第二个v为返回值。</p>
<p>箭头函数的一个用处是简化回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正常函数写法</span></span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">x</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 箭头函数写法</span></span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x * x);</span><br></pre></td></tr></table></figure>
<h3 id="尾调用优化"><a href="#尾调用优化" class="headerlink" title="尾调用优化"></a>尾调用优化</h3><p>尾调用（Tail Call）是函数式编程的一个重要概念，本身非常简单，一句话就能说清楚，就是指某个函数的最后一步是调用另一个函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">x</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">g</span>(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尾调用之所以与其他调用不同，就在于它的特殊的调用位置。</p>
<p>我们知道，函数调用会在内存形成一个“调用记录”，又称“调用帧”（call frame），保存调用位置和内部变量等信息。如果在函数A的内部调用函数B，那么在A的调用帧上方，还会形成一个B的调用帧。等到B运行结束，将结果返回到A，B的调用帧才会消失。如果函数B内部还调用函数C，那就还有一个C的调用帧，以此类推。所有的调用帧，就形成一个“调用栈”（call stack）。</p>
<p>尾调用由于是函数的最后一步操作，所以不需要保留外层函数的调用帧，因为调用位置、内部变量等信息都不会再用到了，只要直接用内层函数的调用帧，取代外层函数的调用帧就可以了。</p>
<h3 id="尾递归"><a href="#尾递归" class="headerlink" title="尾递归"></a>尾递归</h3><p>函数调用自身，称为递归。如果尾调用自身，就称为尾递归。</p>
<p>递归非常耗费内存，因为需要同时保存成千上百个调用帧，很容易发生“栈溢出”错误（stack overflow）。但对于尾递归来说，由于只存在一个调用帧，所以永远不会发生“栈溢出”错误。</p>
<p>由此可见，“尾调用优化”对递归操作意义重大，所以一些函数式编程语言将其写入了语言规格。ES6 是如此，第一次明确规定，所有 ECMAScript 的实现，都必须部署“尾调用优化”。这就是说，ES6 中只要使用尾递归，就不会发生栈溢出，相对节省内存。</p>
<h3 id="函数参数的尾逗号"><a href="#函数参数的尾逗号" class="headerlink" title="函数参数的尾逗号"></a>函数参数的尾逗号</h3><p>ES2017 允许函数的最后一个参数有尾逗号（trailing comma）。</p>
<h1 id="8-数组的扩展"><a href="#8-数组的扩展" class="headerlink" title="8. 数组的扩展"></a>8. 数组的扩展</h1><h3 id="扩展运算符"><a href="#扩展运算符" class="headerlink" title="扩展运算符"></a>扩展运算符</h3><p>扩展运算符（spread）是三个点（…）。它好比 rest 参数的逆运算，将一个数组转为用逗号分隔的参数序列。</p>
<p>扩展运算符与正常的函数参数可以结合使用，非常灵活。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">v, w, x, y, z</span>) &#123; &#125;</span><br><span class="line"><span class="keyword">var</span> args = [<span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line"><span class="title function_">f</span>(-<span class="number">1</span>, ...args, <span class="number">2</span>, ...[<span class="number">3</span>]);</span><br></pre></td></tr></table></figure>

<h3 id="替代数组的apply方法"><a href="#替代数组的apply方法" class="headerlink" title="替代数组的apply方法"></a>替代数组的apply方法</h3><p>由于扩展运算符可以展开数组，所以不再需要apply方法，将数组转为函数的参数了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES5 的写法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">x, y, z</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> args = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">f.<span class="title function_">apply</span>(<span class="literal">null</span>, args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ES6的写法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">x, y, z</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> args = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="title function_">f</span>(...args);</span><br></pre></td></tr></table></figure>

<h3 id="扩展运算符的应用"><a href="#扩展运算符的应用" class="headerlink" title="扩展运算符的应用"></a>扩展运算符的应用</h3><h4 id="1-合并数组"><a href="#1-合并数组" class="headerlink" title="1. 合并数组"></a>1. 合并数组</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES5的合并数组</span></span><br><span class="line">arr1.<span class="title function_">concat</span>(arr2, arr3);</span><br><span class="line"><span class="comment">// [ &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27; ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ES6的合并数组</span></span><br><span class="line">[...arr1, ...arr2, ...arr3]</span><br><span class="line"><span class="comment">// [ &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27; ]</span></span><br></pre></td></tr></table></figure>

<h4 id="2-与结构赋值结合"><a href="#2-与结构赋值结合" class="headerlink" title="2. 与结构赋值结合"></a>2. 与结构赋值结合</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [first, ...rest] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">first <span class="comment">// 1</span></span><br><span class="line">rest  <span class="comment">// [2, 3, 4, 5]</span></span><br></pre></td></tr></table></figure>

<h4 id="3-函数的返回值"><a href="#3-函数的返回值" class="headerlink" title="3. 函数的返回值"></a>3. 函数的返回值</h4><p>JavaScript 的函数只能返回一个值，如果需要返回多个值，只能返回数组或对象。扩展运算符提供了解决这个问题的一种变通方法。</p>
<h4 id="4-字符串"><a href="#4-字符串" class="headerlink" title="4. 字符串"></a>4. 字符串</h4><p>扩展运算符还可以将字符串转为真正的数组。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[...<span class="string">&#x27;hello&#x27;</span>]</span><br><span class="line"><span class="comment">// [ &quot;h&quot;, &quot;e&quot;, &quot;l&quot;, &quot;l&quot;, &quot;o&quot; ]</span></span><br></pre></td></tr></table></figure>

<h4 id="5-实现了Iterator接口的对象"><a href="#5-实现了Iterator接口的对象" class="headerlink" title="5. 实现了Iterator接口的对象"></a>5. 实现了Iterator接口的对象</h4><p>任何 Iterator 接口的对象，都可以用扩展运算符转为真正的数组。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nodeList = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> array = [...nodeList];</span><br></pre></td></tr></table></figure>
<p>上面代码中，querySelectorAll方法返回的是一个nodeList对象。它不是数组，而是一个类似数组的对象。这时，扩展运算符可以将其转为真正的数组，原因就在于NodeList对象实现了 Iterator 。</p>
<h3 id="Array-form"><a href="#Array-form" class="headerlink" title="Array.form()"></a>Array.form()</h3><p>Array.from方法用于将两类对象转为真正的数组：类似数组的对象（array-like object）和可遍历（iterable）的对象（包括ES6新增的数据结构Set和Map）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> arrayLike = &#123;</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;1&#x27;</span>: <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;2&#x27;</span>: <span class="string">&#x27;c&#x27;</span>,</span><br><span class="line">    <span class="attr">length</span>: <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ES5的写法</span></span><br><span class="line"><span class="keyword">var</span> arr1 = [].<span class="property">slice</span>.<span class="title function_">call</span>(arrayLike); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ES6的写法</span></span><br><span class="line"><span class="keyword">let</span> arr2 = <span class="title class_">Array</span>.<span class="title function_">from</span>(arrayLike); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>Array.from()的另一个应用是，将字符串转为数组，然后返回字符串的长度。因为它能正确处理各种Unicode字符，可以避免JavaScript将大于\uFFFF的Unicode字符，算作两个字符的bug。</p>
<h3 id="Array-of"><a href="#Array-of" class="headerlink" title="Array.of( )"></a>Array.of( )</h3><p>Array.of方法用于将一组值，转换为数组。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Array</span>.<span class="title function_">of</span>(<span class="number">3</span>, <span class="number">11</span>, <span class="number">8</span>) <span class="comment">// [3,11,8]</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="title function_">of</span>(<span class="number">3</span>) <span class="comment">// [3]</span></span><br><span class="line"><span class="title class_">Array</span>.<span class="title function_">of</span>(<span class="number">3</span>).<span class="property">length</span> <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>

<h3 id="数组示例的copyWithin"><a href="#数组示例的copyWithin" class="headerlink" title="数组示例的copyWithin()"></a>数组示例的copyWithin()</h3><p>数组实例的copyWithin方法，在当前数组内部，将指定位置的成员复制到其他位置（会覆盖原有成员），然后返回当前数组。也就是说，使用这个方法，会修改当前数组。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">copyWithin</span>(target, start = <span class="number">0</span>, end = <span class="variable language_">this</span>.<span class="property">length</span>)</span><br></pre></td></tr></table></figure>
<p>它接受三个参数。</p>
<ul>
<li>target（必需）：从该位置开始替换数据。</li>
<li>start（可选）：从该位置开始读取数据，默认为0。如果为负值，表示倒数。</li>
<li>end（可选）：到该位置前停止读取数据，默认等于数组长度。如果为负值，表示倒数。</li>
</ul>
<p>这三个参数都应该是数值，如果不是，会自动转为数值。</p>
<h3 id="数组实例的find-和findIndex"><a href="#数组实例的find-和findIndex" class="headerlink" title="数组实例的find()和findIndex()"></a>数组实例的find()和findIndex()</h3><p>数组实例的find方法，用于找出第一个符合条件的数组成员。它的参数是一个回调函数，所有数组成员依次执行该回调函数，直到找出第一个返回值为true的成员，然后返回该成员。如果没有符合条件的成员，则返回undefined。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">4</span>, -<span class="number">5</span>, <span class="number">10</span>].<span class="title function_">find</span>(<span class="function">(<span class="params">n</span>) =&gt;</span> n &lt; <span class="number">0</span>)</span><br><span class="line"><span class="comment">// -5</span></span><br></pre></td></tr></table></figure>
<p>上面代码找出数组中第一个小于0的成员。</p>
<p>数组实例的findIndex方法的用法与find方法非常类似，返回第一个符合条件的数组成员的位置，如果所有成员都不符合条件，则返回-1。</p>
<h3 id="数组实例的fill"><a href="#数组实例的fill" class="headerlink" title="数组实例的fill()"></a>数组实例的fill()</h3><p>fill方法使用给定值，填充一个数组。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>].<span class="title function_">fill</span>(<span class="number">7</span>)</span><br><span class="line"><span class="comment">// [7, 7, 7]</span></span><br></pre></td></tr></table></figure>
<h3 id="数组实例的entries-keys-values"><a href="#数组实例的entries-keys-values" class="headerlink" title="数组实例的entries(),keys(),values()"></a>数组实例的entries(),keys(),values()</h3><p>ES6 提供三个新的方法——entries()，keys()和values()——用于遍历数组。它们都返回一个遍历器对象（详见《Iterator》一章），可以用for…of循环进行遍历，唯一的区别是keys()是对键名的遍历、values()是对键值的遍历，entries()是对键值对的遍历。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">of</span> [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>].<span class="title function_">keys</span>()) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(index);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> elem <span class="keyword">of</span> [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>].<span class="title function_">values</span>()) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(elem);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &#x27;a&#x27;</span></span><br><span class="line"><span class="comment">// &#x27;b&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> [index, elem] <span class="keyword">of</span> [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>].<span class="title function_">entries</span>()) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(index, elem);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 0 &quot;a&quot;</span></span><br><span class="line"><span class="comment">// 1 &quot;b&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="数组实例的includes"><a href="#数组实例的includes" class="headerlink" title="数组实例的includes()"></a>数组实例的includes()</h3><p>Array.prototype.includes方法返回一个布尔值，表示某个数组是否包含给定的值，与字符串的includes方法类似。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].<span class="title function_">includes</span>(<span class="number">2</span>)     <span class="comment">// true</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].<span class="title function_">includes</span>(<span class="number">4</span>)     <span class="comment">// false</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="title class_">NaN</span>].<span class="title function_">includes</span>(<span class="title class_">NaN</span>) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h3 id="数组的空位"><a href="#数组的空位" class="headerlink" title="数组的空位"></a>数组的空位</h3><p>数组的空位指，数组的某一个位置没有任何值。比如，Array构造函数返回的数组都是空位。</p>
<p>ES6 则是明确将空位转为undefined。</p>
<p>由于空位的处理规则非常不统一，所以建议避免出现空位。</p>
<h1 id="9-对象的扩展"><a href="#9-对象的扩展" class="headerlink" title="9. 对象的扩展"></a>9. 对象的扩展</h1><h3 id="属性的简洁表示法"><a href="#属性的简洁表示法" class="headerlink" title="属性的简洁表示法"></a>属性的简洁表示法</h3><p>ES6 允许直接写入变量和函数，作为对象的属性和方法。这样的书写更加简洁。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="string">&#x27;bar&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> baz = &#123;foo&#125;;</span><br><span class="line">baz <span class="comment">// &#123;foo: &quot;bar&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="keyword">var</span> baz = &#123;<span class="attr">foo</span>: foo&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="属性名表达式"><a href="#属性名表达式" class="headerlink" title="属性名表达式"></a>属性名表达式</h3><p>ES6 允许字面量定义对象时，用表达式作为对象的属性名，即把表达式放在方括号内。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> propKey = <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">  [propKey]: <span class="literal">true</span>,</span><br><span class="line">  [<span class="string">&#x27;a&#x27;</span> + <span class="string">&#x27;bc&#x27;</span>]: <span class="number">123</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="方法的name属性"><a href="#方法的name属性" class="headerlink" title="方法的name属性"></a>方法的name属性</h3><p>函数的name属性，返回函数名。对象方法也是函数，因此也有name属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person = &#123;</span><br><span class="line">  <span class="title function_">sayName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello!&#x27;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">person.<span class="property">sayName</span>.<span class="property">name</span>   <span class="comment">// &quot;sayName&quot;</span></span><br></pre></td></tr></table></figure>
<p>如果对象的方法是一个 Symbol 值，那么name属性返回的是这个 Symbol 值的描述。</p>
<h3 id="Object-is"><a href="#Object-is" class="headerlink" title="Object.is()"></a>Object.is()</h3><p>ES6提出“Same-value equality”（同值相等）算法，用来解决这个问题。Object.is就是部署这个算法的新方法。它用来比较两个值是否严格相等，与严格比较运算符（&#x3D;&#x3D;&#x3D;）的行为基本一致。</p>
<p>不同之处只有两个：一是+0不等于-0，二是NaN等于自身。</p>
<h3 id="Object-assign"><a href="#Object-assign" class="headerlink" title="Object.assign()"></a>Object.assign()</h3><p>Object.assign方法用于对象的合并，将源对象（source）的所有可枚举属性，复制到目标对象（target）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> target = &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source1 = &#123; <span class="attr">b</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> source2 = &#123; <span class="attr">c</span>: <span class="number">3</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">assign</span>(target, source1, source2);</span><br><span class="line">target <span class="comment">// &#123;a:1, b:2, c:3&#125;</span></span><br></pre></td></tr></table></figure>
<p>Object.assign方法的第一个参数是目标对象，后面的参数都是源对象。</p>
<p>Object.assign拷贝的属性是有限制的，只拷贝源对象的自身属性（不拷贝继承属性），也不拷贝不可枚举的属性（enumerable: false）。</p>
<p>Object.assign方法实行的是浅拷贝，而不是深拷贝。也就是说，如果源对象某个属性的值是对象，那么目标对象拷贝得到的是这个对象的引用。</p>
<h4 id="Object-assign-的用途"><a href="#Object-assign-的用途" class="headerlink" title="Object.assign()的用途"></a>Object.assign()的用途</h4><ol>
<li>为对象添加属性<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>, &#123;x, y&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>为对象添加方法</li>
<li>克隆对象</li>
<li>合并多个对象</li>
<li>为属性制定默认值</li>
</ol>
<h3 id="属性的可枚举性"><a href="#属性的可枚举性" class="headerlink" title="属性的可枚举性"></a>属性的可枚举性</h3><p>对象的每个属性都有一个描述对象（Descriptor），用来控制该属性的行为。Object.getOwnPropertyDescriptor方法可以获取该属性的描述对象。</p>
<p>描述对象的enumerable属性，称为”可枚举性“，如果该属性为false，就表示某些操作会忽略当前属性。</p>
<p>ES5 有三个操作会忽略enumerable为false的属性。</p>
<ul>
<li>for…in循环：只遍历对象自身的和继承的可枚举的属性</li>
<li>Object.keys()：返回对象自身的所有可枚举的属性的键名</li>
<li>JSON.stringify()：只串行化对象自身的可枚举的属性</li>
</ul>
<p>ES6 新增了一个操作Object.assign()，会忽略enumerable为false的属性，只拷贝对象自身的可枚举的属性。</p>
<h3 id="属性的遍历"><a href="#属性的遍历" class="headerlink" title="属性的遍历"></a>属性的遍历</h3><p>ES6 一共有5种方法可以遍历对象的属性。</p>
<ol>
<li>for in</li>
<li>Object.keys(obj)</li>
<li>Object.getOwnPropertyNames(obj)</li>
<li>Object.getOwnPropertySymbols(obj)</li>
<li>Reflect.ownKeys(obj)</li>
</ol>
<h3 id="proto-属性，"><a href="#proto-属性，" class="headerlink" title="__proto__属性，"></a>__proto__属性，</h3><p>__proto__属性（前后各两个下划线），用来读取或设置当前对象的prototype对象。目前，所有浏览器（包括 IE11）都部署了这个属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// es6的写法</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123; ... &#125;</span><br><span class="line">&#125;;</span><br><span class="line">obj.<span class="property">__proto__</span> = someOtherObj;</span><br><span class="line"></span><br><span class="line"><span class="comment">// es5的写法</span></span><br><span class="line"><span class="keyword">var</span> obj = <span class="title class_">Object</span>.<span class="title function_">create</span>(someOtherObj);</span><br><span class="line">obj.<span class="property">method</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123; ... &#125;;</span><br></pre></td></tr></table></figure>
<p>无论从语义的角度，还是从兼容性的角度，都不要使用这个属性，而是使用下面的Object.setPrototypeOf()（写操作）、Object.getPrototypeOf()（读操作）、Object.create()（生成操作）代替。</p>
<h3 id="Object-keys-Object-values-Object-entries"><a href="#Object-keys-Object-values-Object-entries" class="headerlink" title="Object.keys(),Object.values(),Object.entries()"></a>Object.keys(),Object.values(),Object.entries()</h3><p>ES2017 引入了跟Object.keys配套的Object.values和Object.entries，作为遍历一个对象的补充手段，供for…of循环使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123;keys, values, entries&#125; = <span class="title class_">Object</span>;</span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>, <span class="attr">c</span>: <span class="number">3</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">of</span> <span class="title function_">keys</span>(obj)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(key); <span class="comment">// &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> value <span class="keyword">of</span> <span class="title function_">values</span>(obj)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(value); <span class="comment">// 1, 2, 3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> [key, value] <span class="keyword">of</span> <span class="title function_">entries</span>(obj)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>([key, value]); <span class="comment">// [&#x27;a&#x27;, 1], [&#x27;b&#x27;, 2], [&#x27;c&#x27;, 3]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Object.values方法返回一个数组，成员是参数对象自身的（不含继承的）所有可遍历（enumerable）属性的键值。</p>
<p>Object.entries方法返回一个数组，成员是参数对象自身的（不含继承的）所有可遍历（enumerable）属性的键值对数组。</p>
<h3 id="对象的扩展运算符"><a href="#对象的扩展运算符" class="headerlink" title="对象的扩展运算符"></a>对象的扩展运算符</h3><h5 id="1-解构赋值"><a href="#1-解构赋值" class="headerlink" title="1. 解构赋值"></a>1. 解构赋值</h5><p>对象的解构赋值用于从一个对象取值，相当于将所有可遍历的、但尚未被读取的属性，分配到指定的对象上面。所有的键和它们的值，都会拷贝到新对象上面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; x, y, ...z &#125; = &#123; <span class="attr">x</span>: <span class="number">1</span>, <span class="attr">y</span>: <span class="number">2</span>, <span class="attr">a</span>: <span class="number">3</span>, <span class="attr">b</span>: <span class="number">4</span> &#125;;</span><br><span class="line">x <span class="comment">// 1</span></span><br><span class="line">y <span class="comment">// 2</span></span><br><span class="line">z <span class="comment">// &#123; a: 3, b: 4 &#125;</span></span><br></pre></td></tr></table></figure>
<p>注意，解构赋值的拷贝是浅拷贝，即如果一个键的值是复合类型的值（数组、对象、函数）、那么解构赋值拷贝的是这个值的引用，而不是这个值的副本。</p>
<h5 id="2-扩展运算符"><a href="#2-扩展运算符" class="headerlink" title="2. 扩展运算符"></a>2. 扩展运算符</h5><p>扩展运算符（…）用于取出参数对象的所有可遍历属性，拷贝到当前对象之中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> z = &#123; <span class="attr">a</span>: <span class="number">3</span>, <span class="attr">b</span>: <span class="number">4</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> n = &#123; ...z &#125;;</span><br><span class="line">n <span class="comment">// &#123; a: 3, b: 4 &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Object-getOwnPropertyDescriptors"><a href="#Object-getOwnPropertyDescriptors" class="headerlink" title="Object.getOwnPropertyDescriptors()"></a>Object.getOwnPropertyDescriptors()</h3><p>ES2017 引入了Object.getOwnPropertyDescriptors方法，返回指定对象所有自身属性（非继承属性）的描述对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">foo</span>: <span class="number">123</span>,</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">bar</span>() &#123; <span class="keyword">return</span> <span class="string">&#x27;abc&#x27;</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptors</span>(obj)</span><br><span class="line"><span class="comment">// &#123; foo:</span></span><br><span class="line"><span class="comment">//    &#123; value: 123,</span></span><br><span class="line"><span class="comment">//      writable: true,</span></span><br><span class="line"><span class="comment">//      enumerable: true,</span></span><br><span class="line"><span class="comment">//      configurable: true &#125;,</span></span><br><span class="line"><span class="comment">//   bar:</span></span><br><span class="line"><span class="comment">//    &#123; get: [Function: bar],</span></span><br><span class="line"><span class="comment">//      set: undefined,</span></span><br><span class="line"><span class="comment">//      enumerable: true,</span></span><br><span class="line"><span class="comment">//      configurable: true &#125; &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Null传导运算符"><a href="#Null传导运算符" class="headerlink" title="Null传导运算符"></a>Null传导运算符</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> firstName = message?.<span class="property">body</span>?.<span class="property">user</span>?.<span class="property">firstName</span> || <span class="string">&#x27;default&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>上面代码有三个?.运算符，只要其中一个返回null或undefined，就不再往下运算，而是返回undefined。</p>
<h1 id="10-Symbol"><a href="#10-Symbol" class="headerlink" title="10. Symbol"></a>10. Symbol</h1><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>ES6 引入了一种新的原始数据类型Symbol，表示独一无二的值。它是 JavaScript 语言的第七种数据类型，前六种是：undefined、null、布尔值（Boolean）、字符串（String）、数值（Number）、对象（Object）。</p>
<p>Symbol 值通过Symbol函数生成。这就是说，对象的属性名现在可以有两种类型，一种是原来就有的字符串，另一种就是新增的 Symbol 类型。凡是属性名属于 Symbol 类型，就都是独一无二的，可以保证不会与其他属性名产生冲突。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> s = <span class="title class_">Symbol</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">typeof</span> s</span><br><span class="line"><span class="comment">// &quot;symbol&quot;</span></span><br></pre></td></tr></table></figure>

<p>注意，Symbol函数前不能使用new命令，否则会报错。</p>
<h3 id="作为属性名的Symbol"><a href="#作为属性名的Symbol" class="headerlink" title="作为属性名的Symbol"></a>作为属性名的Symbol</h3><p>由于每一个 Symbol 值都是不相等的，这意味着 Symbol 值可以作为标识符，用于对象的属性名，就能保证不会出现同名的属性。这对于一个对象由多个模块构成的情况非常有用，能防止某一个键被不小心改写或覆盖。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mySymbol = <span class="title class_">Symbol</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一种写法</span></span><br><span class="line"><span class="keyword">var</span> a = &#123;&#125;;</span><br><span class="line">a[mySymbol] = <span class="string">&#x27;Hello!&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种写法</span></span><br><span class="line"><span class="keyword">var</span> a = &#123;</span><br><span class="line">  [mySymbol]: <span class="string">&#x27;Hello!&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三种写法</span></span><br><span class="line"><span class="keyword">var</span> a = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(a, mySymbol, &#123; <span class="attr">value</span>: <span class="string">&#x27;Hello!&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以上写法都得到同样结果</span></span><br><span class="line">a[mySymbol] <span class="comment">// &quot;Hello!&quot;</span></span><br></pre></td></tr></table></figure>
<p>注意，Symbol 值作为对象属性名时，不能用点运算符。</p>
<p>同理，在对象的内部，使用 Symbol 值定义属性时，Symbol 值必须放在方括号之中。</p>
<p>还有一点需要注意，Symbol 值作为属性名时，该属性还是公开属性，不是私有属性。</p>
<h3 id="属性名的遍历"><a href="#属性名的遍历" class="headerlink" title="属性名的遍历"></a>属性名的遍历</h3><p>Symbol 作为属性名，该属性不会出现在for…in、for…of循环中，也不会被Object.keys()、Object.getOwnPropertyNames()、JSON.stringify()返回。但是，它也不是私有属性，有一个Object.getOwnPropertySymbols方法，可以获取指定对象的所有 Symbol 属性名。</p>
<p>Object.getOwnPropertySymbols方法返回一个数组，成员是当前对象的所有用作属性名的 Symbol 值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> a = <span class="title class_">Symbol</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> b = <span class="title class_">Symbol</span>(<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"></span><br><span class="line">obj[a] = <span class="string">&#x27;Hello&#x27;</span>;</span><br><span class="line">obj[b] = <span class="string">&#x27;World&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> objectSymbols = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertySymbols</span>(obj);</span><br><span class="line"></span><br><span class="line">objectSymbols</span><br><span class="line"><span class="comment">// [Symbol(a), Symbol(b)]</span></span><br></pre></td></tr></table></figure>

<h3 id="Symbol-for-Symbol-keyFor"><a href="#Symbol-for-Symbol-keyFor" class="headerlink" title="Symbol.for( ),Symbol.keyFor( )"></a>Symbol.for( ),Symbol.keyFor( )</h3><p>有时，我们希望重新使用同一个Symbol值，<code>Symbol.for</code>方法可以做到这一点。它接受一个字符串作为参数，然后搜索有没有以该参数作为名称的Symbol值。如果有，就返回这个Symbol值，否则就新建并返回一个以该字符串为名称的Symbol值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&#x27;foo&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> s2 = <span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&#x27;foo&#x27;</span>);</span><br><span class="line"></span><br><span class="line">s1 === s2 <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p><code>Symbol.for()</code>与S<code>ymbol()</code>这两种写法，都会生成新的Symbol。它们的区别是，前者会被登记在全局环境中供搜索，后者不会。</p>
<p><code>Symbol.keyFor</code>方法返回一个已登记的 Symbol 类型值的key。</p>
<h3 id="内置的symbol值"><a href="#内置的symbol值" class="headerlink" title="内置的symbol值"></a>内置的symbol值</h3><p>除了定义自己使用的Symbol值以外，ES6还提供了11个内置的Symbol值，指向语言内部使用的方法。</p>
<h1 id="11-set和map数据结构"><a href="#11-set和map数据结构" class="headerlink" title="11. set和map数据结构"></a>11. set和map数据结构</h1><h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><h5 id="基本用法-1"><a href="#基本用法-1" class="headerlink" title="基本用法"></a>基本用法</h5><p>ES6 提供了新的数据结构 Set。它类似于数组，但是成员的值都是唯一的，没有重复的值。</p>
<p>Set 本身是一个构造函数，用来生成 Set 数据结构。</p>
<p>Set 函数可以接受一个数组（或者具有 iterable 接口的其他数据结构）作为参数，用来初始化。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 例一</span></span><br><span class="line"><span class="keyword">const</span> set = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>]);</span><br><span class="line">[...set]</span><br><span class="line"><span class="comment">// [1, 2, 3, 4]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 例二</span></span><br><span class="line"><span class="keyword">const</span> items = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>]);</span><br><span class="line">items.<span class="property">size</span> <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 例三</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">divs</span> () &#123;</span><br><span class="line">  <span class="keyword">return</span> [...<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;div&#x27;</span>)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> set = <span class="keyword">new</span> <span class="title class_">Set</span>(<span class="title function_">divs</span>());</span><br><span class="line">set.<span class="property">size</span> <span class="comment">// 56</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 类似于</span></span><br><span class="line"><span class="title function_">divs</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">div</span> =&gt;</span> set.<span class="title function_">add</span>(div));</span><br><span class="line">set.<span class="property">size</span> <span class="comment">// 56</span></span><br></pre></td></tr></table></figure>
<p>向Set加入值的时候，不会发生类型转换，所以5和”5”是两个不同的值。Set内部判断两个值是否不同，使用的算法叫做“Same-value equality”，它类似于精确相等运算符（&#x3D;&#x3D;&#x3D;），主要的区别是NaN等于自身，而精确相等运算符认为NaN不等于自身。</p>
<p>另外，两个对象总是不相等的。</p>
<h5 id="set实例的属性和方法"><a href="#set实例的属性和方法" class="headerlink" title="set实例的属性和方法"></a>set实例的属性和方法</h5><p>Set 结构的实例有以下属性。</p>
<ul>
<li><code>Set.prototype.constructor</code>：构造函数，默认就是Set函数。</li>
<li><code>Set.prototype.size</code>：返回Set实例的成员总数。</li>
</ul>
<p>Set 实例的方法分为两大类：操作方法（用于操作数据）和遍历方法（用于遍历成员）。下面先介绍四个操作方法。</p>
<ul>
<li><code>add(value)</code>：添加某个值，返回Set结构本身。</li>
<li><code>delete(value)</code>：删除某个值，返回一个布尔值，表示删除是否成功。</li>
<li><code>has(value)</code>：返回一个布尔值，表示该值是否为Set的成员。</li>
<li><code>clear()</code>：清除所有成员，没有返回值。</li>
</ul>
<h5 id="遍历操作"><a href="#遍历操作" class="headerlink" title="遍历操作"></a>遍历操作</h5><p>Set 结构的实例有四个遍历方法，可以用于遍历成员。</p>
<ul>
<li>keys()：返回键名的遍历器</li>
<li>values()：返回键值的遍历器</li>
<li>entries()：返回键值对的遍历器</li>
<li>forEach()：使用回调函数遍历每个成员</li>
</ul>
<h3 id="WeakSet"><a href="#WeakSet" class="headerlink" title="WeakSet"></a>WeakSet</h3><p>WeakSet 结构与 Set 类似，也是不重复的值的集合。但是，它与 Set 有两个区别。</p>
<p>首先，WeakSet 的成员只能是对象，而不能是其他类型的值。</p>
<p>其次，WeakSet 中的对象都是弱引用，即垃圾回收机制不考虑 WeakSet 对该对象的引用，也就是说，如果其他对象都不再引用该对象，那么垃圾回收机制会自动回收该对象所占用的内存，不考虑该对象还存在于 WeakSet 之中。</p>
<h5 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h5><p>WeakSet 是一个构造函数，可以使用new命令，创建 WeakSet 数据结构。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> <span class="title class_">WeakSet</span>();</span><br></pre></td></tr></table></figure>
<p>WeakSet 结构有以下三个方法。</p>
<ul>
<li>WeakSet.prototype.add(value)：向 WeakSet 实例添加一个新成员。</li>
<li>WeakSet.prototype.delete(value)：清除 WeakSet 实例的指定成员。</li>
<li>WeakSet.prototype.has(value)：返回一个布尔值，表示某个值是否在 WeakSet 实例之中。</li>
</ul>
<p>WeakSet没有size属性，没有办法遍历它的成员。</p>
<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><h5 id="基本含义和用法"><a href="#基本含义和用法" class="headerlink" title="基本含义和用法"></a>基本含义和用法</h5><p>它类似于对象，也是键值对的集合，但是“键”的范围不限于字符串，各种类型的值（包括对象）都可以当作键。也就是说，Object 结构提供了“字符串—值”的对应，Map结构提供了“值—值”的对应，是一种更完善的 Hash 结构实现。如果你需要“键值对”的数据结构，Map 比 Object 更合适。</p>
<p>事实上，不仅仅是数组，任何具有 Iterator 接口、且每个成员都是一个双元素的数组的数据结构都可以当作Map构造函数的参数。这就是说，Set和Map都可以用来生成新的 Map。</p>
<h5 id="实例的属性和操作方法"><a href="#实例的属性和操作方法" class="headerlink" title="实例的属性和操作方法"></a>实例的属性和操作方法</h5><ol>
<li>size属性<br> size属性返回 Map 结构的成员总数。</li>
<li>set(key, value)<br> set方法设置键名key对应的键值为value，然后返回整个 Map 结构。如果key已经有值，则键值会被更新，否则就新生成该键。</li>
<li>get(key)<br> get方法读取key对应的键值，如果找不到key，返回undefined。</li>
<li>has(key)<br> has方法返回一个布尔值，表示某个键是否在当前 Map 对象之中。</li>
<li>delete(key)<br> delete方法删除某个键，返回true。如果删除失败，返回false。</li>
<li>clear()<br> clear方法清除所有成员，没有返回值。</li>
</ol>
<h5 id="遍历方法"><a href="#遍历方法" class="headerlink" title="遍历方法"></a>遍历方法</h5><p>Map 结构原生提供三个遍历器生成函数和一个遍历方法。</p>
<ul>
<li>keys()：返回键名的遍历器。</li>
<li>values()：返回键值的遍历器。</li>
<li>entries()：返回所有成员的遍历器。</li>
<li>forEach()：遍历 Map 的所有成员。</li>
</ul>
<p>结合数组的map方法、filter方法，可以实现 Map 的遍历和过滤（Map 本身没有map和filter方法）。</p>
<h5 id="与其他数据结构的相互转换"><a href="#与其他数据结构的相互转换" class="headerlink" title="与其他数据结构的相互转换"></a>与其他数据结构的相互转换</h5><ol>
<li>map转换为数组</li>
<li>数组转换为map</li>
<li>map转换为对象</li>
<li>对象转换为map</li>
<li>map转换为json</li>
<li>JSON转换为map</li>
</ol>
<h3 id="WeakMap"><a href="#WeakMap" class="headerlink" title="WeakMap"></a>WeakMap</h3><p>WeakMap只接受对象作为键名（null除外），不接受其他类型的值作为键名。</p>
<p>WeakMap的键名所指向的对象，不计入垃圾回收机制。</p>
<h1 id="12-Proxy"><a href="#12-Proxy" class="headerlink" title="12. Proxy"></a>12. Proxy</h1><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><p>Proxy 用于修改某些操作的默认行为，等同于在语言层面做出修改，所以属于一种“元编程”（meta programming），即对编程语言进行编程。</p>
<h3 id="Proxy可以拦截的操作"><a href="#Proxy可以拦截的操作" class="headerlink" title="Proxy可以拦截的操作"></a>Proxy可以拦截的操作</h3><ol>
<li>get()<br> get方法用于拦截某个属性的读取操作。</li>
<li>set()<br> set方法用来拦截某个属性的赋值操作。</li>
<li>apply()<br> apply方法拦截函数的调用、call和apply操作。</li>
<li>has()<br> has方法用来拦截HasProperty操作，即判断对象是否具有某个属性时，这个方法会生效。典型的操作就是in运算符。</li>
<li>construct()<br> construct方法用于拦截new命令</li>
<li>deleteProperty()<br> deleteProperty方法用于拦截delete操作，如果这个方法抛出错误或者返回false，当前属性就无法被delete命令删除。</li>
<li>defineProperty()<br> defineProperty方法拦截了Object.defineProperty操作。</li>
<li>getOwnPropertyDescriptors()<br> <code>getOwnPropertyDescriptor</code>方法拦截<code>Object.getOwnPropertyDescriptor()</code>，返回一个属性描述对象或者undefined。</li>
<li>getPrototypeOf()<br> getPrototypeOf方法主要用来拦截获取对象原型。</li>
<li>isExtensible()<br>isExtensible方法拦截Object.isExtensible操作。</li>
<li>ownKeys()<br>ownKeys方法用来拦截对象自身属性的读取操作。</li>
<li>preventExtensions()<br>preventExtensions方法拦截Object.preventExtensions()。该方法必须返回一个布尔值，否则会被自动转为布尔值。</li>
<li>setProrypeOf()<br>setPrototypeOf方法主要用来拦截Object.setPrototypeOf方法。</li>
</ol>
<h3 id="Proxy-revocable"><a href="#Proxy-revocable" class="headerlink" title="Proxy.revocable()"></a>Proxy.revocable()</h3><p>Proxy.revocable方法返回一个可取消的 Proxy 实例。</p>
<h1 id="13-Reflect"><a href="#13-Reflect" class="headerlink" title="13. Reflect"></a>13. Reflect</h1><h3 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h3><p>Reflect对象与Proxy对象一样，也是 ES6 为了操作对象而提供的新 API。Reflect对象的设计目的有这样几个。</p>
<p>（1） 将Object对象的一些明显属于语言内部的方法（比如Object.defineProperty），放到Reflect对象上。现阶段，某些方法同时在Object和Reflect对象上部署，未来的新方法将只部署在Reflect对象上。也就是说，从Reflect对象上可以拿到语言内部的方法。</p>
<p>（2） 修改某些Object方法的返回结果，让其变得更合理。比如，Object.defineProperty(obj, name, desc)在无法定义属性时，会抛出一个错误，而Reflect.defineProperty(obj, name, desc)则会返回false。</p>
<p>（3） 让Object操作都变成函数行为。某些Object操作是命令式，比如name in obj和delete obj[name]，而Reflect.has(obj, name)和Reflect.deleteProperty(obj, name)让它们变成了函数行为。</p>
<p>（4）Reflect对象的方法与Proxy对象的方法一一对应，只要是Proxy对象的方法，就能在Reflect对象上找到对应的方法。这就让Proxy对象可以方便地调用对应的Reflect方法，完成默认行为，作为修改行为的基础。也就是说，不管Proxy怎么修改默认行为，你总可以在Reflect上获取默认行为。</p>
<h3 id="2-静态方法"><a href="#2-静态方法" class="headerlink" title="2. 静态方法"></a>2. 静态方法</h3><ul>
<li>Reflect.apply(target,thisArg,args)</li>
<li>Reflect.construct(target,args)</li>
<li>Reflect.get(target,name,receiver)</li>
<li>Reflect.set(target,name,value,receiver)</li>
<li>Reflect.defineProperty(target,name,desc)</li>
<li>Reflect.deleteProperty(target,name)</li>
<li>Reflect.has(target,name)</li>
<li>Reflect.ownKeys(target)</li>
<li>Reflect.isExtensible(target)</li>
<li>Reflect.preventExtensions(target)</li>
<li>Reflect.getOwnPropertyDescriptor(target, name)</li>
<li>Reflect.getPrototypeOf(target)</li>
<li>Reflect.setPrototypeOf(target, prototype)</li>
</ul>
<h1 id="14-Promise对象"><a href="#14-Promise对象" class="headerlink" title="14. Promise对象"></a>14. Promise对象</h1><p>Promise 是异步编程的一种解决方案，比传统的解决方案——回调函数和事件——更合理和更强大。它由社区最早提出和实现，ES6 将其写进了语言标准，统一了用法，原生提供了Promise对象。</p>
<p>所谓Promise，简单说就是一个容器，里面保存着某个未来才会结束的事件（通常是一个异步操作）的结果。从语法上说，Promise 是一个对象，从它可以获取异步操作的消息。Promise 提供统一的 API，各种异步操作都可以用同样的方法进行处理。</p>
<p>Promise对象有以下两个特点。</p>
<p>（1）对象的状态不受外界影响。Promise对象代表一个异步操作，有三种状态：Pending（进行中）、Resolved（已完成，又称 Fulfilled）和Rejected（已失败）。只有异步操作的结果，可以决定当前是哪一种状态，任何其他操作都无法改变这个状态。这也是Promise这个名字的由来，它的英语意思就是“承诺”，表示其他手段无法改变。</p>
<p>（2）一旦状态改变，就不会再变，任何时候都可以得到这个结果。Promise对象的状态改变，只有两种可能：从Pending变为Resolved和从Pending变为Rejected。只要这两种情况发生，状态就凝固了，不会再变了，会一直保持这个结果。如果改变已经发生了，你再对Promise对象添加回调函数，也会立即得到这个结果。这与事件（Event）完全不同，事件的特点是，如果你错过了它，再去监听，是得不到结果的。</p>
<p>Promise也有一些缺点。首先，无法取消Promise，一旦新建它就会立即执行，无法中途取消。其次，如果不设置回调函数，Promise内部抛出的错误，不会反应到外部。第三，当处于Pending状态时，无法得知目前进展到哪一个阶段（刚刚开始还是即将完成）。</p>
<h3 id="基本用法-2"><a href="#基本用法-2" class="headerlink" title="基本用法"></a>基本用法</h3><p>ES6 规定，Promise对象是一个构造函数，用来生成Promise实例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">  <span class="comment">// ... some code</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* 异步操作成功 */</span>)&#123;</span><br><span class="line">    <span class="title function_">resolve</span>(value);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Promise-prototype-then"><a href="#Promise-prototype-then" class="headerlink" title="Promise.prototype.then()"></a>Promise.prototype.then()</h3><p>Promise 实例具有then方法，也就是说，then方法是定义在原型对象Promise.prototype上的。它的作用是为 Promise 实例添加状态改变时的回调函数。前面说过，then方法的第一个参数是Resolved状态的回调函数，第二个参数（可选）是Rejected状态的回调函数。</p>
<p>then方法返回的是一个新的Promise实例（注意，不是原来那个Promise实例）。因此可以采用链式写法，即then方法后面再调用另一个then方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getJSON</span>(<span class="string">&quot;/posts.json&quot;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">json</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> json.<span class="property">post</span>;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">post</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面的代码使用then方法，依次指定了两个回调函数。第一个回调函数完成以后，会将返回结果作为参数，传入第二个回调函数。</p>
<h3 id="Promise-prototype-catch"><a href="#Promise-prototype-catch" class="headerlink" title="Promise.prototype.catch()"></a>Promise.prototype.catch()</h3><p>Promise.prototype.catch方法是.then(null, rejection)的别名，用于指定发生错误时的回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getJSON</span>(<span class="string">&#x27;/posts.json&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">posts</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">  <span class="comment">// 处理 getJSON 和 前一个回调函数运行时发生的错误</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;发生错误！&#x27;</span>, error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Promise-all"><a href="#Promise-all" class="headerlink" title="Promise.all()"></a>Promise.all()</h3><p>Promise.all方法用于将多个 Promise 实例，包装成一个新的 Promise 实例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="title class_">Promise</span>.<span class="title function_">all</span>([p1, p2, p3]);</span><br></pre></td></tr></table></figure>
<p>上面代码中，Promise.all方法接受一个数组作为参数，p1、p2、p3都是 Promise 实例，如果不是，就会先调用下面讲到的Promise.resolve方法，将参数转为 Promise 实例，再进一步处理。（Promise.all方法的参数可以不是数组，但必须具有 Iterator 接口，且返回的每个成员都是 Promise 实例。）</p>
<h3 id="Promise-race"><a href="#Promise-race" class="headerlink" title="Promise.race()"></a>Promise.race()</h3><p>Promise.race方法同样是将多个Promise实例，包装成一个新的Promise实例。</p>
<h3 id="Promise-resolve"><a href="#Promise-resolve" class="headerlink" title="Promise.resolve()"></a>Promise.resolve()</h3><p>有时需要将现有对象转为Promise对象，Promise.resolve方法就起到这个作用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jsPromise = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>($.<span class="title function_">ajax</span>(<span class="string">&#x27;/whatever.json&#x27;</span>));</span><br></pre></td></tr></table></figure>
<p>上面代码将jQuery生成的deferred对象，转为一个新的Promise对象。</p>
<h3 id="Promise-reject"><a href="#Promise-reject" class="headerlink" title="Promise.reject()"></a>Promise.reject()</h3><p>Promise.reject(reason)方法也会返回一个新的 Promise 实例，该实例的状态为rejected。</p>
<h3 id="两个有用的附加方法"><a href="#两个有用的附加方法" class="headerlink" title="两个有用的附加方法"></a>两个有用的附加方法</h3><h5 id="done"><a href="#done" class="headerlink" title="done()"></a>done()</h5><p>Promise对象的回调链，不管以then方法或catch方法结尾，要是最后一个方法抛出错误，都有可能无法捕捉到（因为Promise内部的错误不会冒泡到全局）。因此，我们可以提供一个done方法，总是处于回调链的尾端，保证抛出任何可能出现的错误。</p>
<h5 id="finally"><a href="#finally" class="headerlink" title="finally()"></a>finally()</h5><p>finally方法用于指定不管Promise对象最后状态如何，都会执行的操作。它与done方法的最大区别，它接受一个普通的回调函数作为参数，该函数不管怎样都必须执行。</p>
<h1 id="15-Iterator-和-for…of循环"><a href="#15-Iterator-和-for…of循环" class="headerlink" title="15. Iterator 和 for…of循环"></a>15. Iterator 和 for…of循环</h1><h3 id="Iterator的概念"><a href="#Iterator的概念" class="headerlink" title="Iterator的概念"></a>Iterator的概念</h3><p>遍历器（Iterator）就是这样一种机制。它是一种接口，为各种不同的数据结构提供统一的访问机制。任何数据结构只要部署Iterator接口，就可以完成遍历操作（即依次处理该数据结构的所有成员）。</p>
<p>Iterator 的作用有三个：一是为各种数据结构，提供一个统一的、简便的访问接口；二是使得数据结构的成员能够按某种次序排列；三是ES6创造了一种新的遍历命令for…of循环，Iterator接口主要供for…of消费。</p>
<h3 id="默认Iterator接口"><a href="#默认Iterator接口" class="headerlink" title="默认Iterator接口"></a>默认Iterator接口</h3><p>一种数据结构只要部署了 Iterator 接口，我们就称这种数据结构是”可遍历的“（iterable）。</p>
<p>ES6 规定，默认的 Iterator 接口部署在数据结构的Symbol.iterator属性，或者说，一个数据结构只要具有Symbol.iterator属性，就可以认为是“可遍历的”（iterable）。</p>
<p>原生具备 Iterator 接口的数据结构如下。</p>
<ul>
<li>Array</li>
<li>Map</li>
<li>Set</li>
<li>String</li>
<li>TypedArray</li>
<li>函数的 arguments 对象</li>
</ul>
<h3 id="调用Iterator的场合"><a href="#调用Iterator的场合" class="headerlink" title="调用Iterator的场合"></a>调用Iterator的场合</h3><p>有一些场合会默认调用 Iterator 接口（即Symbol.iterator方法），除了下文会介绍的for…of循环，还有几个别的场合。</p>
<ol>
<li>解构赋值</li>
<li>扩展运算符</li>
<li>yield<br> yield*后面跟的是一个可遍历的结构，它会调用该结构的遍历器接口。</li>
<li>数组作为参数的场合<ul>
<li>for…of</li>
<li>Array.from()</li>
<li>Map(), Set(), WeakMap(), WeakSet()（比如new Map([[‘a’,1],[‘b’,2]])）</li>
<li>Promise.all()</li>
<li>Promise.race()</li>
</ul>
</li>
</ol>
<h3 id="字符串的Iterator接口"><a href="#字符串的Iterator接口" class="headerlink" title="字符串的Iterator接口"></a>字符串的Iterator接口</h3><p>字符串是一个类似数组的对象，也原生具有 Iterator 接口。</p>
<h3 id="Iterator接口和Generator函数"><a href="#Iterator接口和Generator函数" class="headerlink" title="Iterator接口和Generator函数"></a>Iterator接口和Generator函数</h3><p>Symbol.iterator方法的最简单实现，还是使用下一章要介绍的Generator函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myIterable = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">myIterable[<span class="title class_">Symbol</span>.<span class="property">iterator</span>] = <span class="keyword">function</span>* () &#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">3</span>;</span><br><span class="line">&#125;;</span><br><span class="line">[...myIterable] <span class="comment">// [1, 2, 3]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者采用下面的简洁写法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">  * [<span class="title class_">Symbol</span>.<span class="property">iterator</span>]() &#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">&#x27;hello&#x27;</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> x <span class="keyword">of</span> obj) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// hello</span></span><br><span class="line"><span class="comment">// world</span></span><br></pre></td></tr></table></figure>

<h3 id="遍历器对象的return-throw"><a href="#遍历器对象的return-throw" class="headerlink" title="遍历器对象的return(),throw()"></a>遍历器对象的return(),throw()</h3><p>遍历器对象除了具有next方法，还可以具有return方法和throw方法。如果你自己写遍历器对象生成函数，那么next方法是必须部署的，return方法和throw方法是否部署是可选的。</p>
<p>return方法的使用场合是，如果for…of循环提前退出（通常是因为出错，或者有break语句或continue语句），就会调用return方法。如果一个对象在完成遍历前，需要清理或释放资源，就可以部署return方法。</p>
<h3 id="for…of循环"><a href="#for…of循环" class="headerlink" title="for…of循环"></a>for…of循环</h3><p>ES6 借鉴 C++、Java、C# 和 Python 语言，引入了for…of循环，作为遍历所有数据结构的统一的方法。</p>
<p>一个数据结构只要部署了Symbol.iterator属性，就被视为具有iterator接口，就可以用for…of循环遍历它的成员。也就是说，for…of循环内部调用的是数据结构的Symbol.iterator方法。</p>
<p>for…of循环可以使用的范围包括数组、Set 和 Map 结构、某些类似数组的对象（比如arguments对象、DOM NodeList 对象）、后文的 Generator 对象，以及字符串。</p>
<h1 id="16-Generator函数的语法"><a href="#16-Generator函数的语法" class="headerlink" title="16. Generator函数的语法"></a>16. Generator函数的语法</h1><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Generator 函数是 ES6 提供的一种异步编程解决方案，语法行为与传统函数完全不同。</p>
<p>形式上，Generator 函数是一个普通函数，但是有两个特征。一是，function关键字与函数名之间有一个星号；二是，函数体内部使用yield表达式，定义不同的内部状态（yield在英语里的意思就是“产出”）。</p>
<h3 id="yield表达式"><a href="#yield表达式" class="headerlink" title="yield表达式"></a>yield表达式</h3><p>由于 Generator 函数返回的遍历器对象，只有调用next方法才会遍历下一个内部状态，所以其实提供了一种可以暂停执行的函数。yield表达式就是暂停标志。</p>
<h1 id="18-async函数"><a href="#18-async函数" class="headerlink" title="18. async函数"></a>18. async函数</h1><h3 id="含义"><a href="#含义" class="headerlink" title="含义"></a>含义</h3><p>async函数就是将 Generator 函数的星号（*）替换成async，将yield替换成await，仅此而已。<br>（1）内置执行器。</p>
<p>Generator 函数的执行必须靠执行器，所以才有了co模块，而async函数自带执行器。也就是说，async函数的执行，与普通函数一模一样，只要一行。</p>
<p><code>var result = asyncReadFile();</code><br>上面的代码调用了asyncReadFile函数，然后它就会自动执行，输出最后结果。这完全不像 Generator 函数，需要调用next方法，或者用co模块，才能真正执行，得到最后结果。</p>
<p>（2）更好的语义。</p>
<p>async和await，比起星号和yield，语义更清楚了。async表示函数里有异步操作，await表示紧跟在后面的表达式需要等待结果。</p>
<p>（3）更广的适用性。</p>
<p>co模块约定，yield命令后面只能是 Thunk 函数或 Promise 对象，而async函数的await命令后面，可以是Promise 对象和原始类型的值（数值、字符串和布尔值，但这时等同于同步操作）。</p>
<p>（4）返回值是 Promise。</p>
<p>async函数的返回值是 Promise 对象，这比 Generator 函数的返回值是 Iterator 对象方便多了。你可以用then方法指定下一步的操作。</p>
<p>进一步说，async函数完全可以看作多个异步操作，包装成的一个 Promise 对象，而await命令就是内部then命令的语法糖。</p>
<h3 id="基本用法-3"><a href="#基本用法-3" class="headerlink" title="基本用法"></a>基本用法</h3><p>async函数返回一个 Promise 对象，可以使用then方法添加回调函数。当函数执行的时候，一旦遇到await就会先返回，等到异步操作完成，再接着执行函数体内后面的语句。</p>
<h1 id="19-Class基本语法"><a href="#19-Class基本语法" class="headerlink" title="19. Class基本语法"></a>19. Class基本语法</h1><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>ES6 提供了更接近传统语言的写法，引入了 Class（类）这个概念，作为对象的模板。通过class关键字，可以定义类。</p>
<p>基本上，ES6 的class可以看作只是一个语法糖，它的绝大部分功能，ES5 都可以做到，新的class写法只是让对象原型的写法更加清晰、更像面向对象编程的语法而已。上面的代码用 ES6 的class改写，就是下面这样。</p>
<h1 id="20-class的继承"><a href="#20-class的继承" class="headerlink" title="20. class的继承"></a>20. class的继承</h1><h3 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h3><p>Class 可以通过extends关键字实现继承，这比 ES5 的通过修改原型链实现继承，要清晰和方便很多。</p>
<h3 id="Object-getPrototypeOf"><a href="#Object-getPrototypeOf" class="headerlink" title="Object.getPrototypeOf()"></a>Object.getPrototypeOf()</h3><p>Object.getPrototypeOf方法可以用来从子类上获取父类。</p>
<h3 id="super-关键字"><a href="#super-关键字" class="headerlink" title="super 关键字"></a>super 关键字</h3><p>第一种情况，super作为函数调用时，代表父类的构造函数。ES6 要求，子类的构造函数必须执行一次super函数。</p>
<p>第二种情况，super作为对象时，在普通方法中，指向父类的原型对象；在静态方法中，指向父类。</p>
<h3 id="类的prototype属性和-proto-属性"><a href="#类的prototype属性和-proto-属性" class="headerlink" title="类的prototype属性和__proto__属性"></a>类的prototype属性和__proto__属性</h3><p>大多数浏览器的 ES5 实现之中，每一个对象都有__proto__属性，指向对应的构造函数的prototype属性。Class 作为构造函数的语法糖，同时有prototype属性和__proto__属性，因此同时存在两条继承链。</p>
<p>（1）子类的__proto__属性，表示构造函数的继承，总是指向父类。</p>
<p>（2）子类prototype属性的__proto__属性，表示方法的继承，总是指向父类的prototype属性。</p>
<h1 id="21-修饰器"><a href="#21-修饰器" class="headerlink" title="21. 修饰器"></a>21. 修饰器</h1><h3 id="类的修饰"><a href="#类的修饰" class="headerlink" title="类的修饰"></a>类的修饰</h3><p>修饰器（Decorator）是一个函数，用来修改类的行为。</p>
<h1 id="22-Module语法"><a href="#22-Module语法" class="headerlink" title="22. Module语法"></a>22. Module语法</h1><h3 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h3><p>ES6 模块不是对象，而是通过export命令显式指定输出的代码，再通过import命令输入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; stat, exists, readFile &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="严格模式-1"><a href="#严格模式-1" class="headerlink" title="严格模式"></a>严格模式</h3><p>ES6 的模块自动采用严格模式，不管你有没有在模块头部加上”use strict”;。</p>
<h3 id="export命令"><a href="#export命令" class="headerlink" title="export命令"></a>export命令</h3><p>模块功能主要由两个命令构成：export和import。export命令用于规定模块的对外接口，import命令用于输入其他模块提供的功能。</p>
<p>一个模块就是一个独立的文件。该文件内部的所有变量，外部无法获取。如果你希望外部能够读取模块内部的某个变量，就必须使用export关键字输出该变量。下面是一个 JS 文件，里面使用export命令输出变量。</p>
<h3 id="import命令"><a href="#import命令" class="headerlink" title="import命令"></a>import命令</h3><p>使用export命令定义了模块的对外接口以后，其他 JS 文件就可以通过import命令加载这个模块。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;firstName, lastName, year&#125; <span class="keyword">from</span> <span class="string">&#x27;./profile&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setName</span>(<span class="params">element</span>) &#123;</span><br><span class="line">  element.<span class="property">textContent</span> = firstName + <span class="string">&#x27; &#x27;</span> + lastName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="模块的整体加载"><a href="#模块的整体加载" class="headerlink" title="模块的整体加载"></a>模块的整体加载</h3><p>除了指定加载某个输出值，还可以使用整体加载，即用星号（*）指定一个对象，所有输出值都加载在这个对象上面。</p>
<h3 id="export-default命令"><a href="#export-default命令" class="headerlink" title="export default命令"></a>export default命令</h3><p>为了给用户提供方便，让他们不用阅读文档就能加载模块，就要用到export default命令，为模块指定默认输出。</p>
<h1 id="23-Module的加载实现"><a href="#23-Module的加载实现" class="headerlink" title="23. Module的加载实现"></a>23. Module的加载实现</h1><h3 id="浏览器加载"><a href="#浏览器加载" class="headerlink" title="浏览器加载"></a>浏览器加载</h3><p>如果脚本体积很大，下载和执行的时间就会很长，因此造成浏览器堵塞，用户会感觉到浏览器“卡死”了，没有任何响应。这显然是很不好的体验，所以浏览器允许脚本异步加载，下面就是两种异步加载的语法。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;path/to/myModule.js&quot;</span> <span class="attr">defer</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;path/to/myModule.js&quot;</span> <span class="attr">async</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>defer是“渲染完再执行”，async是“下载完就执行”。</p>
<h5 id="加载规则"><a href="#加载规则" class="headerlink" title="加载规则"></a>加载规则</h5><p>浏览器加载 ES6 模块，也使用&lt;script&gt;标签，但是要加入type&#x3D;”module”属性。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;foo.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ES6 模块也允许内嵌在网页中，语法行为与加载外部脚本完全一致。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> utils <span class="keyword">from</span> <span class="string">&quot;./utils.js&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// other code</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="24-编程风格"><a href="#24-编程风格" class="headerlink" title="24. 编程风格"></a>24. 编程风格</h1><h3 id="块级作用域"><a href="#块级作用域" class="headerlink" title="块级作用域"></a>块级作用域</h3><ol>
<li>let取代var</li>
<li>全局常量和线程安全<br> 在let和const之间，建议优先使用const，尤其是在全局环境，不应该设置变量，只应设置常量。</li>
</ol>
<h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><p>静态字符串一律使用单引号或反引号，不使用双引号。动态字符串使用反引号。</p>
<h3 id="解构赋值"><a href="#解构赋值" class="headerlink" title="解构赋值"></a>解构赋值</h3><ol>
<li>使用数组成员对变量赋值时，优先使用解构赋值。</li>
<li>函数的参数如果是对象的成员，优先使用解构赋值。</li>
</ol>
<h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><p>单行定义的对象，最后一个成员不以逗号结尾。多行定义的对象，最后一个成员以逗号结尾。</p>
<p>对象尽量静态化，一旦定义，就不得随意添加新的属性。如果添加属性不可避免，要使用<code>Object.assign</code>方法。</p>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>使用扩展运算符（…）拷贝数组。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> itemsCopy = [...items];</span><br></pre></td></tr></table></figure>

<p>使用Array.from方法，将类似数组的对象转为数组。</p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><ol>
<li>立即执行函数可以写成箭头函数的形式。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Welcome to the Internet.&#x27;</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></li>
<li>箭头函数取代Function.prototype.bind，不应再用self&#x2F;_this&#x2F;that绑定 this。</li>
<li>不要在函数体内使用arguments变量，使用rest运算符（…）代替。</li>
<li>使用默认值语法设置函数参数的默认值。</li>
</ol>
<h3 id="map结构"><a href="#map结构" class="headerlink" title="map结构"></a>map结构</h3><p>注意区分Object和Map，只有模拟现实世界的实体对象时，才使用Object。如果只是需要key: value的数据结构，使用Map结构。因为Map有内建的遍历机制。</p>
<h3 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h3><p>总是用Class，取代需要prototype的操作。因为Class的写法更简洁，更易于理解。</p>
<p>使用extends实现继承，因为这样更简单，不会有破坏instanceof运算的危险。</p>
<h3 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h3><p>首先，Module语法是JavaScript模块的标准写法，坚持使用这种写法。使用import取代require。</p>
<br>
<br>
<br>
<br>
<br>

<h1 id="输入法"><a href="#输入法" class="headerlink" title="输入法"></a>输入法</h1><p><img src="/Blog/Blog/2022/05/15/ES6%E5%85%A5%E9%97%A8/%E7%BB%B4%E6%96%87%E8%BE%93%E5%85%A5%E6%B3%95%E9%94%AE%E7%9B%98%E5%AF%B9%E5%BA%94%E5%9B%BE.jpg" alt="输入法"></p>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br></h6></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/Blog/page/2/">2</a><a class="extend next" rel="next" href="/Blog/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Alexander Ezharjan</p>
  <div class="site-description" itemprop="description">This blog is maintained by Alexander Ezharjan, in order to record some useful things in life.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/Blog/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/Blog/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alexander Ezharjan</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/Blog/lib/anime.min.js"></script>
  <script src="/Blog/lib/velocity/velocity.min.js"></script>
  <script src="/Blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/Blog/js/utils.js"></script>

<script src="/Blog/js/motion.js"></script>


<script src="/Blog/js/schemes/muse.js"></script>


<script src="/Blog/js/next-boot.js"></script>




  




  
<script src="/Blog/js/local-search.js"></script>













  

  

</body>
</html>
